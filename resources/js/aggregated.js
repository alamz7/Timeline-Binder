!function(){"use strict";console.log("Loading the MEAN Analytics module."),angular.module("mean.analytics",[])}();
!function(){"use strict";angular.module("mean.articles",["angularFileUpload","mean.analytics","blockUI","angularMoment","perfect_scrollbar","ngTagsInput","ngSanitize","ngFileUpload"])}();
!function(){"use strict";var systemModule=angular.module("mean.system",["mean-factory-interceptor","ui.router","perfect_scrollbar","ngTagsInput","ngSanitize"]);systemModule.config(["blockUIConfig","$locationProvider",function(blockUIConfig,$locationProvider){blockUIConfig.autoBlock=!1,$locationProvider.html5Mode(!0).hashPrefix("!")}]),systemModule.filter("parse_description",["$sce",function($sce){return function(data){return data?(data=data.replace(/</g,"&lt;"),data=data.replace(/>/g,"&gt;"),data=data.replace(/\n{3,}/g,"\n\n"),$sce.trustAsHtml(data.replace(/\n/g,"<br />"))):data}}]),systemModule.filter("nl2br",["$sanitize",function($sanitize){var tag=/xhtml/i.test(document.doctype)?"<br />":"<br>";return function(msg){return msg=(msg+"").replace(/\n{3,}/g,"\n\n"),msg=(msg+"").replace(/(\r\n|\n\r|\r|\n|&#10;&#13;|&#13;&#10;|&#10;|&#13;)/g,tag+"$1"),$sanitize(msg)}}]),systemModule.filter("newline_parser",["$sce",function($sce){return function(data){return data?(data=data.replace(/&#10;/g,"\n"),data=data.replace(/\n{3,}/g,"\n\n"),data=data.replace(/\n/g,"<br />")):data}}]),systemModule.run(["$rootScope","$state","$http",function($rootScope,$state,$http){var imageServer="https://images.nr8.com";switch(window.location.hostname){case"www.nr8.com":case"nr8.com":imageServer="https://images.nr8.com";break;case"dev.nr8.com":imageServer="https://devimage.nr8.com";break;case"localhost":imageServer="http://172.17.0.6:8080"}$rootScope.imageServer=imageServer,console.log("===>window.location.hostname",window.location.hostname),console.log("===>$rootScope.imageServer",$rootScope.imageServer),$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){isMobile.any&&void 0!==toState.allowMobile&&null!==toState.allowMobile&&!1===toState.allowMobile&&(event.preventDefault(),$state.go("articles_list"))}),$rootScope.$on("$stateChangeError",function(event,toState,toParams,fromState,fromParams,error){if(console.log("$stateChangeError",event,toState,toParams,fromState,fromParams,error),"article_view"===toState.name&&403===error.status&&!error.data.isDraft&&error.data.isPrivate){var context={articleId:toParams.articleId};return toParams.hasOwnProperty("passphrase")&&(context.passphrase=toParams.passphrase),$state.go("article_passphrase",context)}error&&400===error.status&&"article_view"===toState.name&&$state.go("error.notfound"),error&&401===error.status&&$state.go("auth.login",{gotoAfterLogin:{state:toState.name,params:toParams}}),error&&403===error.status&&$state.go("error.unauthorized"),error&&404===error.status&&$state.go("error.notfound")}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){console.log("$stateChangeSuccess",event,toState,toParams,fromState,fromParams);var content="app-id=1120419422, app-argument="+window.location.href;$("meta[name='apple-itunes-app']").attr("content",content),setTimeout(function(){window.prerenderReady=!0},2e3)})}])}();
!function(){"use strict";angular.module("mean.users",[])}();
!function(){"use strict";angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,["mean"])});var packageModules=[];for(var index in window.modules)angular.module(window.modules[index].module,window.modules[index].angularDependencies||[]),packageModules.push(window.modules[index].module);var modules=["ngCookies","ngResource","ui.bootstrap","ui.router","angularFileUpload","ngFileUpload","mean.analytics","blockUI","facebook","angularMoment"];modules=modules.concat(packageModules),angular.module("mean",modules).constant("angularMomentConfig",{preprocess:"utc",timezone:"America/Los_Angeles"})}();
!function(){"use strict";angular.module("mean.analytics").provider("$mixpanel",function(){function init(){if(!Object.prototype.hasOwnProperty.call(window,"mixpanel"))throw"Global `mixpanel` not available. Did you forget to include the library on the page?";mixpanel.init(apiKey),waitTillAsyncApiLoaded(function(){superProperties&&mixpanel.register(superProperties)})}function waitTillAsyncApiLoaded(callback){Object.prototype.hasOwnProperty.call(window,"mixpanel")&&void 0!==window.mixpanel.__loaded||setTimeout(function(){waitTillAsyncApiLoaded(callback)},500),callback()}function callMixpanelFn(name){return function(){var scope,i,fn=window.mixpanel,parts=name.split(".");for(i=0;i<parts.length;i++)scope=fn,fn=fn[parts[i]];return fn.apply(scope,arguments)}}var apiKey,superProperties;this.apiKey=function(key){if(!key)return apiKey;apiKey=key},this.superProperties=function(properties){if(!properties)return superProperties;superProperties=properties},this.$get=function(){return init(),{init:callMixpanelFn("init"),push:callMixpanelFn("push"),disable:callMixpanelFn("disable"),track:callMixpanelFn("track"),track_links:callMixpanelFn("track_links"),track_forms:callMixpanelFn("track_forms"),register:callMixpanelFn("register"),register_once:callMixpanelFn("register_once"),unregister:callMixpanelFn("unregister"),identify:callMixpanelFn("identify"),get_distinct_id:callMixpanelFn("get_distinct_id"),alias:callMixpanelFn("alias"),set_config:callMixpanelFn("set_config"),get_config:callMixpanelFn("get_config"),get_property:callMixpanelFn("get_property"),people:{set:callMixpanelFn("people.set"),set_once:callMixpanelFn("people.set_once"),increment:callMixpanelFn("people.increment"),append:callMixpanelFn("people.append"),track_charge:callMixpanelFn("people.track_charge"),clear_charges:callMixpanelFn("people.clear_charges"),delete_user:callMixpanelFn("people.delete_user")}}}})}();
!function(){"use strict";angular.module("mean.analytics").factory("$report",["$http","PLAYER_CONFIG",function($http,PLAYER_CONFIG){var userAgent=navigator.userAgent,strip_empty_properties=function(p){var ret={};return _.each(p,function(v,k){_.isString(v)&&v.length>0&&(ret[k]=v)}),ret},info={campaignParams:function(){var campaign_keywords="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),kw="",params={};return _.each(campaign_keywords,function(kwkey){kw=_.getQueryParam(document.URL,kwkey),kw.length&&(params[kwkey]=kw)}),params},searchEngine:function(referrer){return 0===referrer.search("https?://(.*)google.([^/?]*)")?"google":0===referrer.search("https?://(.*)bing.com")?"bing":0===referrer.search("https?://(.*)yahoo.com")?"yahoo":0===referrer.search("https?://(.*)duckduckgo.com")?"duckduckgo":null},searchInfo:function(referrer){var search=info.searchEngine(referrer),param="yahoo"!=search?"q":"p",ret={};if(null!==search){ret.$search_engine=search;var keyword=_.getQueryParam(referrer,param);keyword.length&&(ret.mp_keyword=keyword)}return ret},browser:function(user_agent,vendor,opera){return vendor=vendor||"",opera||_.include(user_agent," OPR/")?_.include(user_agent,"Mini")?"Opera Mini":"Opera":/(BlackBerry|PlayBook|BB10)/i.test(user_agent)?"BlackBerry":_.include(user_agent,"IEMobile")||_.include(user_agent,"WPDesktop")?"Internet Explorer Mobile":_.include(user_agent,"Edge")?"Microsoft Edge":_.include(user_agent,"FBIOS")?"Facebook Mobile":_.include(user_agent,"Chrome")?"Chrome":_.include(user_agent,"CriOS")?"Chrome iOS":_.include(user_agent,"FxiOS")?"Firefox iOS":_.include(vendor,"Apple")?_.include(user_agent,"Mobile")?"Mobile Safari":"Safari":_.include(user_agent,"Android")?"Android Mobile":_.include(user_agent,"Konqueror")?"Konqueror":_.include(user_agent,"Firefox")?"Firefox":_.include(user_agent,"MSIE")||_.include(user_agent,"Trident/")?"Internet Explorer":_.include(user_agent,"Gecko")?"Mozilla":""},browserVersion:function(userAgent,vendor,opera){var browser=info.browser(userAgent,vendor,opera),versionRegexs={"Internet Explorer Mobile":/rv:(\d+(\.\d+)?)/,"Microsoft Edge":/Edge\/(\d+(\.\d+)?)/,Chrome:/Chrome\/(\d+(\.\d+)?)/,"Chrome iOS":/CriOS\/(\d+(\.\d+)?)/,Safari:/Version\/(\d+(\.\d+)?)/,"Mobile Safari":/Version\/(\d+(\.\d+)?)/,Opera:/(Opera|OPR)\/(\d+(\.\d+)?)/,Firefox:/Firefox\/(\d+(\.\d+)?)/,"Firefox iOS":/FxiOS\/(\d+(\.\d+)?)/,Konqueror:/Konqueror:(\d+(\.\d+)?)/,BlackBerry:/BlackBerry (\d+(\.\d+)?)/,"Android Mobile":/android\s(\d+(\.\d+)?)/,"Internet Explorer":/(rv:|MSIE )(\d+(\.\d+)?)/,Mozilla:/rv:(\d+(\.\d+)?)/},regex=versionRegexs[browser];if(void 0===regex)return null;var matches=userAgent.match(regex);return matches?parseFloat(matches[matches.length-2]):null},os:function(){var a=userAgent;return/Windows/i.test(a)?/Phone/.test(a)||/WPDesktop/.test(a)?"Windows Phone":"Windows":/(iPhone|iPad|iPod)/.test(a)?"iOS":/Android/.test(a)?"Android":/(BlackBerry|PlayBook|BB10)/i.test(a)?"BlackBerry":/Mac/i.test(a)?"Mac OS X":/Linux/.test(a)?"Linux":""},device:function(user_agent){return/Windows Phone/i.test(user_agent)||/WPDesktop/.test(user_agent)?"Windows Phone":/iPad/.test(user_agent)?"iPad":/iPod/.test(user_agent)?"iPod Touch":/iPhone/.test(user_agent)?"iPhone":/(BlackBerry|PlayBook|BB10)/i.test(user_agent)?"BlackBerry":/Android/.test(user_agent)?"Android":""},referringDomain:function(referrer){var split=referrer.split("/");return split.length>=3?split[2]:""},properties:function(){return _.extend(strip_empty_properties({$os:info.os(),$browser:info.browser(userAgent,navigator.vendor,window.opera),$referrer:document.referrer,$referring_domain:info.referringDomain(document.referrer),$device:info.device(userAgent)}),{$current_url:window.location.href,$browser_version:info.browserVersion(userAgent,navigator.vendor,window.opera),$screen_height:screen.height,$screen_width:screen.width,mp_lib:"web",$lib_version:"2.9.16"})},people_properties:function(){return _.extend(strip_empty_properties({$os:info.os(),$browser:info.browser(userAgent,navigator.vendor,window.opera)}),{$browser_version:info.browserVersion(userAgent,navigator.vendor,window.opera)})},pageviewInfo:function(page){return strip_empty_properties({mp_page:page,mp_referrer:document.referrer,mp_browser:info.browser(userAgent,navigator.vendor,window.opera),mp_platform:info.os()})}};return function(eventType,event){var payload=_.merge({mixpanel:info.properties(),isIOSapp:PLAYER_CONFIG.isIOSApp()},event);$http.post("/api/events/playtime",payload).then(function(){console.log("Updated successfully...",event)},function(response){console.log("Error updating playtime: ",response.status,response.data)})}}])}();
!function(){"use strict";var jquery_supported=["zoomIn-jquery","slideInDown-jquery","fadeIn-jquery","zoomOut-jquery","slideOutUp-jquery","fadeOut-jquery"],css_supported=["bounceIn","bounceInDown","bounceInLeft","bounceInRight","bounceInUp","fadeIn","fadeInDown","fadeInDownBig","fadeInLeft","fadeInLeftBig","fadeInRight","fadeInRightBig","fadeInUp","fadeInUpBig","rotateIn","rotateInDownLeft","rotateInDownRight","rotateInUpLeft","rotateInUpRight","slideInUp","slideInDown","slideInLeft","slideInRight","zoomIn","zoomInDown","zoomInLeft","zoomInRight","zoomInUp","lightSpeedIn","rollIn","flipInX","flipInY","bounceOut","bounceOutDown","bounceOutLeft","bounceOutRight","bounceOutUp","fadeOut","fadeOutDown","fadeOutDownBig","fadeOutLeft","fadeOutLeftBig","fadeOutRight","fadeOutRightBig","fadeOutUp","fadeOutUpBig","rotateOut","rotateOutDownLeft","rotateOutDownRight","rotateOutUpLeft","rotateOutUpRight","slideOutUp","slideOutDown","slideOutLeft","slideOutRight","zoomOut","zoomOutDown","zoomOutLeft","zoomOutRight","zoomOutUp","lightSpeedOut","rollOut","flipOutX","flipOutY","bounce","flash","pulse","rubberBand","shake","swing","tada","wobble","jello","flip","hinge"],animFn=function(animation,isIn){return animation&&animation.hasOwnProperty("id")&&"none"!==animation.id?jquery_supported.indexOf(animation.id)>-1?function(elem,options,callback){var o=_.cloneDeep(options);switch(o.done=callback,animation.id){case"zoomIn-jquery":angular.element(elem).show(o);break;case"slideInDown-jquery":angular.element(elem).slideDown(o);break;case"fadeIn-jquery":angular.element(elem).fadeIn(o);break;case"zoomOut-jquery":angular.element(elem).hide(o);break;case"slideOutUp-jquery":angular.element(elem).slideUp(o);break;case"fadeOut-jquery":angular.element(elem).fadeOut(o)}}:css_supported.indexOf(animation.id)>-1?function(elem,options,callback){var img=angular.element(elem);isIn&&img.show(),img.css("-webkit-animation-duration",options.duration+"ms"),img.css("-moz-animation-duration",options.duration+"ms"),img.css("-o-animation-duration",options.duration+"ms"),img.css("animation-duration",options.duration+"ms"),img.toggleClass("animated "+animation.id),setTimeout(function(){img.removeClass("animated "+animation.id),callback&&callback()},options.duration)}:null:null};angular.module("mean.articles").constant("YT_ANIMATION_CONFIG",{getAnimationFn:animFn,in:[{name:"None",id:"none",options:{duration:0}},{name:"Fade in",id:"fadeIn",options:{duration:800}}],inNoneIndex:0,inDefaultIndex:0,out:[{name:"None",id:"none",options:{duration:0}},{name:"Fade out",id:"fadeOut",options:{duration:800}}],outNoneIndex:0,outDefaultIndex:0}).constant("IMAGE_ANIMATION_CONFIG",{getAnimationFn:animFn,in:[{name:"None",id:"none",options:{duration:0}},{name:"Fade in",id:"fadeIn",options:{duration:800}}],inNoneIndex:0,inDefaultIndex:0,out:[{name:"None",id:"none",options:{duration:0}},{name:"Fade out",id:"fadeOut",options:{duration:800}}],outNoneIndex:0,outDefaultIndex:0}).constant("TEXT_ANIMATION_CONFIG",{getAnimationFn:animFn,in:[{name:"None",id:"none",options:{duration:0}},{name:"Fade in",id:"fadeIn",options:{duration:800}}],inNoneIndex:0,inDefaultIndex:0,out:[{name:"None",id:"none",options:{duration:0}},{name:"Fade out",id:"fadeOut",options:{duration:800}}],outNoneIndex:0,outDefaultIndex:0})}();
!function(){"use strict";angular.module("mean.articles").constant("YT_AUDIOTRANSITION_CONFIG",{step:100,in:[{name:"None",id:"none",options:{duration:0}},{name:"Fade in",id:"fadeInShort",options:{duration:900}}],inNoneIndex:0,inDefaultIndex:1,out:[{name:"None",id:"none",options:{duration:0}},{name:"Fade out",id:"fadeOutShort",options:{duration:900}}],outNoneIndex:0,outDefaultIndex:1})}();
!function(){"use strict";var editingSupported=!0,searchSnippetPreviewSupported=!0,iOSAppFullScreen=!1,numberOfPlayers=2,iOSApp=!1,iOS10=!1,setPlayerConfig=function(){/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&(iOSApp=!0,iOS10=!0,iOSAppFullScreen=!0),isMobile.any&&(editingSupported=!1),isMobile.android.device&&(searchSnippetPreviewSupported=!1),numberOfPlayers=(isMobile.any,2)},isPlayingSupported=function(){return!0},isEditingSupported=function(){return editingSupported},isSearchSnippetPreviewSupported=function(){return searchSnippetPreviewSupported},isIOSAppFullScreen=function(){return iOSAppFullScreen},getNumberOfPlayers=function(){return numberOfPlayers},isAndroid=function(){return isMobile.android.device},isIOS10=function(){return iOS10},isIOSApp=function(){return iOSApp};angular.module("mean.articles").constant("PLAYER_CONFIG",{setPlayerConfig:setPlayerConfig,isPlayingSupported:isPlayingSupported,isEditingSupported:isEditingSupported,isSearchSnippetPreviewSupported:isSearchSnippetPreviewSupported,getIOSAppFullScreen:isIOSAppFullScreen,getNumberOfPlayers:getNumberOfPlayers,isAndroid:isAndroid,isIOS10:isIOS10,isIOSApp:isIOSApp})}();
!function(){"use strict";angular.module("mean.articles").controller("CreateController",["$rootScope","$scope","$http","$upload","Upload","$modal","$uuid","Articles","article","Nr8Composer","cropImageService","$location","$timeout","$filter","$state","Global","$history","blockUI","YoutubeMetadata","$mixpanel","Facebook","siteConfig","MetaTagService","challenges","howtoArticle","audioFiles",function($rootScope,$scope,$http,$upload,Upload,$modal,$uuid,Articles,article,Nr8Composer,cropImageService,$location,$timeout,$filter,$state,Global,$history,blockUI,YoutubeMetadata,$mixpanel,Facebook,siteConfig,MetaTagService,challenges,howtoArticle,audioFiles){function setHeader(title,visibility,challenges){var vis=visibility;"Pre-suspension"===visibility||"Suspension"===visibility?vis="Suspended":"Post-suspension"===visibility?vis="Under Review":"Public"===visibility&&(vis="Published"),$rootScope.$emit("showCreateHeader",{title:article.title,visibility:vis,challenges:$scope.article.challenges})}function initCoverImageControls(){$scope.images=Nr8Composer.retrieveImages(_.cloneDeep($scope.article.actions.states),!1,!0),$scope.customCoverImage=Nr8Composer.retrieveCustomCoverImage(_.cloneDeep($scope.article.actions.states)),$scope.coverImageIndexForSlickInitialization=-1,$scope.article.actions.states.length>0&&-1===$scope.article.actions.states[0].seg&&($scope.customCoverImage&&$scope.customCoverImage.id===$scope.article.actions.states[0].lp.image.id?$scope.selectedImage=$scope.customCoverImage:$scope.images.length>0&&$scope.images.forEach(function(image,i){if(image.id===$scope.article.actions.states[0].lp.image.id)return $scope.selectedImage=image,void($scope.coverImageIndexForSlickInitialization=i)}))}function save(exit){$scope.usetextarea?$scope.article.actions=JSON.parse($scope.actionsJson):($scope.article.actions=$scope.master,$scope.article.image=$scope.selectedImage,$scope.article.playTime=$scope.master.states[$scope.master.states.length-1].mte),$scope.article.isEmpty=Nr8Composer.isEmpty($scope.article),$scope.updateCoverImage(),visibilityControlEnablement(),"Public"!==$scope.visibility&&"Private"!==$scope.visibility||"Enabled"===$scope.PublicVisibilityState?"Pre-suspension"!==$scope.visibility&&"Suspension"!==$scope.visibility&&"Post-suspension"!==$scope.visibility||($scope.article.hasOwnProperty("suspension")&&($scope.article.suspension.unsubmittedModifications=!0),$scope.setNotification("When you are done with changes, please submit for review by clicking on the button below.",!0)):($scope.setNotification("Setting the narrative to Draft mode as this can no longer remain LIVE.",!0),$scope.updateVisibility("Draft")),$rootScope.$emit("showSavingOnCreateHeader"),new Articles($scope.article).$update(function(response){exit?$location.path("articles/"+response._id):console.log("Replace this log message with a soft toast. Also what aboout content and title ? ########## ")},function(err){console.error("Oops!")})}function updateCoverPopover(){$scope.selectedImage.id===placeholderId?$scope.coverPopoverTitle="To select a cover image \n":$scope.coverPopoverTitle="To change the cover image \n",$scope.bullet1_text1=!1,$scope.bullet1_text2=!1,$scope.bullet1_text3=!1,$scope.bullet1_text4=!1,$scope.bullet2_text="",$scope.images.length?1===$scope.images.length&&$scope.images[0]===$scope.selectedImage?$scope.bullet1_text3=!0:$scope.bullet1_text4=!0:$scope.customCoverImage?$scope.bullet1_text2=!0:$scope.bullet1_text1=!0,$scope.customCoverImage?$scope.customCoverImage===$scope.selectedImage?$scope.bullet2_text="change custom cover image":$scope.bullet2_text="click on custom cover image preview":$scope.bullet2_text="upload a custom cover image"}function refactor(segmentsClone){segmentsClone.forEach(function(segment,i){segment.states.forEach(function(state){state.seg=i})}),$scope.master=Nr8Composer.composeMaster($scope.selectedImage,$scope.customCoverImage,segmentsClone),$scope.segments=Nr8Composer.retrieveSegments(_.cloneDeep($scope.master.states)),$scope.segmentsData=Nr8Composer.retrieveSegmentsData(_.cloneDeep($scope.segments))}function addSegment(segmentId,newSegment){$scope.minimizeAllSegments();var segmentsClone=_.cloneDeep($scope.segments);segmentsClone.splice(segmentId,0,newSegment),$scope.minimizeStates.splice(segmentId,0,!1),refactor(segmentsClone),save(!1)}function isMissingContentSegmentDeleted(){Nr8Composer.isContentMissing($scope.segments)||($scope.showErrorInfo=!1,$scope.updateVisibility("Draft"),$scope.sendEmailYTContentNA_Rectified(),$modal.open({templateUrl:"system/views/errors/modal-content-no-longer-missing.html",controller:"okCtrl",size:"md",resolve:{title:function(){return null},message:function(){return null}}}))}var imageServer=$rootScope.imageServer&&""!=$rootScope.imageServer?$rootScope.imageServer:"https://images.nr8.com";console.log("===>CreateController:imageServer",$rootScope.imageServer),$scope.features=siteConfig.featureFlags,$scope.openChallenges=challenges,$scope.article=article,$scope.howtoArticle=howtoArticle,$scope.global=Global,$scope.audioFiles=_.map(audioFiles,function(f){return f.file=["","api","audio",article._id,"file",encodeURIComponent(f.file)].join("/"),f}),$scope.tracksUploading=[],$scope.trackName="",$scope.location=$location;$scope.analyticsContext={pageId:$uuid(),narrativeId:article._id,narrativeTitle:article.title,narrativeChallenges:_.map(article.challenges,function(c){return c.key}),authorName:article.user?article.user.username:"",visibility:article.visibility,pageName:"Create",userId:Global.user&&Global.user._id?Global.user._id:"000000000000000000000000"},$scope.isMobileAny=isMobile.any,$scope.filterChallenges=function($query){return $filter("filter")(challenges,{title:$query})},$mixpanel.track("Create",{narrative_id:article._id,author_name:article.user.username,user_id:Global.user?Global.user._id:"<anonymous>"});var checkTabState=function(){$state.is("article_edit.create")?$scope.currentTab="Create":$state.is("article_edit.describe")?$scope.currentTab="Describe":$state.is("article_edit.preview")?$scope.currentTab="Preview":$state.is("article_edit.status")&&($scope.currentTab="Status")};checkTabState(),$rootScope.$on("$stateChangeSuccess",checkTabState),MetaTagService.setMetaTags({title:"Create a narrative",description:"A Whole New Way Of Expression",author:"",keywords:""}).setTitle("Create a narrative - NR8"),$scope.removeTrack=function(audio){$http({url:audio.path,method:"DELETE"}).then(function(){$http.get("/api/audio/"+article._id).then(function(response){$scope.audioFiles=_.map(response.data,function(f){return f.file=["","api","audio",article._id,"file",encodeURIComponent(f.file)].join("/"),f}),$scope.trackName=""},function(error){console.log("Error : ",error)})}).catch(function(error){console.error(error)})},$scope.showCreateStartHelper=function(article){if(!$scope.isMobileAny){$modal.open({templateUrl:"system/views/modal-create-start.html",controller:"ModalHelpCreateSegments",size:"md",backdrop:"static",resolve:{title:function(){return"Create your narrative"},article:function(){return article},howtoArticle:function(){return howtoArticle},analyticsContext:function(){return $scope.analyticsContext}}})}},$scope.maxedSegmentLimit=function(segmentType){if(-1!==["text","image","video"].indexOf(segmentType)){$modal.open({templateUrl:"system/views/modal-maxed-seg-limit-"+segmentType+".html",controller:"okCancelCtrl",size:"md",backdrop:"static",resolve:{title:function(){return"We love your enthusiasm!"},message:function(){return null}}})}},$scope.handleSecretButton=function(secret){if(void 0!==secret&&null!==secret&&""!==secret&&-1!==secret.indexOf("5678:")){var key=secret.replace("5678:","");if("Draft"===key)$scope.updateVisibility("Draft");else if("Public"===key)$scope.updateVisibility("Public");else if("Private"===key)$scope.updateVisibility("Private");else if("Pre-suspension"===key)$scope.updateVisibility("Pre-suspension");else if("Suspension"===key)$scope.updateVisibility("Suspension");else if("Post-suspension"===key)$scope.updateVisibility("Post-suspension");else if(11===key.length){for(var foundAVideoSegment=!1,i=0;i<$scope.segments.length;i++)foundAVideoSegment||"video"!==$scope.segments[i].states[0].lp.type||($scope.segments[i].states.forEach(function(state,j){state.lp.videoId=key}),foundAVideoSegment=!0);$scope.master=Nr8Composer.composeMaster($scope.selectedImage,$scope.customCoverImage,$scope.segments),save(!1)}}},YoutubeMetadata.attach($scope),$scope.notification=null,$scope.notificationType=null;var notificationTimer=null;$scope.visibility=article.visibility,setHeader(article.title,$scope.visibility);var placeholderId="articles/78920ccc23a22de377a2a1dffdfe0842be5ef378",placeholderImage=Nr8Composer.newImageObject("is",placeholderId),articleId=article._id;$scope.selectedImage=placeholderImage,$scope.passphrase=$scope.article.passphrase,$scope.Nr8ShareLink="nr8.com/narratives/"+article._id,$scope.privateNr8SharePassphrase=$scope.passphrase,$scope.urlCopied=!1,-1===$scope.article.title.indexOf("Untitled narrative")?$scope.title=$scope.article.title:$scope.title="",$scope.content=$scope.article.content,$scope.tags=$scope.article.tags.map(function(item){return{text:item}}),$scope.challenges=_.cloneDeep($scope.article.challenges),$scope.disableTitleUpdate=!0,$scope.disableContentUpdate=!0,$scope.updateCoverImage=function(){$scope.selectedImage.id===placeholderId&&($scope.images=Nr8Composer.retrieveImages(_.cloneDeep($scope.article.actions.states),!1,!0),$scope.customCoverImage=Nr8Composer.retrieveCustomCoverImage(_.cloneDeep($scope.article.actions.states)),$scope.images.length>0?$scope.changeSelectedCover($scope.images[0]):$scope.customCoverImage&&$scope.changeSelectedCover($scope.customCoverImage))},$scope.shareOnReddit=function(){siteConfig.featureFlags.facebookShare&&($mixpanel.track("Share",{share_on:"Reddit",narrative_id:article._id}),function(pageURL,title,w,h){var left=screen.width/2-w/2,top=screen.height/2-h/2;window.open(pageURL,title,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+w+", height="+h+", top="+top+", left="+left)}("http://www.reddit.com/submit?url="+encodeURIComponent($scope.Nr8ShareLink)+"&title="+encodeURIComponent($scope.article.title),"redditWindow",900,700))},$scope.shareOnFacebook=function(){siteConfig.featureFlags.facebookShare&&(console.log("shareOnFacebook"),console.log(article),Facebook.ui({method:"share",href:$scope.Nr8ShareLink},function(response){response&&angular.isDefined(response.error_code)&&(console.log("error sharing on facebook"),console.log(response))}))},$scope.shareOnTwitter=function(){siteConfig.featureFlags.facebookShare&&$mixpanel.track("Share",{share_on:"Twitter",narrative_id:article._id})},$scope.actionsJson=JSON.stringify($scope.article.actions);var visibilityControlEnablement=function(){$scope.hasSegment=!0,$scope.hasTitle=!0,$scope.hasDescription=!0,$scope.hasCover=!0,$scope.isPublishable=Nr8Composer.isPublishable($scope.article,placeholderId),"true"===$scope.isPublishable?($scope.disablePublicVisibility=!1,$scope.PublicVisibilityState="Enabled",void 0!==$scope.passphrase&&$scope.passphrase.length>=4&&$scope.passphrase.length<=12?($scope.disablePrivateVisibility=!1,$scope.PrivateVisibilityState="Enabled",$scope.passphraseValid=!0):($scope.disablePrivateVisibility=!0,$scope.PrivateVisibilityState="Passphrase must be between 4-10 characters.",$scope.passphraseValid=!1)):($scope.disablePrivateVisibility=!0,$scope.disablePublicVisibility=!0,$scope.PrivateVisibilityState="Please see the list on the left for required actions.",$scope.PublicVisibilityState="Please see the list on the left for required actions.",-1!==$scope.isPublishable.indexOf("segment")&&($scope.hasSegment=!1),-1!==$scope.isPublishable.indexOf("title")&&($scope.hasTitle=!1),-1!==$scope.isPublishable.indexOf("description")&&($scope.hasDescription=!1),-1!==$scope.isPublishable.indexOf("cover")&&($scope.hasCover=!1)),"Pre-suspension"===$scope.visibility||"Suspension"===$scope.visibility||"Post-suspension"===$scope.visibility||"YTContentNA"===$scope.visibility?($scope.disablePrivateVisibility=!0,$scope.disablePublicVisibility=!0,$scope.PrivateVisibilityState="This narrative cannot be made LIVE until suspension has been lifted.",$scope.PublicVisibilityState="This narrative cannot be made LIVE until suspension has been lifted."):"YTContentNA"===$scope.visibility&&($scope.disablePrivateVisibility=!0,$scope.disablePublicVisibility=!0,$scope.PrivateVisibilityState="This narrative cannot be made LIVE until the video segment with the missing YouTube content is deleted.",$scope.PublicVisibilityState="This narrative cannot be made LIVE until the video segment with the missing YouTube content is deleted.")};$scope.submitForReview=function(){$scope.updateVisibility("Post-suspension"),$scope.article.suspension.unsubmittedModifications=!1;$modal.open({templateUrl:"system/views/errors/modal-submit-for-review.html",controller:"okCancelCtrl",size:"md",resolve:{title:function(){return""},message:function(){return""}}})},$scope.minimizeAllSegments=function(){$scope.segments.forEach(function(segment,i){$scope.minimizeStates[i]=!0})},$scope.minHeight=window.innerHeight-95+"px",initCoverImageControls(),$scope.segments=Nr8Composer.retrieveSegments(_.cloneDeep($scope.article.actions.states)),$scope.segmentsData=Nr8Composer.retrieveSegmentsData(_.cloneDeep($scope.segments)),0===$scope.article.actions.states.length?($scope.master=Nr8Composer.addCoverImage(placeholderImage,{states:[]}),save(!1)):$scope.master=$scope.article.actions,visibilityControlEnablement(),updateCoverPopover(),$scope.minimizeStates=[],$scope.minimizeAllSegments(),$scope.article.isEmpty&&!$scope.global.authenticated&&"Create"===$scope.currentTab&&$scope.showCreateStartHelper(),$scope.goToCreate=function(){"Create"!==$scope.currentTab&&($scope.currentTab="Create",$state.go("article_edit.create",{articleId:$scope.article._id,article:$scope.article}))},$scope.goToDescribe=function(element){"Describe"!==$scope.currentTab&&($scope.currentTab="Describe",initCoverImageControls(),updateCoverPopover(),element?$state.go("article_edit.describe",{focusOn:element,articleId:$scope.article._id,article:$scope.article}):$state.go("article_edit.describe",{articleId:$scope.article._id,article:$scope.article}))},$scope.goToPreview=function(){"Preview"!==$scope.currentTab&&($scope.currentTab="Preview",$state.go("article_edit.preview",{articleId:$scope.article._id,article:$scope.article}))},$scope.goToStatus=function(){"Status"!==$scope.currentTab&&($scope.currentTab="Status",$state.go("article_edit.status",{articleId:$scope.article._id,article:$scope.article}))},$scope.hideNotification=function(){$scope.notification=null},$scope.shareOnEmail=function(article){if(siteConfig.featureFlags.facebookShare){$mixpanel.track("Share",{share_on:"Email",narrative_id:article._id});$modal.open({templateUrl:"system/views/modal-email.html",controller:"sendEmailCtrl",size:"lg",backdrop:"static",resolve:{title:function(){return"Share via email"},toEmail:function(){return null},message:function(){return null},article:function(){return article}}})}},$scope.setNotification=function(message,replace,type){(!$scope.notification||$scope.notification&&replace)&&($scope.notification=message,$scope.notificationType="success",type&&($scope.notificationType=type),$timeout.cancel(notificationTimer),notificationTimer=$timeout(function(){$scope.notification=null},5e3))},$scope.titleFieldChange=function(title){$scope.disableTitleUpdate=!1},$scope.updateTitle=function(title){if(""===title||void 0===title){var date=$scope.article.created;date=$filter("date")(date,"MM/dd/yy HH:mm"),$scope.article.title="Untitled narrative - "+date,$scope.title=""}else $scope.article.title=$scope.title=title;save(!1),$scope.disableTitleUpdate=!0,setHeader(article.title,$scope.visibility)},$scope.contentFieldChange=function(content){""===content||void 0===content||content===$scope.article.content?$scope.disableContentUpdate=!0:$scope.disableContentUpdate=!1},$scope.updateContent=function(content){$scope.article.content=$scope.content=content,save(!1),$scope.disableContentUpdate=!0},$scope.updateTags=function(tags){$scope.article.tags=tags.map(function(item){return item.text}),save(!1)},$scope.passphraseFieldChange=function(passphrase){$scope.passphrase=passphrase,$scope.passphraseChanged=!0,"Private"===$scope.visibility?void 0!==$scope.passphrase&&$scope.passphrase.length>=4&&$scope.passphrase.length<=10?$scope.passphraseValid=!0:$scope.passphraseValid=!1:visibilityControlEnablement()},$scope.passphraseUpdate=function(passphrase){$scope.passphrase=passphrase,article.passphrase=$scope.passphrase,$scope.passphraseChanged=!1,save(!1),$scope.privateNr8SharePassphrase=$scope.passphrase},$scope.draftFieldChange=function(){console.log("draft field changed."),$scope.updateVisibility("Draft"),$scope.setNotification("Your narrative is now in draft mode",!0)},$scope.privateFieldChange=function(){console.log("private field changed."),$scope.passphraseChanged=!1,article.passphrase=$scope.passphrase,$scope.privateNr8SharePassphrase=$scope.passphrase,$scope.updateVisibility("Private"),$scope.setNotification("Setting your narrative as Private",!0)},$scope.publicFieldChange=function(){console.log("public field changed."),$scope.updateVisibility("Public"),$scope.setNotification("Your narrative is now published",!0),$mixpanel.track("NarrativeEvent",{event_name:"Published",narrative_id:article._id,narrative_title:article.title,visibility:article.visibility,author_name:article.user.username,user_id:Global.user?Global.user._id:"<anonymous>",narrative_challenges:article.challenges.map(function(obj){return obj.key})})},$scope.updateVisibility=function(visibility){$scope.visibility=visibility,article.visibility=visibility,save(!1),setHeader(article.title,$scope.visibility)},$scope.allChallenges=challenges,$scope.addChallenge=function(challenge_key){if("object"!=typeof _.groupBy($scope.challenges,function(item){return item.key})[challenge_key]){var challenge=_.find($scope.allChallenges,function(o){return o.key===challenge_key});challenge&&($scope.challenges.push(challenge),$scope.updateChallenges($scope.challenges))}},$scope.removeChallenge=function(challenge_key){$scope.challenges=_.filter($scope.challenges,function(item){return item.key!==challenge_key}),$scope.updateChallenges($scope.challenges)},$scope.updateChallenges=function(challenges){$scope.article.challenges=_.cloneDeep(challenges),save(!1),setHeader(article.title,$scope.visibility)},$scope.changeSelectedCover=function(image){$scope.selectedImage!==image&&($scope.selectedImage=image,$scope.selectedImage===$scope.customCoverImage&&$scope.$broadcast("deselectThumnails"),$scope.master=Nr8Composer.addCoverImage($scope.selectedImage,_.cloneDeep($scope.master)),save(!1),updateCoverPopover())},$scope.uploadCustomCoverImage=function(files){var file=files[0];console.log("Entered uploadCustomCoverImage"),console.log("Uploading the custom cover image : ",file),void 0!==file&&(blockUI.start(),$scope.upload=$upload.upload({url:imageServer+"/upload/articles/"+articleId+"%2f"+file.name,method:"POST",transformRequest:function(data,headersGetter){return delete headersGetter().Authorization,data},file:file}).success(function(data){blockUI.stop(),cropImageService.cropImage(data.modalUrl,data.key,data.info,"16:9",function(id){var image=Nr8Composer.newImageObject("is",id);$scope.customCoverImage=image,$scope.master=Nr8Composer.addCustomCoverImage($scope.customCoverImage,_.cloneDeep($scope.master)),save(!1),updateCoverPopover(),$scope.changeSelectedCover($scope.customCoverImage)})}).error(function(data,status){blockUI.stop(),console.log("status : ",status)}))},$scope.$watch("trackName",function($e){console.log("TRACKNAME CHANGED",arguments)}),$scope.uploadAudioFile=function(files){var file=files[0];console.log("Entered uploadAudioFile",$scope.trackName),console.log("Uploading the custom audio : ",file),void 0!==file&&$http({url:"/api/audio/"+article._id,method:"POST",data:{name:file.name,mimetype:file.type,track:$scope.trackName}}).then(function(response){console.log("Got audio response",response);var track={name:$scope.trackName,progress:0};$scope.tracksUploading.push(track),Upload.http({url:response.data.url,method:"PUT",headers:{"Content-Type":response.data.mimetype},data:file}).then(function(resp){$scope.tracksUploading=_.without($scope.tracksUploading,track),$http.get("/api/audio/"+article._id).then(function(response){$scope.audioFiles=_.map(response.data,function(f){return f.file=["","api","audio",article._id,"file",encodeURIComponent(f.file)].join("/"),f}),$scope.trackName="",blockUI.stop()},function(error){console.log("Error : ",error),blockUI.stop()})},function(resp){blockUI.stop(),console.log("status : ",status)},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);track.progress=progressPercentage,console.log("progress: "+progressPercentage+"% "+evt.config.data.file.name)})},function(response){console.log("Error getting response!")}).finally(function(){})},$scope.addTextSegment=function(segmentId){if($scope.segmentsData.textSegmentsCount>=100)return void $scope.maxedSegmentLimit("text");addSegment(segmentId,Nr8Composer.composeTextSegment(segmentId,"",null,0))},$scope.addImageSegment=function(segmentId){if($scope.segmentsData.imageSegmentsCount>=25)return void $scope.maxedSegmentLimit("image");addSegment(segmentId,Nr8Composer.composeImageSegment(segmentId,null,0)),console.log("Adding an image segment.")},$scope.addVideoSegment=function(segmentId){if($scope.segmentsData.videoSegmentsCount>=8)return void $scope.maxedSegmentLimit("video");addSegment(segmentId,Nr8Composer.composeVideoSegment(segmentId,"",0,0))},$scope.moveSegment=function(oldPosition,newPosition){var minimizedSegmentHeight=146;if($scope.minimizeAllSegments(),"string"==typeof newPosition&&(newPosition=parseInt(newPosition)),oldPosition!==newPosition){newPosition>$scope.segments.length&&(newPosition=$scope.segments.length);var segmentsClone=_.cloneDeep($scope.segments),segment=_.cloneDeep(segmentsClone[oldPosition]);oldPosition<newPosition?(segmentsClone.splice(newPosition+1,0,segment),$scope.minimizeStates.splice(newPosition+1,0,$scope.minimizeStates[oldPosition]),segmentsClone.splice(oldPosition,1),$scope.minimizeStates.splice(oldPosition,1)):oldPosition>newPosition&&(segmentsClone.splice(newPosition,0,segment),$scope.minimizeStates.splice(newPosition,0,$scope.minimizeStates[oldPosition]),segmentsClone.splice(oldPosition+1,1),$scope.minimizeStates.splice(oldPosition+1,1),minimizedSegmentHeight=-minimizedSegmentHeight),refactor(segmentsClone),save(!1),angular.element("body").animate({scrollTop:angular.element(window).scrollTop()+minimizedSegmentHeight},0)}},$scope.sendEmailYTContentNA_Rectified=function(){$http({url:"/sendmail/"+article._id,method:"POST",data:{emailFor:"ytcontentna-rectified",article:$scope.article}}).then(function(response){console.log("Mail has been sent !")},function(response){console.log("Error on sending mail !")}).finally(function(){})},$scope.deleteSegment=function(segmentPosition){var coverAffectedBySegmentDeletion=!1;$scope.selectedImage.id!==placeholderId&&(coverAffectedBySegmentDeletion=Nr8Composer.isCoverAffectedBySegmentDeletion($scope.selectedImage,_.cloneDeep($scope.segments),segmentPosition)),$modal.open({templateUrl:"system/views/okCancel.html",controller:"okCancelCtrl",size:"md",resolve:{title:function(){return"Are you sure you want to delete this segment?"},message:function(){return coverAffectedBySegmentDeletion?"Current cover image will also be deleted since it came from this segment.":null}}}).result.then(function(){$scope.minimizeAllSegments();var segmentsClone=_.cloneDeep($scope.segments);segmentsClone.splice(segmentPosition,1),$scope.minimizeStates.splice(segmentPosition,1),refactor(segmentsClone),save(!1),coverAffectedBySegmentDeletion&&($scope.selectedImage=placeholderImage,$scope.master=Nr8Composer.addCoverImage(placeholderImage,_.cloneDeep($scope.master)),save(!1)),"YTContentNA"===$scope.visibility&&isMissingContentSegmentDeleted(),$scope.setNotification("Segment deleted",!1)},function(){console.log("Modal dismissed at : "+new Date)})},$scope.deleteVideoSegmentNoModal=function(segmentPosition,addNewSegment){var coverAffectedBySegmentDeletion=!1;$scope.selectedImage.id!==placeholderId&&(coverAffectedBySegmentDeletion=Nr8Composer.isCoverAffectedBySegmentDeletion($scope.selectedImage,_.cloneDeep($scope.segments),segmentPosition));var segmentsClone=_.cloneDeep($scope.segments);segmentsClone.splice(segmentPosition,1),$scope.minimizeStates.splice(segmentPosition,1),refactor(segmentsClone),save(!1),coverAffectedBySegmentDeletion&&($scope.selectedImage=placeholderImage,$scope.master=Nr8Composer.addCoverImage(placeholderImage,_.cloneDeep($scope.master)),save(!1)),"YTContentNA"===$scope.visibility&&isMissingContentSegmentDeleted(),addNewSegment&&$scope.addVideoSegment(segmentPosition)},$scope.toggleSegment=function(segmentId){$scope.disableHasFocus=!1,$scope.minimizeStates[segmentId]=!$scope.minimizeStates[segmentId]},$scope.expandAllSegments=function(){$scope.disableHasFocus=!0,$scope.segments.forEach(function(segment,i){$scope.minimizeStates[i]=!1})},$scope.viewnr8=function(article){$state.go("article_view",{articleId:article._id})},$scope.exit=function(article){$history.goToLastListState()},$scope.remove=function(article){$modal.open({templateUrl:"system/views/okCancel.html",controller:"okCancelCtrl",size:"md",resolve:{title:function(){return"Are you sure you want to delete this narrative?"},message:function(){return"Once you delete this narrative, itâ€™s gone forever."}}}).result.then(function(){var username=article.user.username;article.$remove(function(){$mixpanel.track("NarrativeEvent",{event_name:"Deleted",narrative_id:article._id,narrative_title:article.title,visibility:article.visibility,author_name:article.user.username,user_id:Global.user?Global.user._id:"<anonymous>",narrative_challenges:article.challenges.map(function(obj){return obj.key})}),$location.path("@"+username)})},function(){console.log("Modal dismissed at : "+new Date)})},0===$scope.segments.length&&$timeout(function(){$scope.addVideoSegment(0)},500),$rootScope.$on("goToStatus",function(){$scope.goToStatus()}),$rootScope.$on("goToDescribe",function(event,fieldName){$scope.goToDescribe(fieldName)}),$scope.$on("segmentUpdated",function(e,event){if(event.segmentDurationChange){var delta=event.updatedNr8.states[event.updatedNr8.states.length-1].mte-$scope.segments[event.segmentId].meta.duration;$scope.segments[event.segmentId].meta.duration=$scope.segments[event.segmentId].meta.duration+delta;for(var i=event.segmentId+1;i<$scope.segments.length;i++)$scope.segments[i].meta.mastertime=$scope.segments[i].meta.mastertime+delta}$scope.segments[event.segmentId].states=event.updatedNr8.states,$scope.master=Nr8Composer.composeMaster($scope.selectedImage,$scope.customCoverImage,$scope.segments),event.hasOwnProperty("addingOrUpdatingImage")&&event.addingOrUpdatingImage&&$scope.selectedImage.id!==placeholderId&&$scope.selectedImage!==$scope.customCoverImage&&Nr8Composer.isCoverAffectedByImageUpdate($scope.selectedImage,_.cloneDeep($scope.segments))&&($scope.setNotification("The image you replaced was set as the cover image. Please select a new cover image.",!0),$scope.selectedImage=placeholderImage,$scope.master=Nr8Composer.addCoverImage(placeholderImage,_.cloneDeep($scope.master))),save(!1)}),$scope.saveTranscript=function(transcripts){$scope.article.transcripts=transcripts,save(!1)}}])}();
!function(){"use strict";angular.module("mean.articles").controller("FlagContentController",["$scope","$stateParams","$state","$http","$modal",function($scope,$stateParams,$state,$http,$modal){$scope.descriptionMinCharacters=1,$scope.descriptionMaxCharacters=260;var articleId=$stateParams.articleId;$scope.isFlaggedByUser=!1,$scope.$watch($scope.flaggedInfo,function(n,o){},!0),$scope.flaggedInfo={ci:!1,ic:!1,sexual:!1,violent:!1,hateful:!1,harmful:!1,childabuse:!1,spam:!1,other:!1,description:""},$scope.icInvalid=!0,$scope.icValid=function(){return $scope.icInvalid=!($scope.flaggedInfo.sexual||$scope.flaggedInfo.violent||$scope.flaggedInfo.hateful||$scope.flaggedInfo.harmful||$scope.flaggedInfo.childabuse||$scope.flaggedInfo.spam||$scope.flaggedInfo.other),$scope.flaggedInfo.ic=!$scope.icInvalid,!$scope.icInvalid},$scope.flag=function(){$scope.formFlagContent.$valid&&$scope.icValid()&&$http.post("/articles/"+articleId+"/flag",$scope.flaggedInfo).then(function(){$scope.isFlaggedByUser=!0},function(){console.error("Sorry, could not flag the article.")})}}])}();
!function(){"use strict";angular.module("mean.articles").controller("ImageSegmentEditController",["$scope","Nr8Composer","$http","$upload","$modal","cropImageService","IMAGE_ANIMATION_CONFIG","blockUI","$rootScope",function($scope,Nr8Composer,$http,$upload,$modal,cropImageService,IMAGE_ANIMATION_CONFIG,blockUI,$rootScope){function segmentChangeUpdate(durationChange,addingOrUpdatingImage){void 0!==addingOrUpdatingImage&&null!==addingOrUpdatingImage||(addingOrUpdatingImage=!1),$scope.$emit("segmentUpdated",{segmentDurationChange:durationChange,addingOrUpdatingImage:addingOrUpdatingImage,segmentId:$scope.segmentId,updatedNr8:$scope.segmentNr8,caller:"ImageSegmentEditController : "+$scope.segmentId}),$scope.segmentNr8WithCover=Nr8Composer.addCoverToSegment(_.cloneDeep($scope.segmentNr8)),$scope.$broadcast("Nr8Updated",{update:"Nr8Recomposed",updatedNr8:$scope.segmentNr8WithCover,caller:"ImageSegmentEditController : "+$scope.segmentId})}function updateDurationNotOkModal(message){$modal.open({templateUrl:"system/views/ok.html",controller:"okCtrl",size:"md",resolve:{title:function(){return"Could not update duration"},message:function(){return message}}}).result.then(function(){},function(){console.log("Modal dismissed at : "+new Date)})}function addOrUpdate(image,duration,isDurationUpdate){var segmentDurationChange=!1,addingOrUpdatingImage=!1;if($scope.showNr8=!0,0===$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte)$scope.segmentNr8=Nr8Composer.composeImageSegment($scope.segmentId,image,parseInt(duration)),segmentDurationChange=!0,addingOrUpdatingImage=!0,$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte>=2&&($scope.segmentNr8=Nr8Composer.add_inAnim($scope.segmentNr8,$scope.inAnim),$scope.segmentNr8=Nr8Composer.add_outAnim($scope.segmentNr8,$scope.outAnim),$scope.allowAnimations=!0);else if(isDurationUpdate){$scope.duration=duration;var result=Nr8Composer.updateSegmentDuration($scope.segmentNr8,duration);if("ok"!==result.status)return void updateDurationNotOkModal(result.message);segmentDurationChange=!0,$scope.segmentNr8=result.nr8,$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte>=2?$scope.allowAnimations=!0:($scope.allowAnimations=!1,$scope.segmentNr8=Nr8Composer.remove_inAnim($scope.segmentNr8),$scope.segmentNr8=Nr8Composer.remove_outAnim($scope.segmentNr8),$scope.inAnim=null,$scope.outAnim=null)}else $scope.segmentNr8.states.forEach(function(state,i){state.lp.image=image}),addingOrUpdatingImage=!0;segmentChangeUpdate(segmentDurationChange,addingOrUpdatingImage),$scope.$broadcast("statesForEditAnnotations",$scope.segmentNr8.states)}var imageServer=$rootScope.imageServer&&""!=$rootScope.imageServer?$rootScope.imageServer:"https://images.nr8.com";console.log("===>ImageSegmentEditController:imageServer",$rootScope.imageServer),$scope.segmentType="image",$scope.segmentId=-1,$scope.segmentNr8="",$scope.image=null,$scope.showNr8=!1,$scope.duration=4,$scope.durationMin=1,$scope.durationMax=20,$scope.inAnim=IMAGE_ANIMATION_CONFIG.in[IMAGE_ANIMATION_CONFIG.inDefaultIndex],$scope.outAnim=IMAGE_ANIMATION_CONFIG.out[IMAGE_ANIMATION_CONFIG.outDefaultIndex];$scope.annotationHelperOffset=15,$scope.annotationHelperFlag=!0,$scope.hideAnnotationHelper=function(){$scope.annotationHelperFlag=!1};var articleId;$scope.init=function(segmentId,segment,aId){articleId=aId,$scope.segmentId=segmentId,$scope.segmentNr8=segment,$scope.analyticsContext=_.merge($scope.$parent.analyticsContext,{component:"ImageSegmentEdit"}),segment.states[segment.states.length-1].mte>0&&($scope.duration=segment.states[segment.states.length-1].mte,$scope.image=segment.states[0].lp.image,$scope.inAnim=Nr8Composer.get_inAnim($scope.segmentNr8),$scope.outAnim=Nr8Composer.get_outAnim($scope.segmentNr8),$scope.cover=segment.states[0].lp.image,$scope.segmentNr8WithCover=Nr8Composer.addCoverToSegment(_.cloneDeep($scope.segmentNr8)),$scope.showNr8=!0,$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte>=2?$scope.allowAnimations=!0:$scope.allowAnimations=!1)},$scope.uploadImage=function(files){var file=files[0];void 0!==file&&(blockUI.start(),$scope.upload=$upload.upload({url:imageServer+"/upload/articles/"+articleId+"%2f"+file.name,method:"POST",transformRequest:function(data,headersGetter){return delete headersGetter().Authorization,data},file:file}).success(function(data){blockUI.stop(),cropImageService.cropImage(data.modalUrl,data.key,data.info,"16:9",function(id){$scope.image=Nr8Composer.newImageObject("is",id),addOrUpdate($scope.image,$scope.duration,!1)})}).error(function(){blockUI.stop()}))},$scope.durationFieldChange=function(dur){void 0===dur||null===dur||dur<$scope.durationMin||dur>$scope.durationMax||dur!==$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte&&addOrUpdate(null,dur,!0)},$scope.$on("animationUpdate",function(e,type,animation){"in"===type?"none"===animation.id?($scope.inAnim=null,$scope.segmentNr8=Nr8Composer.remove_inAnim($scope.segmentNr8)):($scope.inAnim=animation,$scope.segmentNr8=Nr8Composer.add_inAnim($scope.segmentNr8,animation)):"none"===animation.id?($scope.outAnim=null,$scope.segmentNr8=Nr8Composer.remove_outAnim($scope.segmentNr8)):($scope.outAnim=animation,$scope.segmentNr8=Nr8Composer.add_outAnim($scope.segmentNr8,animation)),segmentChangeUpdate(!1)}),$scope.$on("addAnnotationToSegment",function(e,event){$scope.segmentNr8=Nr8Composer.addAnnotation($scope.segmentNr8,event.addOrEditState,event.mts,event.mte,event.annotationText),$scope.$broadcast("statesForEditAnnotations",$scope.segmentNr8.states),segmentChangeUpdate(!1)}),$scope.$on("deleteAnnotation",function(e,event){$scope.segmentNr8=Nr8Composer.deleteAnnotation($scope.segmentNr8,event.state),$scope.$broadcast("statesForEditAnnotations",$scope.segmentNr8.states),segmentChangeUpdate(!1)})}])}();
!function(){"use strict";angular.module("mean.articles").controller("ListController",["$rootScope","$scope","articles","siteConfig","$mixpanel","PLAYER_CONFIG",function($rootScope,$scope,articles,siteConfig,$mixpanel,PLAYER_CONFIG){$mixpanel.track("Home",{}),$rootScope.$emit("showListHeader"),articles.isSearch=!1,$scope.articles=articles,$scope.showQMenu=!1,$scope.features=siteConfig.featureFlags,$scope.bannerList=siteConfig.bannerList||[],$scope.featuredNarratives=siteConfig.featuredNarratives,PLAYER_CONFIG.setPlayerConfig(),$scope.playingSupported=PLAYER_CONFIG.isPlayingSupported(),$scope.uiThemes=siteConfig.uiThemes,$scope.NR8Intro=siteConfig.NR8Intro,$scope.bannerEnabled=$scope.bannerList.length>0&&siteConfig.featureFlags.enableBanner}])}();
!function(){"use strict";angular.module("mean.system").controller("ModalHelpCreateSegments",function($scope,Global,$modalInstance,title,howtoArticle,analyticsContext){$scope.global=Global,$scope.title=title,$scope.howtoArticle=howtoArticle,$scope.analyticsContext=analyticsContext,$scope.ok=function(){$modalInstance.close()},$scope.cancel=function(){$modalInstance.dismiss("cancel")}})}();
!function(){"use strict";angular.module("mean.articles").controller("Nr8Controller",["$scope","$rootScope","$http","$location","$report","$timeout","$uuid","Nr8ServiceFactory","PLAYER_CONFIG",function($scope,$rootScope,$http,$location,$report,$timeout,$uuid,Nr8ServiceFactory,PLAYER_CONFIG){function setVolumeMultiplier(value){$scope.masterVolumeMultiplier=value/100,$scope.$$phase||$scope.$apply(),$scope.$emit("ytUpdate",{update:"applyVolumeMultipliers"})}function pause(){playIntent=!1,"video"===$scope.showType&&$scope.$emit("ytUpdate",{update:"pause",caller:"nr8Controller"}),nr8.pause(),$scope.$broadcast("audio.stopAll"),$scope.$emit("nr8IntentUpdate",{update:"paused",caller:"nr8Controller"}),receiver.emit("pause")}var playerjsPlayTimer,nr8=Nr8ServiceFactory.create(),isPaused=!0,playIntent=!1,currentTime=0;$scope.audioKeys=[],PLAYER_CONFIG.setPlayerConfig(),$scope.playingSupported=PLAYER_CONFIG.isPlayingSupported(),$scope.activeTab="details",$scope.displaySource=!1;var receiver=new playerjs.Receiver;receiver.on("play",function(){$scope.$emit("intentChange",{intent:"play",caller:"Nr8Controller"}),playerjsPlayTimer=$timeout(function(){$scope.$emit("intentChange",{intent:"play",caller:"Nr8Controller"})},1500),isPaused=!1}),receiver.on("pause",function(){$timeout.cancel(playerjsPlayTimer),$scope.$emit("intentChange",{intent:"pause",caller:"Nr8Controller"}),isPaused=!0}),receiver.on("getPaused",function(callback){callback(isPaused)}),receiver.on("getDuration",function(callback){callback($scope.initialPlayTime)}),receiver.on("getCurrentTime",function(callback){callback(currentTime)}),receiver.on("setCurrentTime",function(value){nr8.seek(value,!0)}),receiver.on("getVolume",function(callback){callback(100*$scope.masterVolumeMultiplier)}),receiver.on("setVolume",function(value){value>=0&&value<=100&&setVolumeMultiplier(value)}),receiver.on("mute",function(){setVolumeMultiplier(0)}),receiver.on("unmute",function(){setVolumeMultiplier(100)}),receiver.on("getMuted",function(callback){callback(0===$scope.masterVolumeMultiplier?!0:!1)}),receiver.on("getLoop",function(callback){callback(loop)}),receiver.on("setLoop",function(value){loop=value,nr8.setLoop(value)}),receiver.ready();var loadingTimer,globalCoverType,globalSeekTo,pid=$uuid(),playtimeStarted=null,maxLoadingTime=12e3,playersCreationCompleted=!1,playersUnstartedCompleted=!1,playersUnstartedHOAKeyPlayingToPreBuffer=!1,playersUnstartedHOAKeyPrebuffered=!1,prebufferCompleted=!1;$scope.showShareControlsOnPlayer;var intialLoadingInProgress=!0;$scope.masterVolumeMultiplier=1,$scope.ytVolumeMultiplier=1;var loop=!1;$scope.selectedTrack="none",$scope.showAudioTrackModal=!1,$scope.showAudioSelectTooltip=!1,$scope.hideAudioSelectToolTip=function(){$scope.showAudioSelectTooltip=!1},$scope.hideAudioTrack=function(selectedTrack){selectedTrack&&$scope.changeAudioTrack(),$scope.showAudioTrackModal=!1},$scope.ytVolume=100,$scope.overlayVolume=100,$scope.ytVolumeUpdated=function(){console.log("yt",$scope.ytVolumeMultiplier),$scope.$emit("ytUpdate",{update:"applyVolumeMultipliers"})},$scope.overlayVolumeUpdated=function(){console.log("overlay",$scope.overlayVolume),$scope.$broadcast("audio.volumeAll",$scope.overlayVolume)};var playSelectedAudioTrack=function(){$scope.$broadcast("audio.stopAll"),$scope.$broadcast("audio.seek",$scope.selectedTrack,currentTime),"none"!==$scope.selectedTrack&&$scope.$broadcast("audio.play",$scope.selectedTrack,currentTime)};$scope.changeAudioTrack=function(track){console.log("audio.track:",track),track&&($scope.selectedTrack=track),"none"!==track?(console.log("Change the audio track",$scope.selectedTrack),$scope.ytVolumeMultiplier=.22,$scope.ytVolumeUpdated(),playSelectedAudioTrack()):(console.log("audio.track: none"),$scope.ytVolumeMultiplier=1,$scope.ytVolumeUpdated(),$scope.$broadcast("audio.stopAll"))},($scope.iOS10||$scope.isAndroid)&&($scope.needToAuthorizePlayers=!0),$scope.isEmbedPage=0===$location.$$url.indexOf("/embed/"),$scope.stopLoadingAnimation=function(){"loading"===$scope.showType&&intialLoadingInProgress&&($timeout.cancel(loadingTimer),intialLoadingInProgress=!1,globalSeekTo&&nr8.externalSeekRequest(globalSeekTo,!0),void 0!==$scope.initialYtVolume&&null!==$scope.initialYtVolume&&$scope.$emit("ytUpdate",{update:"setvolume",volume:$scope.initialYtVolume}),$timeout(function(){$scope.isEmbedPage||$scope.needToAuthorizePlayers||"snippet"!==$scope.playerContext&&"playback"!==$scope.playerContext?($scope.showType=globalCoverType,$scope.$$phase||$scope.$apply()):$scope.$emit("intentChange",{intent:"play",caller:"Nr8Controller"})},1500))},$scope.loadingRelatedActivity=function(activityType){"playersCreationCompleted"===activityType?playersCreationCompleted=!0:"playersUnstartedCompleted"===activityType?playersUnstartedCompleted=!0:"playersUnstartedHOAKeyPlayingToPreBuffer"===activityType?playersUnstartedHOAKeyPlayingToPreBuffer=!0:"playersUnstartedHOAKeyPrebuffered"===activityType?playersUnstartedHOAKeyPrebuffered=!0:"prebufferCompleted"===activityType&&(prebufferCompleted=!0),$scope.isAndroid&&playersUnstartedCompleted?$scope.stopLoadingAnimation():!$scope.isAndroid&&playersUnstartedHOAKeyPlayingToPreBuffer&&$scope.stopLoadingAnimation()},$scope.init=function(actions,playerContext,seekTo){globalSeekTo=seekTo,$scope.audio=actions.audio||{files:[]},$scope.audioKeys=_.map($scope.audio.files,function(f){return f.path}),$scope.playerContext=playerContext,$scope.states=actions.states,$scope.showAudioTrackModal=$scope.audio.files.length>0;var initData=nr8.initialize(actions);globalCoverType=initData.coverType,$scope.videoKeys=initData.videoKeys,$scope.hasVideoSource=!1,$scope.videoKeys.length&&($scope.hasVideoSource=!0,$scope.anticipatedVideoKey=nr8.getAnticipatedVideoKey(seekTo)),$scope.imageKeys=initData.imageKeys,maxLoadingTime=1e3,$scope.videoKeys.length?maxLoadingTime=12e3:$scope.imageKeys.length&&(maxLoadingTime=$scope.imageKeys.length<4?1e3*$scope.imageKeys.length:4e3),$scope.annotationText=initData.annotationText,$scope.isAnnotationEmpty=!0,""!==$scope.annotationText&&($scope.isAnnotationEmpty=!1),$scope.initialPlayTime=initData.initialPlayTime,$scope.totalPages=initData.totalPages,$scope.initialCurrentPage=initData.currentPage,$scope.coverIsVideo=!1,"image"===initData.coverType?($scope.coverImage=initData.coverImage,"yt"===$scope.coverImage.split("&")[0]&&$scope.$emit("currentAttribution",{type:"image",videoId:$scope.coverImage.split("&")[1],context:$scope.playerContext,caller:"Nr8Controller"})):"text"===initData.coverType?($scope.coverTransition=initData.coverTransition,$scope.coverTransitionStyle=initData.coverTransitionStyle):"video"===initData.coverType&&($scope.coverIsVideo=!0,$scope.initialYtVolume=initData.initialYtVolume),$scope.showType="loading",loadingTimer=$timeout(function(){$scope.stopLoadingAnimation()},maxLoadingTime),$scope.hasAudioTracks=$scope.audioKeys&&$scope.audioKeys.length>0,$scope.hasAudioTracks&&$timeout(function(){$scope.showAudioSelectTooltip=!0,$timeout(function(){$scope.hideAudioSelectToolTip()},3e3)},4e3)},nr8.on("playTimeUpdate",function(context){var event=_.merge($scope.analyticsContext,{pid:pid,playerContext:$scope.playerContext,started:playtimeStarted,timestamp:(new Date).getTime(),duration:Math.round(context.duration/1e3)});$report("playtime",event)}),nr8.on("nr8ControlUpdate",function(context){switch(context.update){case"initUpdate":$scope.coverIsVideo=!1,"image"===context.initData.coverType?($scope.showType="image",$scope.$emit("imageUpdate",{update:"image",playState:0,imageKeyIndex:context.coverImage,caller:"nr8Controller"})):"text"===context.initData.coverType?($scope.showType="text",$scope.$emit("transitionUpdate",{update:"text",playState:0,transitionText:context.initData.coverTransition,style:context.initData.coverTransitionStyle,caller:"nr8Controller"})):"video"===context.initData.coverType&&($scope.coverIsVideo=!0,$scope.initialYtVolume=context.initData.initialYtVolume,$scope.hotKeyNotCachedOrPrebuffered||($scope.showType="video")),$scope.videoKeys=context.initData.videoKeys,$scope.videoKeys.length>0&&$scope.$emit("videoKeysUpdate",context.caller),$scope.imageKeys=context.initData.imageKeys,$scope.imageKeys.length>0&&$scope.$emit("imageKeysUpdate",context.caller),$scope.isAnnotationEmpty=!0,$scope.totalPages=context.initData.totalPages,""!==context.initData.annotationText&&($scope.isAnnotationEmpty=!1),$scope.$emit("annotationUpdate",{update:"text",annotationText:context.initData.annotationText,caller:"nr8Controller"}),$scope.$emit("nr8AnnotationControlUpdate",{update:"pageNumberUpdate",isAnnotationEmpty:$scope.isAnnotationEmpty,currentPage:context.initData.currentPage,totalPages:context.initData.totalPages,caller:"nr8Controller"}),$scope.$emit("nr8TotalDurationUpdate",{update:"durationUpdate",duration:context.initData.initialPlayTime,caller:"nr8Controller"});break;case"durationUpdate":$scope.$emit("nr8TotalDurationUpdate",{update:"durationUpdate",duration:context.duration,caller:"nr8Controller"});break;case"timeUpdate":$scope.$emit("nr8ControlUpdate",{update:"timeUpdate",playerTime:context.playerTime,caller:"nr8Controller"}),receiver.emit("timeupdate",{seconds:context.playerTime,duration:$scope.initialPlayTime}),currentTime=context.playerTime;break;case"progressUpdate":$scope.$emit("nr8ControlUpdate",{update:"progressUpdate",progressPercent:context.progressPercent,caller:"nr8Controller"});break;case"progressAndTimeUpdate":$scope.$emit("nr8ControlUpdate",{update:"progressAndTimeUpdate",progressPercent:context.progressPercent,playerTime:context.playerTime,caller:"nr8Controller"}),receiver.emit("timeupdate",{seconds:context.playerTime,duration:$scope.initialPlayTime}),currentTime=context.playerTime,receiver.emit("play");break;case"ended":playIntent=!1,$scope.$broadcast("audio.stopAll"),"video"===$scope.showType&&$scope.$emit("ytUpdate",{update:"stop",caller:"nr8Controller"}),void 0!==$scope.initialYtVolume&&null!==$scope.initialYtVolume&&$scope.$emit("ytUpdate",{update:"setvolume",volume:$scope.initialYtVolume}),$scope.$emit("nr8IntentUpdate",{update:"ended",caller:"nr8Controller"}),"playback"===$scope.playerContext&&($scope.showShareControlsOnPlayer=!0),receiver.emit("ended");break;case"reset":"video"===$scope.showType&&$scope.$emit("ytUpdate",{update:"stop",caller:"nr8Controller"}),$scope.$emit("nr8IntentUpdate",{update:"reset",caller:"nr8Controller"});break;default:console.log("Not sure what : nr8ControlUpdate inside Nr8Controller")}}),nr8.on("nr8ContentUpdate",function(context){switch(context.update){case"animationAndAudioT":case"animation":case"audioT":var structure=context;structure.caller="nr8Controller";var structure=context;structure.caller="nr8Controller","image"===context.segmentType?$scope.$emit("imageUpdate",structure):"text"===context.segmentType?$scope.$emit("transitionUpdate",structure):"video"===context.segmentType&&$scope.$emit("ytUpdate",structure);break;case"image":"video"===$scope.showType&&$scope.$emit("ytUpdate",{update:"pause",reason:"image",caller:"nr8Controller"}),$scope.showType="image";var imageUpdateInfo={update:"image",playState:context.playState,imageKeyIndex:context.imageKeyIndex,caller:"nr8Controller"};context.hasOwnProperty("inAnim")&&(imageUpdateInfo.inAnim=context.inAnim),context.hasOwnProperty("cover")&&(imageUpdateInfo.cover=context.cover),$scope.$emit("imageUpdate",imageUpdateInfo),"yt"===$scope.imageKeys[context.imageKeyIndex].split("&")[0]?$scope.$emit("currentAttribution",{type:"image",videoId:$scope.coverImage.split("&")[1],context:$scope.playerContext,caller:"Nr8Controller"}):$scope.$emit("currentAttribution",{type:"none",videoId:null,context:$scope.playerContext,caller:"Nr8Controller"}),$scope.$$phase||$scope.$apply();break;case"transition":"video"===$scope.showType&&$scope.$emit("ytUpdate",{update:"pause",reason:"transition",caller:"nr8Controller"}),$scope.showType="text";var transitionUpdateInfo={update:"text",playState:context.playState,transitionText:context.transitionText,style:context.style,caller:"nr8Controller"};context.hasOwnProperty("inAnim")&&(transitionUpdateInfo.inAnim=context.inAnim),$scope.$emit("transitionUpdate",transitionUpdateInfo),$scope.$emit("currentAttribution",{type:"none",videoId:null,context:$scope.playerContext,caller:"Nr8Controller"}),$scope.$$phase||$scope.$apply();break;case"video":$scope.hotKeyNotCachedOrPrebuffered||($scope.showType="video");var ytUpdateInfo={keyIndex:context.keyIndex,seekPosition:context.seekPosition,caller:"nr8Controller"};1===context.playState?(ytUpdateInfo.update="load",context.hasOwnProperty("inAnim")&&(ytUpdateInfo.inAnim=context.inAnim),context.hasOwnProperty("inAudioT")&&(ytUpdateInfo.inAudioT=context.inAudioT)):(context.hasOwnProperty("potentialVideoSegEditAfterOutAnim")&&context.potentialVideoSegEditAfterOutAnim&&"edit"===$scope.playerContext&&(ytUpdateInfo.videoSegEditAfterOutAnim=!0),ytUpdateInfo.update="cue"),$scope.$emit("ytUpdate",ytUpdateInfo),$scope.$emit("currentAttribution",{type:"video",videoId:$scope.videoKeys[context.keyIndex].split("&")[0],context:$scope.playerContext,caller:"Nr8Controller"}),$scope.$$phase||$scope.$apply();break;case"videoPosition":$scope.hotKeyNotCachedOrPrebuffered||($scope.showType="video"),$scope.$emit("ytUpdate",{update:"seek",seekPosition:context.seekPosition,caller:"nr8Controller"}),$scope.$$phase||$scope.$apply();break;case"text":$scope.$emit("annotationUpdate",{update:"text",annotationText:context.annotationText,caller:"nr8Controller"}),$scope.$emit("nr8AnnotationControlUpdate",{update:"pageNumberUpdate",isAnnotationEmpty:context.isAnnotationEmpty,currentPage:context.currentPage,totalPages:context.totalPages,caller:"nr8Controller"});break;default:console.log("Not sure what : nr8ContentUpdate inside Nr8Controller")}}),$scope.getInfoAtPosition=function(positionPercent){return nr8.getInfoAtPosition(positionPercent)},$scope.$on("intentChange",function(e,event){switch($scope.showShareControlsOnPlayer=!1,event.intent){case"play":playIntent=!0,"video"===$scope.showType&&"yt"!==event.caller?$scope.$emit("ytUpdate",{update:"play",caller:"nr8Controller"}):($scope.$emit("nr8IntentUpdate",{update:"playing",caller:event.caller}),$scope.needToAuthorizePlayers&&($scope.needToAuthorizePlayers=!1,$scope.$emit("loadnarrative","Nr8Controller")),playtimeStarted||(playtimeStarted=(new Date).getTime()),nr8.begin(),playSelectedAudioTrack()),receiver.emit("play");break;case"pause":pause();break;case"buffering":playIntent=!1,"video"===$scope.showType&&($scope.$broadcast("audio.stopAll"),nr8.suspend());break;case"seek":nr8.seek(event.seekToPercent,!1),$scope.$broadcast("audio.seek",$scope.selectedTrack,event.seekToPercent/100*$scope.initialPlayTime);break;case"externalSeekRequest":nr8.externalSeekRequest(event.seekToSeconds,!0);break;case"scrollAnnotationLeft":pause(),nr8.scrollAnnotation("left");break;case"scrollAnnotationRight":pause(),nr8.scrollAnnotation("right");break;case"ytended":$scope.showType="loading";break;default:console.log("Not sure what : intentChange inside Nr8Controller controller.")}}),$scope.$on("Nr8Updated",function(e,event){switch(event.update){case"duration":nr8.durationUpdate(event.updatedNr8,event.caller),"source"===$scope.playerContext&&($scope.showType="video");break;case"Nr8Recomposed":nr8.resetAndUpdate(event.updatedNr8,event.caller),"source"===$scope.playerContext&&($scope.showType="loading");break;default:console.log("Not sure what : Nr8Updated inside Nr8Controller directive.")}}),$scope.$on("audio.canplay",function(e,event){var audioKey=event.audioKey;playIntent?$scope.$broadcast("audio.play",audioKey):$scope.$broadcast("audio.stopAll")}),$scope.$on("$destroy",function(){$scope.$broadcast("audio.stopAll")});var sourceInitialized=!1;$scope.changeTab=function(currentTab){"sourcevideo"==currentTab&&($scope.displaySource=!0,sourceInitialized||$timeout(function(){angular.element("#sourcevideo-tab").triggerHandler("click"),sourceInitialized=!0},500)),$scope.activeTab=currentTab}}])}();
!function(){"use strict";angular.module("mean.articles").controller("PassphraseController",["$rootScope","$scope","$state","$stateParams",function($rootScope,$scope,$state,$stateParams){$rootScope.$emit("hideHeaders");var toArticleId=$stateParams.articleId,lastPassphrase=$stateParams.passphrase;$scope.passphraseIsInvalid=void 0!==lastPassphrase&&null!==lastPassphrase&&lastPassphrase.length>0,$scope.passphrase=lastPassphrase||"",$scope.validatePassphrase=function(){$state.go("article_view",{articleId:toArticleId,passphrase:$scope.passphrase})}}])}();
!function(){"use strict";angular.module("mean.articles").controller("PreviewController",["$scope","Nr8Composer","YoutubeMetadata","$anchorScroll","PLAYER_CONFIG",function($scope,Nr8Composer,YoutubeMetadata,$anchorScroll,PLAYER_CONFIG){PLAYER_CONFIG.setPlayerConfig(),$scope.playingSupported=PLAYER_CONFIG.isPlayingSupported(),!0===$scope.playingSupported&&($scope.numberOfPlayers=PLAYER_CONFIG.getNumberOfPlayers(),$scope.isAndroid=PLAYER_CONFIG.isAndroid(),$scope.iOSApp=PLAYER_CONFIG.isIOSApp(),$scope.iOS10=PLAYER_CONFIG.isIOS10(),$scope.iOSAppFullScreen=PLAYER_CONFIG.getIOSAppFullScreen()),$scope.init=function(master,cover){$scope.analyticsContext=_.merge($scope.$parent.analyticsContext,{component:"Preview"}),$scope.nr8=master,$scope.cover=cover,console.log(arguments),YoutubeMetadata.attach($scope),$scope.showAttribution=!1,$scope.currentSourceId="",$scope.playerContext="editmaster"},$scope.$on("currentAttribution",function(e,event){"editmaster"===event.context&&("none"===event.type?$scope.showAttribution=!1:($scope.type=event.type,$scope.currentSourceId=event.videoId,$scope.showAttribution=!0))})}])}();
!function(){"use strict";angular.module("mean.articles").controller("SearchResultsController",["$rootScope","$scope","articles","$sce","$mixpanel","$uuid","Global","MetaTagService",function($rootScope,$scope,queryAndResults,$sce,$mixpanel,$uuid,Global,MetaTagService){$mixpanel.track("Search",{query:queryAndResults.query}),$scope.analyticsContext={pageId:$uuid(),pageName:"Search",query:queryAndResults.query,userId:Global.user&&Global.user._id?Global.user._id:"000000000000000000000000"},$rootScope.$emit("showListHeader");var query=queryAndResults.query;$scope.query=query,console.log("query :",query);var results=queryAndResults.results;console.log(results);var articles=[],article={};results.hits.hit.forEach(function(hit){console.log("Each hit : "),console.log("fields : ",hit.fields),article={},hit.fields.hasOwnProperty("article")&&(article._id=hit.fields.article[0]),hit.fields.hasOwnProperty("title")&&(article.title=hit.fields.title[0]),hit.fields.hasOwnProperty("content")&&(article.content=hit.fields.content[0]),hit.fields.hasOwnProperty("datecreated")&&(article.created=hit.fields.datecreated[0]),hit.fields.hasOwnProperty("playtime")&&(article.playTime=parseFloat(hit.fields.playtime[0])),hit.fields.hasOwnProperty("coverimage")&&(article.image=JSON.parse(hit.fields.coverimage[0])),hit.fields.hasOwnProperty("user")&&(article.user=JSON.parse(hit.fields.user[0])),hit.fields.hasOwnProperty("views")&&(article.views=hit.fields.views[0]),console.log("article : ",article);var txt="",searchTextRegExp=new RegExp(query,"i");hit.fields.hasOwnProperty("title")&&(txt=article.title,txt=txt.replace(searchTextRegExp,"<mark>$&</mark>"),article.title=$sce.trustAsHtml(txt),txt.indexOf("mark")>-1&&console.log("Found in the title at ")),txt="",hit.fields.hasOwnProperty("content")&&(txt=article.content,txt=txt.replace(searchTextRegExp,"<mark>$&</mark>"),article.content=$sce.trustAsHtml(txt),txt.indexOf("mark")>-1&&(article.matchingContent=$sce.trustAsHtml(txt)));var matchingAnnotationsJson=[],annotationsjson=JSON.parse(hit.fields.annotationsjson[0]);txt="",hit.fields.annotations&&hit.fields.annotations.forEach(function(annotation,i){txt=annotation.slice(1).trim(),txt=txt.replace(searchTextRegExp,"<mark>$&</mark>"),txt.indexOf("mark")>-1&&(annotationsjson[i].text=$sce.trustAsHtml(txt),annotationsjson[i].page=i,console.log("Found in annotation ",i+1,annotationsjson[i]),matchingAnnotationsJson.push(annotationsjson[i]))}),article.matchingAnnotationsJson=matchingAnnotationsJson,articles.push(article)}),articles.isSearch=!0,$scope.articles=articles,$scope.results=JSON.stringify(results,null,2),$scope.showQMenu=!1,MetaTagService.setMetaTags({title:$scope.query,description:"A Whole New Way Of Expression",author:"",keywords:$scope.query}).setTitle($scope.query+" - NR8")}])}();
!function(){"use strict";angular.module("mean.articles").controller("ShareMoreTabsController",["$scope","$modal",function($scope,$modal){$scope.tabs={},$scope.tabs.share=!0,$scope.showTab=function(id){var a={};a[id]=!0,$scope.tabs=a},$scope.showEmbedHelp=function(){$modal.open({templateUrl:"system/views/modal-embed-help.html",controller:function($scope,$modalInstance){$scope.ok=function(){$modalInstance.close()}},size:"md",backdrop:"static",resolve:{title:function(){return"Embed Code"}}})}}])}();
!function(){"use strict";angular.module("mean.articles").controller("TextSegmentEditController",["$scope","Nr8Composer","TEXT_ANIMATION_CONFIG","$modal",function($scope,Nr8Composer,TEXT_ANIMATION_CONFIG,$modal){function segmentChangeUpdate(durationChange){$scope.$emit("segmentUpdated",{segmentDurationChange:durationChange,segmentId:$scope.segmentId,updatedNr8:$scope.segmentNr8,caller:"TextSegmentEditController : "+$scope.segmentId}),$scope.segmentNr8WithCover=Nr8Composer.addCoverToSegment(_.cloneDeep($scope.segmentNr8)),$scope.$broadcast("Nr8Updated",{update:"Nr8Recomposed",updatedNr8:$scope.segmentNr8WithCover,caller:"TextSegmentEditController : "+$scope.segmentId})}function updateDurationNotOkModal(message){$modal.open({templateUrl:"system/views/ok.html",controller:"okCtrl",size:"md",resolve:{title:function(){return"Could not update duration"},message:function(){return message}}}).result.then(function(){console.log("I am inside the ok handler, but will this ever be reached ?")},function(){console.log("Modal dismissed at : "+new Date)})}function updateStyle(){$scope.segmentNr8.states.forEach(function(state,i){state.lp.style=$scope.style}),segmentChangeUpdate(!1)}$scope.segmentType="text",$scope.segmentId=-1,$scope.segmentNr8="",$scope.showNr8=!1,$scope.text="",$scope.duration=4,$scope.disableAddButton=!0,$scope.durationMin=1,$scope.durationMax=20;$scope.annotationHelperOffset=15,$scope.annotationHelperFlag=!0,$scope.hideAnnotationHelper=function(){$scope.annotationHelperFlag=!1},$scope.style={theme:1,font:"1"},$scope.inAnim=TEXT_ANIMATION_CONFIG.in[TEXT_ANIMATION_CONFIG.inDefaultIndex],$scope.outAnim=TEXT_ANIMATION_CONFIG.out[TEXT_ANIMATION_CONFIG.outDefaultIndex],$scope.cover={host:"is",id:"articles/78920ccc23a22de377a2a1dffdfe0842be5ef378"},$scope.init=function(segmentId,segment){console.log("text segment :",segment),$scope.segmentId=segmentId,$scope.segmentNr8=segment,$scope.analyticsContext=_.merge($scope.$parent.analyticsContext,{component:"TextSegmentEdit"}),segment.states[segment.states.length-1].mte>0&&($scope.inAnim=Nr8Composer.get_inAnim($scope.segmentNr8),$scope.outAnim=Nr8Composer.get_outAnim($scope.segmentNr8),$scope.text=segment.states[0].lp.text,segment.states[0].lp.style&&($scope.style=segment.states[0].lp.style),$scope.duration=segment.states[segment.states.length-1].mte,$scope.segmentNr8WithCover=Nr8Composer.addCoverToSegment(_.cloneDeep($scope.segmentNr8)),$scope.showNr8=!0,$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte>=2?$scope.allowAnimations=!0:$scope.allowAnimations=!1)},$scope.addOrUpdate=function(text,duration,isDurationUpdate){var segmentDurationChange=!1;if($scope.showNr8=!0,0===$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte)$scope.segmentNr8=Nr8Composer.composeTextSegment($scope.segmentId,text,$scope.style,duration),segmentDurationChange=!0,$scope.text=text,$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte>=2&&($scope.segmentNr8=Nr8Composer.add_inAnim($scope.segmentNr8,$scope.inAnim),$scope.segmentNr8=Nr8Composer.add_outAnim($scope.segmentNr8,$scope.outAnim),$scope.allowAnimations=!0);else if(isDurationUpdate){$scope.duration=duration;var result=Nr8Composer.updateSegmentDuration($scope.segmentNr8,duration);if("ok"!==result.status)return void updateDurationNotOkModal(result.message);segmentDurationChange=!0,$scope.segmentNr8=result.nr8,$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte>=2?$scope.allowAnimations=!0:($scope.allowAnimations=!1,$scope.segmentNr8=Nr8Composer.remove_inAnim($scope.segmentNr8),$scope.segmentNr8=Nr8Composer.remove_outAnim($scope.segmentNr8),$scope.inAnim=null,$scope.outAnim=null)}else $scope.segmentNr8.states.forEach(function(state,i){state.lp.text=text});segmentChangeUpdate(segmentDurationChange),$scope.$broadcast("statesForEditAnnotations",$scope.segmentNr8.states),$scope.showNr8=!0},$scope.themeSelected=function(theme){$scope.style.theme=theme,updateStyle()},$scope.fontSelected=function(font){$scope.style.font=font,updateStyle()},$scope.textFieldChange=function(text,dur){if(0===$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte)return void(text.length?$scope.disableAddButton=!1:$scope.disableAddButton=!0);""!==text&&text!==$scope.segmentNr8.states[0].lp.text&&$scope.addOrUpdate(text,dur,!1)},$scope.durationFieldChange=function(text,dur){if(void 0===dur||null===dur||dur<$scope.durationMin||dur>$scope.durationMax)return void console.log("returning");dur!==$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte&&$scope.addOrUpdate(text,dur,!0)},$scope.$on("animationUpdate",function(e,type,animation){"in"===type?"none"===animation.id?($scope.inAnim=null,$scope.segmentNr8=Nr8Composer.remove_inAnim($scope.segmentNr8)):($scope.inAnim=animation,$scope.segmentNr8=Nr8Composer.add_inAnim($scope.segmentNr8,animation)):"none"===animation.id?($scope.outAnim=null,$scope.segmentNr8=Nr8Composer.remove_outAnim($scope.segmentNr8)):($scope.outAnim=animation,$scope.segmentNr8=Nr8Composer.add_outAnim($scope.segmentNr8,animation)),segmentChangeUpdate(!1)}),$scope.$on("addAnnotationToSegment",function(e,event){$scope.segmentNr8=Nr8Composer.addAnnotation($scope.segmentNr8,event.addOrEditState,event.mts,event.mte,event.annotationText),$scope.$broadcast("statesForEditAnnotations",$scope.segmentNr8.states),segmentChangeUpdate(!1)}),$scope.$on("deleteAnnotation",function(e,event){$scope.segmentNr8=Nr8Composer.deleteAnnotation($scope.segmentNr8,event.state),$scope.$broadcast("statesForEditAnnotations",$scope.segmentNr8.states),segmentChangeUpdate(!1)})}])}();
!function(){"use strict";angular.module("mean.articles").controller("TranscriptAddEditController",["$scope","Nr8Composer","$http","$upload","$modal","blockUI","$rootScope","TranscriptService",function($scope,Nr8Composer,$http,$upload,$modal,blockUI,$rootScope,transcriptService){function refreshLanguages(){if($scope.languageArray=_.clone(transcriptService.supportedLang),$scope.transcripts&&$scope.transcripts instanceof Array)for(var i=0;i<$scope.transcripts.length;i++)_.remove($scope.languageArray,function(obj){return obj.lang&&obj.lang==$scope.transcripts[i].language});$scope.transcriptLanguage=$scope.languageArray[0].lang}$rootScope.imageServer&&""!=$rootScope.imageServer&&$rootScope.imageServer;$scope.disableTranscriptUpdate=!0,$scope.transcriptLanguage="",$scope.selectedLanguage="",$scope.transcriptContent="",$scope.languageArray=_.clone(transcriptService.supportedLang),$scope.transcripts=[],$scope.addEditTranscript=0,$scope.transcriptEditObject={index:"",language:""},$scope.init=function(){$scope.article&&$scope.article.transcripts&&$scope.article.transcripts.length>0?$scope.transcripts=$scope.article.transcripts:($scope.article.transcripts=[],$scope.transcripts=$scope.article.transcripts),refreshLanguages()},$scope.transcriptFieldChange=function(content,lang){if(1==$scope.addEditTranscript)$scope.disableTranscriptUpdate=!1;else if(2==$scope.addEditTranscript&&$scope.transcriptEditObject.index>=0){$scope.disableTranscriptUpdate=!1;for(var i=0;i<$scope.transcripts.length;i++)if($scope.transcriptEditObject.index==i&&$scope.transcripts[i].content==content){$scope.disableTranscriptUpdate=!0,updated=!0;break}}},$scope.updateTranscript=function(content,lang){if(!$scope.disableTranscriptUpdate){if($scope.disableTranscriptUpdate=!0,""==lang)return!1;var transcriptedData=transcriptService.parseText(lang,content),temp=transcriptedData;transcriptedData.transcription&&(transcriptedData.transcription=transcriptService.validateStartEndTime(transcriptedData.transcription,$scope.article.playTime),console.log(temp,transcriptedData)),1==$scope.addEditTranscript?($scope.article.transcripts.push(transcriptedData),$scope.editTranscript($scope.article.transcripts.length-1,transcriptedData),$scope.addTranscript(null,"cancel"),refreshLanguages()):2==$scope.addEditTranscript&&$scope.transcriptEditObject.index>=0&&($scope.article.transcripts[$scope.transcriptEditObject.index]=transcriptedData,$scope.editTranscript($scope.article.transcripts.length-1,transcriptedData),$scope.addTranscript(null,"cancel"),refreshLanguages()),$scope.saveTranscript($scope.article.transcripts),setTimeout(function(){$scope.disableTranscriptUpdate=!1},500)}},$scope.addTranscript=function(event,action){2==$scope.addEditTranscript?"cancel"==action&&($scope.addEditTranscript=0,$scope.transcriptLanguage="",$scope.transcriptContent=""):($scope.transcriptLanguage="",$scope.transcriptContent="",$scope.addEditTranscript=0==$scope.addEditTranscript?1:0)},$scope.editTranscript=function(index,object){for(var lang=object.language,i=0;i<$scope.transcripts.length;i++)index==i&&lang&&$scope.transcripts[i].language&&($scope.transcriptLanguage=$scope.transcripts[i].language,$scope.transcriptContent=$scope.transcripts[i].content,$scope.addEditTranscript=2,$scope.transcriptEditObject={index:i,language:lang});$scope.disableTranscriptUpdate=!1},$scope.removeTranscript=function(index,object){if(confirm("This will be removed permanently? \n Do you really want to remove this language?")){for(var lang=object.language,removed=!1,len=$scope.transcripts.length,i=0;i<len;i++)$scope.transcripts[i]&&index==i&&lang==$scope.transcripts[i].language&&(_.remove($scope.transcripts,function(obj){return console.log("obj.language removed ",obj.language),obj.language==lang}),removed=!0);removed&&($scope.saveTranscript($scope.article.transcripts),$scope.disableTranscriptUpdate=!1,$scope.addTranscript(null,"cancel"),refreshLanguages())}}}])}();
!function(){"use strict";angular.module("mean.articles").controller("VideoSegmentEditController",["$scope","Nr8Composer","$http","YT_ANIMATION_CONFIG","YT_AUDIOTRANSITION_CONFIG","$modal","$element","$mixpanel","$timeout","YTSearch",function($scope,Nr8Composer,$http,YT_ANIMATION_CONFIG,YT_AUDIOTRANSITION_CONFIG,$modal,$element,$mixpanel,$timeout,YTSearch){function segmentChangeUpdate(durationChange){$scope.$emit("segmentUpdated",{segmentDurationChange:durationChange,segmentId:$scope.segmentId,updatedNr8:$scope.segmentNr8,caller:"VideoSegmentEditController : "+$scope.segmentId}),$scope.segmentNr8WithCover=Nr8Composer.addCoverToSegment(_.cloneDeep($scope.segmentNr8)),$scope.$broadcast("Nr8Updated",{update:"Nr8Recomposed",updatedNr8:$scope.segmentNr8WithCover,caller:"VideoSegmentEditController : "+$scope.segmentId})}function roundTime(time){return parseFloat(time.toFixed(1))}$scope.isMobileAny=isMobile.any,$scope.segmentType="video",$scope.segmentId=-1,$scope.segmentNr8="";var segmentInfo,sourceId="",sourceDuration=0,awaitingNewSourceDuration=!1,firstSegmentSelectionActivityReceived=!1,oldVideoNr8=null;$scope.showNr8=!1,$scope.showSourceSelectionControls=!1,$scope.showSourceTimeSelectionControls=!1,$scope.showCancelResetControls=!1,$scope.enableReset=!1,$scope.showAnnotationControls=!1,$scope.annotationText="",$scope.buttonText="Add Annotation",$scope.inAnim=YT_ANIMATION_CONFIG.in[YT_ANIMATION_CONFIG.inDefaultIndex],$scope.outAnim=YT_ANIMATION_CONFIG.out[YT_ANIMATION_CONFIG.outDefaultIndex],$scope.inAudioT=YT_AUDIOTRANSITION_CONFIG.in[YT_AUDIOTRANSITION_CONFIG.inDefaultIndex],$scope.outAudioT=YT_AUDIOTRANSITION_CONFIG.out[YT_AUDIOTRANSITION_CONFIG.outDefaultIndex];$scope.segmentSelectionHelperOffset=15,$scope.annotationHelperOffset=15,$scope.annotationHelperFlag=!0,$scope.hideAnnotationHelper=function(){$scope.annotationHelperFlag=!1},$scope.chooseSegmentHelperFlag=!0,$scope.hideChooseSegmentHelper=function(){$scope.chooseSegmentHelperFlag=!1},$scope.isMobileAny&&($scope.popoverSegmentHelper=function(){$scope.chooseSegmentHelperFlag=!0,$timeout(function(){$scope.hideChooseSegmentHelper()},6e3)},$scope.popoverSegmentHelper()),$scope.init=function(segmentId,segment){if($scope.analyticsContext=_.merge($scope.$parent.analyticsContext,{component:"VideoSegmentEdit"}),$scope.segmentId=segmentId,$scope.segmentNr8=_.cloneDeep(segment),""===(sourceId=segment.states[0].lp.videoId)){var sources=Nr8Composer.retrieveSources(_.cloneDeep($scope.article.actions.states),!0);$scope.sourceImages=[],sources.forEach(function(source){$scope.sourceImages.push({host:"yt",id:source.sourceId})}),$scope.showSourceSelectionControls=!0}else segment.states[0].lp.unavailable&&($scope.videoError=!0),$scope.segmentNr8WithCover=$scope.segmentNr8,$scope.showNr8=!0,$scope.cover={host:"yt",id:sourceId},0===$scope.segmentNr8.meta.duration?$scope.showSourceTimeSelectionControls=!0:($scope.showAnnotationControls=!0,$scope.inAnim=Nr8Composer.get_inAnim($scope.segmentNr8),$scope.outAnim=Nr8Composer.get_outAnim($scope.segmentNr8),$scope.inAudioT=Nr8Composer.get_inAudioT($scope.segmentNr8),$scope.outAudioT=Nr8Composer.get_outAudioT($scope.segmentNr8),$scope.segmentNr8WithCover=Nr8Composer.addCoverToSegment(_.cloneDeep($scope.segmentNr8)),$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].mte>=2?$scope.allowAnimations=!0:$scope.allowAnimations=!1)},$scope.fetchYouTubeURL=function(query){if(query){var match=query.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);match&&11===match[2].length?$scope.loadSource(match[2].toString()):$scope.showYTSearch(query)}},$scope.showYTSearch=function(query){$modal.open({templateUrl:"system/views/modal-ytsearch.html",controller:"YTSearchController",size:"lg",backdrop:"static",resolve:{searchQuery:function(){return query}}}).result.then(function(videoId){videoId&&$scope.loadSource(videoId)},function(){$scope.focusSourceURL()})},$scope.loadSource=function(videoIdOrUrl){if($scope.videoIdOrUrl="",11===videoIdOrUrl.length)sourceId=videoIdOrUrl;else{var match=videoIdOrUrl.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);if(!match||11!==match[2].length)return console.log("Not valid youtube url"),void $scope.setNotification("Could not find the YouTube video. Please enter a valid YouTube video link.",!0,"danger");sourceId=match[2].toString()}var imageUrl=encodeURIComponent("http://img.youtube.com/vi/"+sourceId+"/1.jpg");console.log("imageUrl ",imageUrl),$http.get("/validate/image/"+imageUrl).success(function(){$scope.segmentNr8=Nr8Composer.composeVideoSegment($scope.segmentId,sourceId,0,0),$scope.segmentNr8WithCover=$scope.segmentNr8,$scope.showSourceSelectionControls=!1,$scope.showNr8=!0,awaitingNewSourceDuration=!0}).error(function(){console.log("Not valid youtube url"),$scope.setNotification("Could not find the YouTube video. Please enter a valid YouTube video link.",!0,"danger")})},$scope.focusSourceURL=function(){$element.find(".source_url").focus()},$scope.loadPreviouslySelectedSource=function(image){$scope.loadSource(image.id)},$scope.addSelection=function(isCancel){if(isCancel)$scope.segmentNr8.states=oldVideoNr8.states;else{if(segmentInfo.endTime-segmentInfo.startTime<1)return void $scope.setNotification("The duration has to be a minimum of 1 second or longer.",!0,"danger");segmentInfo.endTime-segmentInfo.startTime<2?($scope.segmentNr8=Nr8Composer.recomposeWithNewSourceTimes($scope.segmentNr8,segmentInfo.startTime,segmentInfo.endTime),$scope.allowAnimations=!1):($scope.segmentNr8=Nr8Composer.recomposeWithNewSourceTimes($scope.segmentNr8,segmentInfo.startTime,segmentInfo.endTime,$scope.inAnim,$scope.outAnim,$scope.inAudioT,$scope.outAudioT),$scope.allowAnimations=!0),$scope.setNotification("Segment has been selected.",!0)}$scope.showSourceSelectionControls=!1,$scope.showSourceTimeSelectionControls=!1,$scope.showAnnotationControls=!0,$scope.$broadcast("statesForEditAnnotations",$scope.segmentNr8.states),segmentChangeUpdate(!0),$scope.$broadcast("hidingEditFromSource"),console.log("newone : ",$scope.segmentNr8)},$scope.resetToPrevSelection=function(){$scope.enableReset&&(console.log("Reset is enabled"),$scope.enableReset=!1,firstSegmentSelectionActivityReceived=!1,$scope.$broadcast("resetToPrevSelection"))},$scope.cancelEditFromSource=function(){$scope.addSelection(!0)},$scope.reeditSegmentFromSource=function(segmentId){$scope.isMobileAny&&$scope.popoverSegmentHelper(),$scope.$broadcast("editAnnotationStateCancel",{caller:"VideoSegmentEditController : "+$scope.segmentId}),oldVideoNr8=_.cloneDeep($scope.segmentNr8),firstSegmentSelectionActivityReceived=!1,$scope.showCancelResetControls=!0,$scope.enableReset=!1,$scope.showSourceSelectionControls=!1,$scope.showSourceTimeSelectionControls=!0,$scope.showAnnotationControls=!1;var prevLts=$scope.segmentNr8.states[0].lp.lts,prevLte=$scope.segmentNr8.states[$scope.segmentNr8.states.length-1].lp.lte;$scope.inAnim=Nr8Composer.get_inAnim($scope.segmentNr8),$scope.outAnim=Nr8Composer.get_outAnim($scope.segmentNr8),$scope.inAudioT=Nr8Composer.get_inAudioT($scope.segmentNr8),$scope.outAudioT=Nr8Composer.get_outAudioT($scope.segmentNr8),$scope.segmentNr8=Nr8Composer.remove_anims_audioTs($scope.segmentNr8),$scope.segmentNr8=Nr8Composer.mergeWithSource($scope.segmentNr8,sourceDuration),$scope.$broadcast("Nr8Updated",{update:"Nr8Recomposed",updatedNr8:$scope.segmentNr8,caller:"VideoSegmentEditController : "+$scope.segmentId}),$scope.$broadcast("statesForEditFromSource",$scope.segmentNr8.states,prevLts,prevLte),$scope.$broadcast("hidingEditAnnotations")},$scope.playSourceSelection=function(){$scope.$broadcast("playSourceSelection")},$scope.$on("recomposeSourceNr8WithTrueDuration",function(e,event){if(console.log($scope.segmentId,"Duration obtained=====================",event.duration),event.duration>=0){sourceDuration=event.duration,$scope.sourceDurationHumanTime=sourceDuration.humanTime();var updatedNr8=_.cloneDeep($scope.segmentNr8);!0===awaitingNewSourceDuration&&($scope.$emit("segmentUpdated",{segmentDurationChange:!1,segmentId:$scope.segmentId,updatedNr8:updatedNr8,caller:"VideoSegmentEditController : "+$scope.segmentId}),$scope.showSourceTimeSelectionControls=!0,$scope.showAnnotationControls=!1,awaitingNewSourceDuration=!1),!0===$scope.showSourceTimeSelectionControls&&($scope.segmentNr8=Nr8Composer.recomposeWithNewSourceTimes($scope.segmentNr8,0,event.duration),$scope.$broadcast("Nr8Updated",{update:"duration",updatedNr8:$scope.segmentNr8,caller:"videoSegmentEditController"}),$scope.$broadcast("statesForEditFromSource",$scope.segmentNr8.states))}}),$scope.$on("segmentSelectionActivity",function(e,activity){if($scope.enableReset||(firstSegmentSelectionActivityReceived?$scope.enableReset=!0:firstSegmentSelectionActivityReceived=!0),segmentInfo={startTime:roundTime(activity.startTime),endTime:roundTime(activity.endTime)},activity.overflow>0)$scope.segmentSelectionHelperOffset=15+activity.overflow;else{if(15===$scope.annotationHelperOffset)return;$scope.segmentSelectionHelperOffset=15}$scope.$$phase||$scope.$apply()}),$scope.$on("animationUpdate",function(e,type,animation){console.log("Animation type : ",type),console.log("Animation name : ",animation.name),console.log("Animation duration : ",animation.options.duration),"in"===type?"none"===animation.id?($scope.inAnim=null,$scope.segmentNr8=Nr8Composer.remove_inAnim($scope.segmentNr8)):($scope.inAnim=animation,$scope.segmentNr8=Nr8Composer.add_inAnim($scope.segmentNr8,animation),console.log("Just received segment in animation : ",$scope.segmentNr8)):"none"===animation.id?($scope.outAnim=null,$scope.segmentNr8=Nr8Composer.remove_outAnim($scope.segmentNr8)):($scope.outAnim=animation,$scope.segmentNr8=Nr8Composer.add_outAnim($scope.segmentNr8,animation),console.log("Just received segment out animation : ",$scope.segmentNr8)),segmentChangeUpdate(!1)}),$scope.$on("audioTransitionUpdate",function(e,type,audioTransition){console.log("audioTransition received : ",audioTransition.name,audioTransition.id),"in"===type?"none"===audioTransition.id?($scope.inAudioT=null,$scope.segmentNr8=Nr8Composer.remove_inAudioT($scope.segmentNr8)):($scope.inAudioT=audioTransition,$scope.segmentNr8=Nr8Composer.add_inAudioT($scope.segmentNr8,audioTransition)):"none"===audioTransition.id?($scope.outAudioT=null,$scope.segmentNr8=Nr8Composer.remove_outAudioT($scope.segmentNr8)):($scope.outAudioT=audioTransition,$scope.segmentNr8=Nr8Composer.add_outAudioT($scope.segmentNr8,audioTransition)),console.log("$scope.segmentNr8",$scope.segmentNr8),segmentChangeUpdate(!1)}),$scope.$on("addAnnotationToSegment",function(e,event){$scope.segmentNr8=Nr8Composer.addAnnotation($scope.segmentNr8,event.addOrEditState,event.mts,event.mte,event.annotationText),$scope.$broadcast("statesForEditAnnotations",$scope.segmentNr8.states),segmentChangeUpdate(!1)}),$scope.$on("deleteAnnotation",function(e,event){$scope.segmentNr8=Nr8Composer.deleteAnnotation($scope.segmentNr8,event.state),$scope.$broadcast("statesForEditAnnotations",$scope.segmentNr8.states),segmentChangeUpdate(!1)}),$scope.$on("videoSegmentPlayerError",function(e,event){if(!$scope.videoError&&sourceId===event.videoId){var title="",message="",deleteSegment=!1;console.log("event : ",event),0===$scope.segment.states[$scope.segment.states.length-1].mte?(100===event.errorCode?(title="Video Not Available",message="The video you have entered has been removed or it is set as private. Please enter a different video."):101===event.errorCode||150===event.errorCode?(title="Video Non-Embeddable",message="The video you have entered is set as non-embeddable. Please enter a different video."):(title="Error Loading Video",message="There was an error loading the video. Please re-try."),deleteSegment=!0,$mixpanel.track("NewVideoSegmentError",{narrative_id:$scope.article._id})):100===event.errorCode||101===event.errorCode||150===event.errorCode?($scope.toggleSegment($scope.segmentId),$scope.segmentNr8=Nr8Composer.setVideoSegmentAsUnavailable($scope.segmentNr8),$scope.segmentNr8WithCover=$scope.segmentNr8,segmentChangeUpdate(!1),$scope.updateVisibility("YTContentNA"),title="There Was An Error",message="The YouTube video you have used as a source is either no longer avalible or has been set as non-embeddable. Please expand the segment again to see more details.",$mixpanel.track("OldVideoSegmentError",{narrative_id:$scope.article._id})):($scope.toggleSegment($scope.segmentId),title="There Was An Error.",message="There was an error while loading your video segment. Please expand the segment again!");$modal.open({templateUrl:"system/views/ok.html",controller:"okCtrl",size:"md",resolve:{title:function(){return title},message:function(){return message}}}).result.then(function(){deleteSegment&&$scope.deleteVideoSegmentNoModal($scope.segmentId,!0)},function(){deleteSegment&&$scope.deleteVideoSegmentNoModal($scope.segmentId,!0)})}})}])}();
!function(){"use strict";angular.module("mean.articles").controller("ViewController",["$rootScope","$scope","$stateParams","$modal","Nr8Composer","$window","$location","Global","Articles","article","playViews","myopinion","$timeout","$history","$state","Facebook","YoutubeMetadata","$anchorScroll","siteConfig","$http","$mixpanel","$uuid","MetaTagService","PLAYER_CONFIG",function($rootScope,$scope,$stateParams,$modal,Nr8Composer,$window,$location,Global,Articles,article,playViews,myopinion,$timeout,$history,$state,Facebook,YoutubeMetadata,$anchorScroll,siteConfig,$http,$mixpanel,$uuid,MetaTagService,PLAYER_CONFIG){var imageServer=$rootScope.imageServer&&""!=$rootScope.imageServer?$rootScope.imageServer:"https://images.nr8.com";console.log("===>ViewController:imageServer",$rootScope.imageServer),$scope.playViews=playViews,$scope.embedCode='<iframe width="854" height="535" src="https://www.nr8.com/embed/'+article._id+'" frameborder="0" allowfullscreen></iframe>',$scope.analyticsContext={pageId:$uuid(),narrativeId:article._id,narrativeTitle:article.title,narrativeChallenges:_.map(article.challenges,function(c){return c.key}),authorName:article.user?article.user.username:"",visibility:article.visibility,pageName:"View",userId:Global.user&&Global.user._id?Global.user._id:"000000000000000000000000"},$scope.features=siteConfig.featureFlags,$scope.bannerList=siteConfig.bannerList||[],$scope.bannerEnabled=$scope.bannerList.length>0&&siteConfig.featureFlags.enableBanner,$scope.bannerList=siteConfig.bannerList||[],YoutubeMetadata.attach($scope),$scope.nr8=article.actions,$scope.cover=article.image,$scope.shareUrl="nr8.com/narratives/"+article._id,$scope.socialShareUrl="https://www.nr8.com/narratives/"+article._id,$scope.urlCopied=!1,$scope.global=Global;PLAYER_CONFIG.setPlayerConfig(),$scope.playingSupported=PLAYER_CONFIG.isPlayingSupported(),!0===$scope.playingSupported&&($scope.numberOfPlayers=PLAYER_CONFIG.getNumberOfPlayers(),$scope.isAndroid=PLAYER_CONFIG.isAndroid(),$scope.iOSApp=PLAYER_CONFIG.isIOSApp(),$scope.iOS10=PLAYER_CONFIG.isIOS10(),$scope.iOSAppFullScreen=PLAYER_CONFIG.getIOSAppFullScreen()),$scope.isMobileAny=isMobile.any;var ua=navigator.userAgent.toLowerCase();$scope.isSafari=-1!=ua.indexOf("safari")&&!(ua.indexOf("chrome")>-1),$mixpanel.track("View",{narrative_id:article._id,narrative_title:article.title,visibility:article.visibility,author_name:article.user?article.user.username:"",user_id:Global.user?Global.user._id:"<anonymous>",narrative_challenges:(article.challenges||[]).map(function(obj){return obj.key})}),$scope.showAttribution=!1,$scope.currentSourceId="",$scope.playerContext="playback",$scope.shareOnReddit=function(){$scope.features.facebookShare&&($mixpanel.track("Share",{share_on:"Reddit",narrative_id:article._id}),function(pageURL,title,w,h){var left=screen.width/2-w/2,top=screen.height/2-h/2;window.open(pageURL,title,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+w+", height="+h+", top="+top+", left="+left)}("http://www.reddit.com/submit?url="+encodeURIComponent($location.absUrl())+"&title="+$scope.article.title,"redditWindow",900,700))},$scope.shareOnFacebook=function(){$scope.features.facebookShare&&(console.log("shareOnFacebook"),$scope.$broadcast("exitFullScreen",{caller:"ViewController"}),Facebook.ui({method:"share",href:$scope.socialShareUrl},function(response){response&&angular.isDefined(response.error_code)&&(console.log("error sharing on facebook"),console.log(response))}),$mixpanel.track("Share",{share_on:"Facebook",narrative_id:article._id}))},$scope.shareOnTwitter=function(){$scope.features.facebookShare&&($scope.$broadcast("exitFullScreen",{caller:"ViewController"}),$mixpanel.track("Share",{share_on:"Twitter",narrative_id:article._id}))},$scope.shareOnEmail=function(article){if($scope.features.facebookShare){$mixpanel.track("Share",{share_on:"Email",narrative_id:article._id});$modal.open({templateUrl:"system/views/modal-email.html",controller:"sendEmailCtrl",size:"lg",backdrop:"static",resolve:{title:function(){return"Share via email"},toEmail:function(){return null},message:function(){return null},article:function(){return article}}})}};var setLikeState=function(state){$http.post("/api/articles/"+$scope.article._id+"/me/"+state).then(function(response){$scope.article.metrics=response.data.metrics})};$scope.enableLikes=!(!Global.user||!Global.user._id),$scope.opinion=_.cloneDeep(myopinion),$scope.like=function(){$scope.opinion.like=!$scope.opinion.like,$scope.opinion.dislike=!1,setLikeState($scope.opinion.like?"like":"neutral")},$scope.dislike=function(){$scope.opinion.like=!1,$scope.opinion.dislike=!$scope.opinion.dislike,setLikeState($scope.opinion.dislike?"dislike":"neutral")},$scope.goBackToLastPage=function(){$history.goToLastListState()};var lastListLocation=$history.getLastListState();switch(lastListLocation.state.name){case"profile.view":lastListLocation.params.atuserid&&""!=lastListLocation.params.atuserid&&Global.user.username===lastListLocation.params.atuserid.substring(1)?$scope.backLabel="Your profile page":lastListLocation.params.atuserid&&""!=lastListLocation.params.atuserid?$scope.backLabel=lastListLocation.params.atuserid.substring(1)+"'s profile page":$scope.backLabel="NR8 homepage";break;case"article_search":isMobile.any?$scope.backLabel="Search results":$scope.backLabel='Search results for "'+lastListLocation.params.query+'"';break;default:$scope.backLabel="NR8 homepage"}$rootScope.$emit("hideHeaders"),$scope.global=Global,$scope.seekTo=$stateParams.seekTo,$scope.article=article;var cover=null;"yt"===$scope.article.image.host?cover=imageServer+"/host/yt/"+article.image.id+"/800":"is"===$scope.article.image.host&&(cover=imageServer+"/host/is/"+encodeURIComponent(article.image.id)+"/800"),MetaTagService.setMetaTags({"og:site_name":"Reach your audience","og:url":$scope.socialShareUrl,"og:image":cover,"og:title":$scope.article.title,"og:description":$scope.article.content,"article:author":$scope.article.user.firstname+" "+$scope.article.user.lastname,"og:type":"article","article:publisher":"https://www.facebook.com/Nr8inc","twitter:card":"summary_large_image","twitter:site":"@nr8inc","twitter:image":cover,"twitter:title":$scope.article.title,"twitter:description":$scope.article.content,"twitter:creator":$scope.article.user.firstname+" "+$scope.article.user.lastname,title:$scope.article.title,description:$scope.article.content,author:$scope.article.user.firstname+" "+$scope.article.user.lastname,keywords:$scope.article.tags.map(function(tag){return tag.text})}).setTitle($scope.article.title+" - NR8"),$scope.isMobileAny=isMobile.any,$scope.hasAuthorization=function(article){return!(!article||!article.user)&&("anonymous"!==article.user.username&&($scope.global.isAdmin||article.user._id===$scope.global.user._id))},$scope.remove=function(article){$modal.open({templateUrl:"system/views/okCancel.html",controller:"okCancelCtrl",size:"md",resolve:{title:function(){return"Are you sure you want to delete this narrative?"},message:function(){return null}}}).result.then(function(){article.$remove(function(){$location.path("articles")})},function(){console.log("Modal dismissed at : "+new Date)})},$scope.$on("currentAttribution",function(e,event){"playback"===event.context&&("none"===event.type?$scope.showAttribution=!1:($scope.type=event.type,$scope.currentSourceId=event.videoId,$scope.showAttribution=!0))}),$scope.$on("error.yt.contentNonEmbeddable",function(e,videoId,message){console.log("error.yt.contentNonEmbeddable"),e.preventDefault(),$scope.article.visibility="YTContentNA"}),$scope.$on("error.yt.retryInAWhile",function(e,videoId,message){console.log("error.yt.retryInAWhile"),e.preventDefault()}),$scope.$on("error.yt.contentUnavailable",function(e,videoId,message){console.log("error.yt.contentUnavailable"),e.preventDefault(),$scope.article.visibility="YTContentNA",$mixpanel.track("NarrativeEvent",{event_name:"YTContentNA",narrative_id:article._id,narrative_title:article.title,visibility:article.visibility,author_name:article.user.username,user_id:Global.user?Global.user._id:"<anonymous>",narrative_challenges:article.challenges.map(function(obj){return obj.key})})}),$scope.$on("error.yt.badRequest",function(e,videoId,message){console.log("error.yt.badRequest"),e.preventDefault()}),$scope.$on("error.yt.internal",function(e,videoId,message){console.log("error.yt.internal"),e.preventDefault()}),$scope.hotkeypause=0,$scope.$on("hotkeypause",function(e,event){$scope.hotkeypause++}),isMobile.phone||setTimeout(function(){adjustVideoOnScroll()},600);var adjustVideoOnScroll=function(){var isSmallVideo=!1,hasElement=angular.element("#media-player-parent");if(hasElement&&hasElement.length){var placeHolderHeight=0,playerHeight=$(".media-player").outerHeight(),controllerHeight=$(".media-controlbar").outerHeight();placeHolderHeight=playerHeight+controllerHeight,$(window).scroll(function(){$(this).scrollTop()>placeHolderHeight-150&&($("#media-player-parent").addClass("videofixtop"),$("#player-placeholder").height(placeHolderHeight),isSmallVideo||($scope.$broadcast("smallVideoOnScroll",{caller:"ViewController"}),isSmallVideo=!0)),$(this).scrollTop()<placeHolderHeight-150&&($("#media-player-parent").removeClass("videofixtop"),$("#player-placeholder").height("0px"),isSmallVideo&&($scope.$broadcast("smallVideoOnScroll",{caller:"ViewController"}),isSmallVideo=!1))})}}}])}();
!function(){"use strict";angular.module("mean.articles").controller("YtContentNAController",["$rootScope","$scope","$mixpanel",function($rootScope,$scope,$mixpanel){$mixpanel.track("PageView",{page_name:"YTContentNA"}),$rootScope.$emit("showListHeader")}])}();
!function(){window.testSegments=[{states:[{mts:0,mte:0,seg:0,lp:{action:"change",type:"text",text:"hello nr8"},rp:{action:"change",page:1,type:"text",text:"hello nr8"}}]}]}();
!function(){"use strict";angular.module("mean.articles").directive("animationSelection",function($rootScope,YT_ANIMATION_CONFIG,IMAGE_ANIMATION_CONFIG,TEXT_ANIMATION_CONFIG){return{templateUrl:"articles/views/directive-animationSelection.html",transclude:!0,restrict:"E",scope:!0,link:function(scope,element,attrs){var animationConfig=YT_ANIMATION_CONFIG;"image"===attrs.segmenttype?animationConfig=IMAGE_ANIMATION_CONFIG:"text"===attrs.segmenttype&&(animationConfig=TEXT_ANIMATION_CONFIG);var type=attrs.type||"in",inIndex=0,outIndex=0;animationConfig.inNoneIndex&&(inIndex=animationConfig.inNoneIndex),animationConfig.outNoneIndex&&(outIndex=animationConfig.outNoneIndex),scope.animations="in"===type?animationConfig.in:animationConfig.out;var animationKey="in"===type?animationConfig.in[inIndex]:animationConfig.out[outIndex];attrs.animation&&(animationKey=JSON.parse(attrs.animation));var init=!0;scope.animation=_.find(scope.animations,function(a){return a.id===animationKey.id}),scope.animation||(scope.animation=animationKey,scope.animations.push(scope.animation)),scope.$watch("animation",function(){!0===init?init=!1:scope.$emit("animationUpdate",type,_.cloneDeep(scope.animation))})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("annotation",function($rootScope){return{templateUrl:"articles/views/directive-annotation.html",transclude:!0,restrict:"E",link:function(scope,element,attrs){var elem=angular.element(".annotation",element),resizeAnnotationFont=function(containerWidth){var fontSize,container=element.closest(".media-annotation"),containerHeight=.06*container.width();isNaN(containerWidth)&&(containerWidth=container.width()),fontSize=.018*containerWidth,$(window).width()<500&&containerWidth<500&&(fontSize=.022*containerWidth),fontSize>14&&(fontSize=14);var textLength=elem.text().length,inlineFontSize=!1;textLength<60&&textLength>0&&(fontSize+=fontSize-fontSize*((textLength+40)/100),inlineFontSize=!0),inlineFontSize?elem.addClass("inline-fontsize"):elem.removeClass("inline-fontsize"),elem.css({"font-size":fontSize,"line-height":containerHeight/2*.95+"px"})};$(window).on("resize",function(){resizeAnnotationFont()});var applyAnnotationText=function(text){scope.annotationText=text,text.length?scope.annotationNonEmpty=!0:scope.annotationNonEmpty=!1,resizeAnnotationFont()};applyAnnotationText(attrs.coverannotation||""),scope.$on("annotationUpdate",function(e,event){switch(event.update){case"text":applyAnnotationText(event.annotationText);break;default:console.log("Not sure what : annotationUpdate inside annotation directive.")}})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("annotationInput",function($rootScope,YT_ANIMATION_CONFIG,Nr8Composer,$timeout){return{restrict:"AE",transclude:!0,templateUrl:"articles/views/directive-annotation-input.html",scope:!1,link:function(scope,element,attrs){function roundTime(time){return parseFloat(time.toFixed(1))}var addOrEditState=null;scope.setAnnotationHelperText=function(){var hasAnnotatedArea=Nr8Composer.hasAnnotatedArea(segmentNr8),hasNonAnnotatedArea=Nr8Composer.hasNonAnnotatedArea(segmentNr8);return hasAnnotatedArea&&hasNonAnnotatedArea?"Hover on an existing annotation to play, edit, or delete it. Or click on grey portion to add another annotation.":hasAnnotatedArea&&!hasNonAnnotatedArea?"Hover on an annotation to play, edit, or delete it.":!hasAnnotatedArea&&hasNonAnnotatedArea?"Click anywhere on the grey colored bar.":void 0};var segmentNr8=_.cloneDeep(scope.segmentNr8);scope.annotationHelper=scope.setAnnotationHelperText(),scope.addAnnotation=function(annotationText){if(0===annotationText.length)return void console.log("The annotation text cannot be empty.");scope.annotationHelperOffset=15,scope.twoArrows=!1,scope.$emit("addAnnotationToSegment",{addOrEditState:addOrEditState,mts:scope.annotationTimes.mts,mte:scope.annotationTimes.mte,annotationText:annotationText,caller:"annotationInput"}),scope.annotationText=""},scope.playSelection=function(){scope.$broadcast("playSelection")},scope.cancelAnnotationInput=function(){scope.annotationHelperOffset=15,scope.twoArrows=!1,scope.oneArrow=!1,scope.$broadcast("stateUnselected",{caller:"SegmentCreationController"}),scope.annotationText="",scope.annotationHelper=scope.setAnnotationHelperText()},scope.$on("addAnnotationState",function(e,event){event.twoArrows?(scope.oneArrow=!1,scope.twoArrows=!0,scope.annotationHelper="Enter your annotation. You can also drag arrows to new positions."):(scope.twoArrows=!1,scope.oneArrow=!0,scope.annotationHelper="Click bar again to place a second arrow or drag the current one to a new position. Arrows indicate where your annotation starts and ends."),scope.buttonText="Add Annotation",addOrEditState=event.state,scope.annotationText="",scope.noAnnotationText=!0,resizeAnnotationFont(),scope.$$phase||scope.$apply(),resizeAnnotationFont()});var resizeAnnotationFont=function(containerWidth){var fontSize,elem=angular.element(".annotation",element),container=element.closest(".media-annotation"),containerHeight=.06*container.width();isNaN(containerWidth)&&(containerWidth=container.width()),fontSize=.018*containerWidth,$(window).width()<500&&containerWidth<500&&(fontSize=.022*containerWidth),fontSize>14&&(fontSize=14),elem.css({"font-size":fontSize,"line-height":containerHeight/2*.95+"px"})};resizeAnnotationFont(),$(window).on("resize",function(){resizeAnnotationFont()}),scope.annotationTextChange=function(annotationText){scope.annotationText=annotationText,scope.noAnnotationText=""===annotationText},scope.$on("editAnnotationsInitialized",function(e,event){!scope.showNr8||void 0!==scope.showAnnotationControls&&!0!==scope.showAnnotationControls||scope.$broadcast("statesForEditAnnotations",segmentNr8.states)}),scope.$on("editAnnotationState",function(e,event){scope.noAnnotationText=!1,scope.buttonText="Update Annotation",addOrEditState=event.state,scope.annotationText=segmentNr8.states[addOrEditState].rp.text,scope.twoArrows=!0,scope.annotationHelper="Edit your annotation. You can also drag arrows to new positions.",resizeAnnotationFont(),scope.$$phase||scope.$apply(),resizeAnnotationFont()});scope.$on("editAnnotationStateCancel",function(e,event){scope.cancelAnnotationInput(),scope.annotationHelper=scope.setAnnotationHelperText()}),scope.$on("annotationTimeUpdate",function(e,event){if(scope.annotationTimes={mts:roundTime(event.mts),mte:roundTime(event.mte)},event.overflow>0)scope.annotationHelperOffset=15+event.overflow;else{if(15===scope.annotationHelperOffset)return;scope.annotationHelperOffset=15}scope.$$phase||scope.$apply()}),scope.$on("Nr8Updated",function(e,event){segmentNr8=_.cloneDeep(scope.segmentNr8),scope.annotationHelper=scope.setAnnotationHelperText()})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("articleList",function($rootScope,$state,$timeout){return{templateUrl:"articles/views/directive-articleList.html",transclude:!0,restrict:"E",replace:!0,scope:{articles:"=",analytics:"="},link:function(scope,element,attrs){scope.infiniteScroll=!!attrs.hasOwnProperty("useInfiniteScroll")&&"true"===attrs.useInfiniteScroll,scope.maxColumns=parseInt(attrs.maxcolumns)||4,scope.columnClearClass="col-clear-1234",3===scope.maxColumns&&(scope.columnClearClass="col-clear-1233"),scope.visibleArticles=[];var initialized=!1,clonedArticles=_.cloneDeep(scope.articles);scope.addMoreItems=function(){Array.prototype.push.apply(scope.visibleArticles,_.take(clonedArticles,16)),clonedArticles=_.drop(clonedArticles,16)},initialized||(scope.addMoreItems(),initialized=!0),$(window).scroll(function(){$(window).scrollTop()+$(window).height()==$(document).height()&&scope.addMoreItems()})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("articleSlider",function($rootScope,$state,$timeout,PLAYER_CONFIG){return{templateUrl:"articles/views/directive-articleSlider.html",transclude:!0,restrict:"E",replace:!0,scope:{articles:"=",issearch:"=",analytics:"="},link:function(scope,element,attrs){function getSliderNum(){return Math.floor(element.get(0).clientWidth/270)}scope.slider={},scope.slider.list=scope.articles,scope.slider.currentSlider=0,scope.slider.currentSlider=0,scope.slider.scrollTo=function(num){var style="translateX("+270*-num+"px )";scope.slider.transform={transform:style,"-webkit-transform":style,"-ms-transform":style}},scope.slider.scrollLeft=function(){scope.slider.currentSlider<1||(scope.slider.currentSlider-=getSliderNum(),scope.slider.currentSlider<0&&(scope.slider.currentSlider=0),scope.slider.scrollTo(scope.slider.currentSlider))},scope.slider.scrollRight=function(){if(scope.articles.length>scope.slider.currentSlider){var slider_num=getSliderNum();if(scope.slider.currentSlider+=slider_num,scope.slider.currentSlider+slider_num>scope.articles.length){var a=scope.slider.currentSlider+slider_num-scope.articles.length;scope.slider.currentSlider-=a}scope.slider.scrollTo(scope.slider.currentSlider)}}}}})}();
!function(){"use strict";angular.module("mean.articles").directive("articleThumbnail",function($rootScope,$state,$timeout,PLAYER_CONFIG){return{templateUrl:"articles/views/directive-articleThumbnail.html",transclude:!0,restrict:"E",replace:!0,scope:{article:"=",issearch:"=",analytics:"="},link:function(scope,element,attrs){scope.article.hasOwnProperty("visibility")||(scope.article.visibility="Public"),scope.articleStatus={isExceptional:!1};var setExceptionalArticleStatus=function(icon,text){scope.articleStatus.isExceptional=!0,scope.articleStatus.icon=icon,scope.articleStatus.text=text};switch(scope.article.visibility){case"Pre-suspension":case"Suspension":setExceptionalArticleStatus("status-suspension","SUSPENDED");break;case"Post-suspension":setExceptionalArticleStatus("status-under-review","UNDER REVIEW");break;case"YTContentNA":setExceptionalArticleStatus("status-content-missing","YouTube source not available")}scope.isIE=/MSIE (\d+\.\d+);/.test(navigator.userAgent)||-1!==navigator.appVersion.indexOf("Trident"),scope.isGif=!1;var gif,shownGifOnce,isHover=!1;scope.article.metadata&&scope.article.metadata.gif&&(gif=scope.article.metadata.gif,gif.image&&gif.enable&&(scope.isGif=gif.showAlways)),scope.showThumbnailGif=function(){if(gif&&gif.enable&&(isHover=!0,!gif||!gif.showAlways))if(gif&&!gif.showAlways){var img=element.find("img.hiddenImage").get(0);img||(img=new Image),img.src=gif.image,scope.loadingGif=!0,img.onload=function(){isHover&&(shownGifOnce=!0,scope.loadingGif=!1,scope.isGif=!0)},shownGifOnce?img.onload():$timeout(function(){img.onload()},2e3)}else scope.isGif=!0},scope.hideThumbnailGif=function(){gif&&gif.enable&&(isHover=!1,gif&&gif.showAlways||(scope.loadingGif=!1,scope.isGif=!1))},scope.showPlayer=!1,scope.analyticsContext=_.merge(scope.analytics,{narrativeId:scope.article._id}),scope.articleLink="narratives/"+scope.article._id,["Public","Private"].indexOf(scope.article.visibility)<0&&(scope.articleLink=scope.articleLink+"/edit/create"),PLAYER_CONFIG.setPlayerConfig(),scope.searchSnippetPreviewSupported=PLAYER_CONFIG.isSearchSnippetPreviewSupported(),!0===scope.searchSnippetPreviewSupported&&(scope.numberOfPlayers=PLAYER_CONFIG.getNumberOfPlayers(),scope.isAndroid=PLAYER_CONFIG.isAndroid(),scope.iOSApp=PLAYER_CONFIG.isIOSApp(),scope.iOS10=PLAYER_CONFIG.isIOS10()),scope.mouseOverAnnotation=function(annotationJson){scope.annotationNr8=annotationJson,!0===scope.searchSnippetPreviewSupported&&(scope.showPlayer=!0)},scope.mouseOutAnnotation=function(){scope.showPlayer=!1},scope.gotoAnnotation=function(articleId,startTime,page){$state.go("article_view",{articleId:articleId,seekTo:startTime})}}}})}();
!function(){"use strict";angular.module("mean.articles").directive("audioStatePlayer",function(){return{transclude:!0,restrict:"E",link:function(scope,element,attrs,fullscreenCtrl){var track,trackPath=scope.audioKeys[0];window.tempScope=scope;var notifyOfAudioEvent=function(eventName,audioKey){return function(e){scope.$emit("audio."+eventName,{audioKey:audioKey})}},loadTrack=function(path,seekTime){track=new Audio,track.addEventListener("canplay",notifyOfAudioEvent("canplay",path)),track.addEventListener("ended",notifyOfAudioEvent("ended",path)),track.addEventListener("timeupdated",function(e){console.log("Audio track",path,"has updated",e)}),track.src=path,track.currentTime=seekTime,trackPath=path};loadTrack(trackPath,0),scope.$on("audio.play",function(e,audioFile,seekTime){console.log("audioFile, seekTime : ",audioFile,seekTime),track.play()}),scope.$on("audio.stop",function(e,audioFile){track.paused||track.pause()}),scope.$on("audio.seek",function(e,audioFile,seekTimeSeconds){audioFile!==trackPath?loadTrack(audioFile,seekTimeSeconds):track.currentTime=seekTimeSeconds}),scope.$on("audio.stopAll",function(e){track.paused||track.pause()}),scope.$on("audio.volume",function(e,audioFile,volumePercent){track.volume=volumePercent/100}),scope.$on("audio.fade",function(e,audioFile,fromVolume,toVolume,duration){console.log("GOT audio.fade but will not do anything")}),scope.$on("audio.volumeAll",function(e,volumePercent){track.volume=volumePercent/100*scope.masterVolumeMultiplier});scope.$on("nr8ControlUpdate",function(e,event){switch(event.update){case"timeUpdate":case"progressAndTimeUpdate":break;default:console.log("Not sure what : nr8ControlUpdate inside audio-state-player directive.")}})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("nr8Audio",function(){return{templateUrl:"articles/views/directive-audio.html",transclude:!0,restrict:"E",scope:{path:"="},link:function(scope,element,attrs,fullscreenCtrl){console.log(scope.file),scope.path=scope.path}}})}();
!function(){"use strict";angular.module("mean.articles").directive("audioTransitionSelection",function($rootScope,YT_AUDIOTRANSITION_CONFIG){return{templateUrl:"articles/views/directive-audioTransitionSelection.html",transclude:!0,restrict:"E",scope:!0,link:function(scope,element,attrs){var audioTransitionConfig=YT_AUDIOTRANSITION_CONFIG,type=attrs.type||"in",inIndex=0,outIndex=0;audioTransitionConfig.inNoneIndex&&(inIndex=audioTransitionConfig.inNoneIndex),audioTransitionConfig.outNoneIndex&&(outIndex=audioTransitionConfig.outNoneIndex),scope.audioTransitions="in"===type?audioTransitionConfig.in:audioTransitionConfig.out;var audioTransitionKey="in"===type?audioTransitionConfig.in[inIndex]:audioTransitionConfig.out[outIndex];attrs.audiotransition&&(audioTransitionKey=JSON.parse(attrs.audiotransition));var init=!0;scope.audioTransition=_.find(scope.audioTransitions,function(a){return a.id===audioTransitionKey.id}),scope.audioTransition||(scope.audioTransition=audioTransitionKey,scope.audioTransitions.push(scope.scope.audioTransition)),scope.$watch("audioTransition",function(){!0===init?init=!1:scope.$emit("audioTransitionUpdate",type,_.cloneDeep(scope.audioTransition))})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("enableComments",["$window","$timeout",function($window,$timeout){return{restrict:"A",scope:"=",template:'<div ng-if="enablecomments" disqus="article._id"></div>',link:function(scope,element,attrs){function enableComments(isScrolling){!scope.enablecomments&&(scope.isDelayExceeded||isScrolling)&&isInViewport(element)&&(scope.enablecomments=!0,scope.$$phase||scope.$apply())}scope.isDelayExceeded=!1,$timeout(function(){scope.isDelayExceeded=!0,enableComments()},1e3),scope.enablecomments=!0}}}])}();
!function(){"use strict";angular.module("mean.articles").directive("focusOnHover",["$timeout",function($timeout){return{restrict:"A",scope:"=",link:function(scope,element,attrs){element.on("mouseover",function(e){var input=angular.element(this);if(input.is(":input"))return void input.focus();input.find("input").eq(0).focus()})}}}])}();
!function(){"use strict";angular.module("mean.articles").directive("menuDropdown",["$window","$timeout",function($window,$timeout){return{restrict:"A",scope:"=",link:function(scope,element,attrs){var parent=element.parent();parent.children(".item-title").eq(0).on("click",function(e){parent.toggleClass("open")}),element.on("click","a:not([dummylink])",function(e){e.stopPropagation(),parent.removeClass("open"),scope.searchTopic=""}),angular.element(document).on("click",function(e){0==angular.element(e.target).closest(parent).length&&(parent.removeClass("open"),scope.searchTopic="")}),element.is("[visible-on-scroll]")||angular.element($window).bind("scroll",function(){parent.removeClass("open"),scope.searchTopic=""})}}}])}();
!function(){!function(angular,window){"use strict";var disqusModule=angular.module("mean.articles");disqusModule.provider("$disqus",function(){function getScriptContainer(){return document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]}function getShortname(){return shortname||window.disqus_shortname}function getScriptSrc(shortname,file){return"//"+shortname+".disqus.com/"+file}function buildScriptTag(src){var script=document.createElement("script");return script.type="text/javascript",script.async=!0,script.src=src,script}function hasScriptTagInPlace(container,scriptSrc){var script,i,scripts=container.getElementsByTagName("script");for(i=0;i<scripts.length;i+=1)if(script=scripts[i],~script.src.indexOf(scriptSrc))return!0;return!1}function setGlobals(id,url,shortname){window.disqus_identifier=id,window.disqus_url=url,window.disqus_shortname=shortname}function getCount(){var widgets=window.DISQUSWIDGETS;widgets&&angular.isFunction(widgets.getCount)&&widgets.getCount()}function resetCommit($location,id){window.DISQUS.reset({reload:!0,config:function(){this.page.identifier=id,this.page.url=$location.absUrl()}})}function addScriptTag(shortname,type){var container=getScriptContainer(),scriptSrc=getScriptSrc(shortname,type);hasScriptTagInPlace(container,scriptSrc)||container.appendChild(buildScriptTag(scriptSrc))}var shortname,TYPE_EMBED="embed.js",TYPE_COUNT="count.js";this.setShortname=function(sname){shortname=sname},this.$get=["$location",function($location){function commit(id){var shortname=getShortname();if(!angular.isDefined(shortname))throw new Error("No disqus shortname defined");if(!angular.isDefined(id))throw new Error("No disqus thread id defined");angular.isDefined(window.DISQUS)?resetCommit($location,id):(setGlobals(id,$location.absUrl(),shortname),addScriptTag(shortname,TYPE_EMBED))}function loadCount(id){setGlobals(id,$location.absUrl(),shortname),addScriptTag(getShortname(),TYPE_EMBED),addScriptTag(getShortname(),TYPE_COUNT),getCount()}return{commit:commit,getShortname:getShortname,loadCount:loadCount}}]}),disqusModule.directive("disqus",["$disqus",function($disqus){return{restrict:"AC",replace:!0,scope:{id:"=disqus"},template:'<div id="disqus_thread"></div>',link:function(scope){scope.$watch("id",function(id){angular.isDefined(id)&&$disqus.commit(id)})}}}]),disqusModule.directive("disqusIdentifier",["$disqus",function($disqus){return{restrict:"A",link:function(scope,elem,attr){$disqus.loadCount(attr.disqusIdentifier)}}}])}(angular,this)}();
!function(){"use strict";angular.module("mean.articles").directive("editAnnotations",function($rootScope,$timeout){return{template:'<div class = "edit_annotations_class"> </div>',transclude:!0,restrict:"E",link:function(scope,element,attrs){function updateEditWidth(){totalWidth=sizeIndicator[0][0].getBBox().width,editWidth=totalWidth-2*editMargin}function getXposFromPercentString(percentString){return parseFloat(percentString.substring(0,percentString.length-1))*totalWidth/100}function getArrowTipXpos(arrow){return parseFloat(arrow.attr("x").substring(0,arrow.attr("x").length-1))*totalWidth/100+arrowWidth/2}function getPercentAtXpos(xpos){return(100*xpos/totalWidth).toString()+"%"}function getTimeAtXPosition(xpos){return(xpos-editMargin)/editWidth*duration}function startTimerHoveredLongEnough(){timerHoveredLongEnough=$timeout(function(){hoveredLongEnough=!0,!1===isPlaying&&moveMarkerFamily(lastMousePosition)},timerDurationHoveredLongEnough)}function startTimerCancelHoveredLongEnough(){timerCancelHoveredLongEnough=$timeout(function(){hoveredLongEnough=!1},timerDurationCancelHoveredLongEnough)}function onclickAnnotationPlay(){var startTime=getTimeAtXPosition(getXposFromPercentString(stateRectangles[stateMousedOver].attr("x")));stopTime=getTimeAtXPosition(getXposFromPercentString(stateRectangles[stateMousedOver].attr("x"))+getXposFromPercentString(stateRectangles[stateMousedOver].attr("width"))),scope.$emit("intentChange",{intent:"externalSeekRequest",seekToSeconds:startTime,caller:"editAnnotations"}),scope.$emit("intentChange",{intent:"play",caller:"editAnnotations"})}function onclickEdit(){stateBeingEdited=stateMousedOver,solidArrow1=drawArrow(getXposFromPercentString(stateRectangles[stateBeingEdited].attr("x")),!1),solidArrow2=drawArrow(getXposFromPercentString(stateRectangles[stateBeingEdited].attr("x"))+getXposFromPercentString(stateRectangles[stateBeingEdited].attr("width")),!1),drawSelectionRectangle(!1),refreshInputs(),emitAnnotationTime(),removeEditMenu(),scope.$emit("editAnnotationState",{state:stateBeingEdited,caller:"editAnnotations"})}function onclickDelete(){stateBeingEdited=stateMousedOver,removeEditMenu(),scope.$emit("deleteAnnotation",{state:stateBeingEdited,caller:"editAnnotations"})}function onclickPlaySelection(){var startTime=getTimeAtXPosition(getArrowTipXpos(solidArrow1));null===solidArrow2?(stopTime=null,states.forEach(function(state){if(!stopTime&&state.mte>=startTime)return void(stopTime=state.mte)})):getArrowTipXpos(solidArrow1)<=getArrowTipXpos(solidArrow2)?stopTime=getTimeAtXPosition(getArrowTipXpos(solidArrow2)):(startTime=getTimeAtXPosition(getArrowTipXpos(solidArrow2)),stopTime=getTimeAtXPosition(getArrowTipXpos(solidArrow1))),scope.$emit("intentChange",{intent:"externalSeekRequest",seekToSeconds:startTime,caller:"editAnnotations"}),scope.$emit("intentChange",{intent:"play",caller:"editAnnotations"})}function redrawMarkerBg(){markerBg&&(markerBg.remove(),markerBg=null),markerBg=editAnnotationsSVG.append("svg:rect").attr("x",editMargin).attr("y",0).attr("width",editWidth).attr("height",markerElementsHeight).attr("fill",markerBgColorBlue)}function removeStates(){stateRectangles=[],editAnnotationsSVG.selectAll("rect").remove(),redrawMarkerBg()}function resetEditGlobals(){isPlaying&&scope.$emit("intentChange",{intent:"pause",caller:"editAnnotations"}),redrawMarkerBg(),removeDimArrow(),removeSolidArrows(),removeSelectionRectangle(),removeSelectionMenu(),stateMousedOver=null,stateBeingEdited=null,psText.text(function(){return""})}function removeInputs(){editAnnotationsSVG.selectAll(function(){return this.getElementsByTagName("foreignObject")}).remove()}function removeSelectionRectangle(){null!==selectionRectangle&&(selectionRectangle.remove(),selectionRectangle=null)}function refreshInputs(){if(removeInputs(),null===solidArrow2)drawArrowInput(solidArrow1,!0);else{var solidArrow1IsLeft=getArrowTipXpos(solidArrow1)<=getArrowTipXpos(solidArrow2);drawArrowInput(solidArrow1,solidArrow1IsLeft),drawArrowInput(solidArrow2,!solidArrow1IsLeft)}}function displayDimArrowTime(xpos){null===dimArrowTime?dimArrowTime=editAnnotationsSVG.append("svg:text").attr("font-family","sans-serif").attr("font-size","10px").attr("x",xpos-20).attr("y",markerElementsHeight+editBarHeight+30).text(function(){return getTimeAtXPosition(xpos).humanTime()}):(dimArrowTime.attr("x",xpos-20),dimArrowTime.text(function(){return getTimeAtXPosition(xpos).humanTime()}))}function removeMarkerFamily(){null!==marker&&(marker.remove(),marker=null),null!==markerTime&&(markerTime.remove(),markerTime=null),null!==markerMenu&&(markerMenu.remove(),markerMenu=null)}function moveMarkerFamily(xpos){if(null===marker?marker=editAnnotationsSVG.append("svg:rect").attr("x",xpos).attr("y",markerElementsHeight/2).attr("width",2).attr("height",markerElementsHeight/2).attr("fill","black"):marker.attr("x",xpos),null===markerTime?markerTime=editAnnotationsSVG.append("svg:text").attr("font-family","sans-serif").attr("font-size","10px").attr("x",xpos-24).attr("y",markerElementsHeight-6).text(function(){return getTimeAtXPosition(xpos).humanTime()}):(markerTime.attr("x",xpos-24),markerTime.text(function(){return getTimeAtXPosition(xpos).humanTime()})),!1===isPlaying&&hoveredLongEnough){var startTime=getTimeAtXPosition(xpos);scope.$emit("intentChange",{intent:"externalSeekRequest",seekToSeconds:startTime,caller:"editAnnotations"})}else console.log("ok, delete me. moveMarkerFamily in editAnnotations.")}function startTimerMarkerFamily(){timerMarkerFamily=$timeout(function(){removeMarkerFamily()},timerDurationAddElements)}function drawSelectionRectangle(ifPreSelection){updateEditWidth();var arrow1=solidArrow1,arrow2=solidArrow2,color="#00b8b3";ifPreSelection&&(arrow2=dimArrow,color="#00b8b3");var xposArrow1Tip=getArrowTipXpos(arrow1),xposArrow2Tip=getArrowTipXpos(arrow2),solidArrow1IsLeft=xposArrow1Tip<=xposArrow2Tip,start=solidArrow1IsLeft?xposArrow1Tip:xposArrow2Tip,end=solidArrow1IsLeft?xposArrow2Tip:xposArrow1Tip,startPercent=getPercentAtXpos(start),widthPercent=getPercentAtXpos(end-start);null===selectionRectangle?selectionRectangle=editAnnotationsSVG.append("svg:rect").attr("x",startPercent).attr("y",markerElementsHeight+editBarHeight/2).attr("width",widthPercent).attr("height",editBarHeight/2).attr("fill",color).on("mousemove",function(d){if(lastMousePosition=d3.mouse(this)[0],!1===isPlaying&&moveMarkerFamily(lastMousePosition),ifPreSelection){var xpos=d3.mouse(this)[0];dimArrow.attr("x",getPercentAtXpos(d3.mouse(this)[0]-arrowWidth/2)),isPlaying&&displayDimArrowTime(xpos),drawSelectionRectangle(!0)}}).on("mouseout",function(d){lastMousePosition=null,$timeout.cancel(timerHoveredLongEnough),startTimerCancelHoveredLongEnough(),!1===isPlaying&&startTimerMarkerFamily(),ifPreSelection&&null!==solidArrow1&&null===solidArrow2&&startTimerAddElements()}).on("mouseover",function(d){!isPlaying||ifPreSelection?(console.log("holamolakk"),selectionRectangle.attr("cursor","pointer")):selectionRectangle.attr("cursor","default"),$timeout.cancel(timerCancelHoveredLongEnough),startTimerHoveredLongEnough(),$timeout.cancel(timerMarkerFamily),ifPreSelection&&$timeout.cancel(timerAddElements)}).on("click",function(d){lastMousePosition=d3.mouse(this)[0],!1===isPlaying&&(scope.$emit("intentChange",{intent:"externalSeekRequest",seekToSeconds:getTimeAtXPosition(lastMousePosition),caller:"editAnnotations"}),scope.$emit("intentChange",{intent:"play",caller:"editAnnotations"}),isPlaying=!0,moveMarkerFamily(lastMousePosition)),ifPreSelection&&(solidArrow1&&solidArrow2||annotationTimeSelector(lastMousePosition))}):(selectionRectangle.attr("x",startPercent),selectionRectangle.attr("width",widthPercent))}function drawArrow(xpos,isDim){function getNormalizedXPosition(){var xpos=d3.event.x;return xpos<bound1?xpos=bound1:xpos>bound2&&(xpos=bound2),xpos}updateEditWidth();var xposPercent=getPercentAtXpos(xpos-arrowWidth/2),arrow=editAnnotationsSVG.append("svg:image").attr("x",xposPercent).attr("y",markerElementsHeight+editBarHeight).attr("width",arrowWidth).attr("height",arrowHeight).attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/"+(isDim?"greyArrow":"blueArrow")+".svg").attr("cursor","move");if(!isDim){var bound1State=stateBeingEdited,bound2State=stateBeingEdited;stateBeingEdited>=1&&""===states[stateBeingEdited-1].rp.text&&(bound1State=stateBeingEdited-1),stateBeingEdited<=states.length-2&&""===states[stateBeingEdited+1].rp.text&&(bound2State=stateBeingEdited+1);var bound1=getXposFromPercentString(stateRectangles[bound1State].attr("x")),bound2=getXposFromPercentString(stateRectangles[bound2State].attr("x"))+getXposFromPercentString(stateRectangles[bound2State].attr("width"));arrow.call(d3.behavior.drag().on("drag",function(){var xpos=getNormalizedXPosition();arrow.attr("x",getPercentAtXpos(xpos-arrowWidth/2)),refreshInputs(),null!==solidArrow1&&null!==solidArrow2&&(drawSelectionRectangle(!1),emitAnnotationTime())}))}return arrow}function machineTime(input){var seconds,split=input.split(":");return 3===split.length?seconds=60*+split[0]*60+60*+split[1]+ +split[2]:2===split.length?seconds=60*+split[0]+ +split[1]:1===split.length&&(seconds=+split[0]),seconds}function drawArrowInput(arrow,isLeft){var arrowTipXpos=getArrowTipXpos(arrow),value=getTimeAtXPosition(arrowTipXpos).humanTime(),inputXpos=arrowTipXpos+(isLeft?arrowInputLeftBuffer:arrowInputRightBuffer),inputXPercent=getPercentAtXpos(inputXpos),inputWidthPercent=(100*inputWidth/totalWidth).toString()+"%";editAnnotationsSVG.append("svg:foreignObject").attr("x",inputXPercent).attr("y",arrowInputTopOffset).attr("height",32).attr("width",inputWidthPercent).append("xhtml:body").attr("style","background-color: transparent;").append("input").attr("type","text").attr("style","position : relative; top : 0; background-color: #efefef; border: 1px solid #bbb; font-size: 0.7em; width: 39px; padding: 0 2px;").attr("value",value).on("keypress",function(e){if(13===d3.event.keyCode){var value=angular.element(this).val(),position=editMargin+machineTime(value)*editWidth/duration,bound1=getXposFromPercentString(stateRectangles[stateBeingEdited].attr("x")),bound2=getXposFromPercentString(stateRectangles[stateBeingEdited].attr("x"))+getXposFromPercentString(stateRectangles[stateBeingEdited].attr("width"));bound1<=position&&position<=bound2&&(arrow.attr("x",getPercentAtXpos(position-arrowWidth/2)),refreshInputs(),drawSelectionRectangle(!1),emitAnnotationTime())}})}function removeDimArrow(){null!==dimArrow&&(dimArrow.remove(),dimArrow=null),null!==dimArrowTime&&(dimArrowTime.remove(),dimArrowTime=null)}function removeSolidArrows(){null!==solidArrow1&&(solidArrow1.remove(),solidArrow1=null),null!==solidArrow2&&(solidArrow2.remove(),solidArrow2=null),removeInputs()}function removeEditMenu(){null!==editMenu&&(editMenu.remove(),editMenu=null)}function removeSelectionMenu(){playSelection&&playSelection.remove(),cancelSelection&&cancelSelection.remove(),addAnnotation&&addAnnotation.remove(),selectionMenu=!1}function startTimerEditMenu(){timerEditMenu=$timeout(function(){removeEditMenu()},timerDurationEditMenu)}function startTimerAddElements(){timerAddElements=$timeout(function(){removeDimArrow(),removeSelectionRectangle()},timerDurationAddElements)}function createMenu(xpos,ypos){var menu=editAnnotationsSVG.append("svg:g").attr("transform","translate("+(xpos-10)+", 0)").on("mouseover",function(d){$timeout.cancel(timerEditMenu)}).on("mouseout",function(d){startTimerEditMenu()}),playBox=menu.append("svg:rect").attr("x",0).attr("y",ypos).attr("width",editMenuWidth/3).attr("height",editMenuHeightPerItem).attr("fill","#F5F5F5").on("mouseover",function(d){playBox.attr("fill","black"),play.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/play-small-rollover.svg")}).on("mouseout",function(d){playBox.attr("fill","#F5F5F5"),play.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/play-small.svg")}),editBox=menu.append("svg:rect").attr("x",editMenuWidth/3).attr("y",ypos).attr("width",editMenuWidth/3).attr("height",editMenuHeightPerItem).attr("fill","#F5F5F5").on("mouseover",function(d){editBox.attr("fill","black"),edit.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/edit-small-rollover.svg")}).on("mouseout",function(d){editBox.attr("fill","#F5F5F5"),edit.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/edit-small.svg")}),deleteBox=menu.append("svg:rect").attr("x",2*editMenuWidth/3).attr("y",ypos).attr("width",editMenuWidth/3).attr("height",editMenuHeightPerItem).attr("fill","#F5F5F5").on("mouseover",function(d){deleteBox.attr("fill","black"),deleteIcon.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/delete-small-rollover.svg")}).on("mouseout",function(d){deleteBox.attr("fill","#F5F5F5"),deleteIcon.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/delete-small.svg")}),play=menu.append("svg:a").attr("xlink:href","javascript:void(0)").append("svg:image").attr("x",5).attr("y",ypos).attr("cursor","pointer").attr("width",arrowWidth).attr("height",arrowHeight).attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/play-small.svg").attr("cursor","pointer").on("click",onclickAnnotationPlay).on("mouseover",function(d){playBox.attr("fill","black"),play.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/play-small-rollover.svg")}).on("mouseout",function(d){playBox.attr("fill","#F5F5F5"),play.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/play-small.svg")}),edit=menu.append("svg:a").attr("xlink:href","javascript:void(0)").append("svg:image").attr("x",27).attr("y",ypos).attr("cursor","pointer").attr("width",arrowWidth).attr("height",arrowHeight).attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/edit-small.svg").attr("cursor","pointer").on("click",onclickEdit).on("mouseover",function(d){editBox.attr("fill","black"),edit.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/edit-small-rollover.svg")}).on("mouseout",function(d){editBox.attr("fill","#F5F5F5"),edit.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/edit-small.svg")}),deleteIcon=menu.append("svg:a").attr("xlink:href","javascript:void(0)").append("svg:image").attr("x",50).attr("y",ypos).attr("cursor","pointer").attr("width",arrowWidth).attr("height",arrowHeight).attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/delete-small.svg").attr("cursor","pointer").on("click",onclickDelete).on("mouseover",function(d){deleteBox.attr("fill","black"),deleteIcon.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/delete-small-rollover.svg")}).on("mouseout",function(d){deleteBox.attr("fill","#F5F5F5"),deleteIcon.attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/delete-small.svg")});return menu}function emitAnnotationTime(){var solidArrow1Xpos=getArrowTipXpos(solidArrow1),solidArrow2Xpos=getArrowTipXpos(solidArrow2),solidArrow1IsLeft=solidArrow1Xpos<=solidArrow2Xpos,start=solidArrow1IsLeft?solidArrow1Xpos:solidArrow2Xpos,end=solidArrow1IsLeft?solidArrow2Xpos:solidArrow1Xpos,overflow=0;end+arrowInputRightBuffer+39>totalWidth-editMargin&&(overflow=end+arrowInputRightBuffer+39-(totalWidth-editMargin)),scope.$emit("annotationTimeUpdate",{mts:getTimeAtXPosition(start),mte:getTimeAtXPosition(end),overflow:overflow,caller:"editAnnotations"})}function annotationTimeSelector(xpos){console.log("inside annotationTimeSelector");var twoArrows=!1;null===solidArrow1?(removeDimArrow(),solidArrow1=drawArrow(xpos,!1)):null===solidArrow2&&(removeDimArrow(),solidArrow2=drawArrow(xpos,!1)),solidArrow1&&solidArrow2&&(removeSelectionRectangle(),drawSelectionRectangle(!1),twoArrows=!0,emitAnnotationTime()),scope.$emit("addAnnotationState",{state:stateBeingEdited,twoArrows:twoArrows,caller:"editAnnotations"}),refreshInputs()}function drawStateFill(state,startTime,endTime){var colors,colorcode,id="state"+state,startPercent=getPercentAtXpos(editMargin+editWidth*startTime/duration),widthPercent=getPercentAtXpos(editWidth*(endTime-startTime)/duration);""===states[state].rp.text?colors=["grey","grey"]:(nonEmptyStateCount++,colorcode=nonEmptyStateCount%2,0===colorcode?colors=["#11d6d2","grey"]:1===colorcode&&(colors=["#2fede9","grey"]));var stateFill=editAnnotationsSVG.append("svg:rect").attr("id",id).attr("x",startPercent).attr("y",markerElementsHeight).attr("width",widthPercent).attr("height",editBarHeight).attr("fill",colors[0]).on("mouseover",function(d){stateMousedOver=state,$timeout.cancel(timerCancelHoveredLongEnough),startTimerHoveredLongEnough(),$timeout.cancel(timerMarkerFamily),$timeout.cancel(timerEditMenu),""!==states[state].rp.text?(isPlaying?stateFill.attr("cursor","default"):stateFill.attr("cursor","pointer"),null===solidArrow1&&(removeEditMenu(),editMenu=createMenu(d3.mouse(this)[0],markerElementsHeight+editMenuYOffset))):(isPlaying&&null!==solidArrow2?stateFill.attr("cursor","default"):stateFill.attr("cursor","pointer"),removeEditMenu(),null===solidArrow1?console.log("Click to return to annotation."):console.log("Click again to add annotation.."))}).on("mousemove",function(d){if(lastMousePosition=d3.mouse(this)[0],!1===isPlaying&&moveMarkerFamily(lastMousePosition),null!==editMenu&&editMenu.attr("transform","translate("+(lastMousePosition-10)+", 0)"),""===states[state].rp.text&&null===solidArrow2&&(null===stateBeingEdited||stateBeingEdited===state)){var xpos=lastMousePosition;isPlaying&&displayDimArrowTime(xpos),null===dimArrow?dimArrow=drawArrow(xpos-arrowWidth/2,!0):dimArrow.attr("x",getPercentAtXpos(xpos-arrowWidth/2)),null!==solidArrow1&&drawSelectionRectangle(!0)}}).on("mouseout",function(d){lastMousePosition=null,$timeout.cancel(timerHoveredLongEnough),startTimerCancelHoveredLongEnough(),startTimerEditMenu(),!1===isPlaying&&startTimerMarkerFamily(),null!==dimArrow&&startTimerAddElements()}).on("click",function(){lastMousePosition=d3.mouse(this)[0],!1===isPlaying&&(scope.$emit("intentChange",{intent:"externalSeekRequest",seekToSeconds:getTimeAtXPosition(lastMousePosition),caller:"editAnnotations"}),scope.$emit("intentChange",{intent:"play",caller:"editAnnotations"}),isPlaying=!0,moveMarkerFamily(lastMousePosition)),""===states[state].rp.text&&(null===stateBeingEdited&&(stateBeingEdited=state),stateBeingEdited===state&&null===solidArrow2&&(stateBeingEdited=state,annotationTimeSelector(lastMousePosition),removeEditMenu()))});stateRectangles[state]=stateFill}function redraw(){promise=setTimeout(function(){resetEditGlobals(),0!==duration&&(removeStates(),updateEditWidth(),redrawMarkerBg(),nonEmptyStateCount=0,states.forEach(function(state,i){drawStateFill(i,state.mts,state.mte)}))},1e3)}scope.context=attrs.context||"edit";var duration=0,states=null,sizeIndicator=null,totalWidth=0,editWidth=0,editMargin=50,markerElementsHeight=15,editBarHeight=16,editMenuYOffset=15,editMenuWidth=70,editMenuHeightPerItem=25,arrowWidth=15,arrowHeight=22,timerDurationEditMenu=2e3,timerDurationAddElements=50,editAnnotationsSVG=null,editAnnotationsContainer=null,dimArrow=null,dimArrowTime=null,solidArrow1=null,solidArrow2=null,selectionRectangle=null,timerAddElements=null,timerMarkerFamily=null,arrowInputLeftBuffer=-49,arrowInputRightBuffer=12,inputWidth=32,arrowInputTopOffset=markerElementsHeight+editBarHeight,stateRectangles=[],stateMousedOver=null,stateBeingEdited=null,marker=null,markerBg=null,markerBgColorBlue="#bdfcfb",markerTime=null,markerMenu=null,editMenu=null,timerEditMenu=null,selectionMenu=!1,playSelection=null,cancelSelection=null,addAnnotation=null,stopTime=null,isPlaying=!1,promise=null,hoveredLongEnough=!1,timerHoveredLongEnough=null,timerCancelHoveredLongEnough=null,timerDurationHoveredLongEnough=500,timerDurationCancelHoveredLongEnough=50,lastMousePosition=null,nonEmptyStateCount=0,psText=null;editAnnotationsContainer=d3.select(element[0]),editAnnotationsSVG=editAnnotationsContainer.select(".edit_annotations_class").append("svg:svg").attr("width","100%").attr("height",53),sizeIndicator=editAnnotationsSVG.append("svg:line").attr("x1",0).attr("y1",0).attr("x2","100%").attr("y2",0).attr("fill","white"),psText=editAnnotationsSVG.append("svg:text").attr("font-family","sans-serif").attr("font-size","15px").attr("x",editMargin).attr("y",115).text(function(){return""}),setTimeout(function(){scope.$emit("editAnnotationsInitialized",{caller:"editAnnotations"})},1e3),scope.$on("statesForEditAnnotations",function(e,newStates){duration=newStates[newStates.length-1].mte,states=newStates,redraw()}),scope.$on("statesForEditFromSource",function(e,newStates){states=null,resetEditGlobals(),removeStates()}),scope.$on("stateUnselected",function(e,event){resetEditGlobals()}),scope.$on("hidingEditAnnotations",function(e,event){console.log("Hiding editAnnotations from YALL----------- "),resetEditGlobals(),removeStates()}),scope.$on("playSelection",function(e,event){onclickPlaySelection()}),scope.$on("nr8IntentUpdate",function(e,event){switch(event.update){case"playing":isPlaying=!0;break;case"ended":case"paused":isPlaying=!1,startTimerMarkerFamily();break;default:console.log("Not sure what : nr8IntentUpdate inside editAnnotations directive.")}}),scope.$on("nr8ControlUpdate",function(e,event){switch(event.update){case"timeUpdate":case"progressUpdate":break;case"progressAndTimeUpdate":if(isPlaying=!0,0!==duration){var xpos=editMargin+event.progressPercent*editWidth/100;moveMarkerFamily(xpos),stopTime&&getTimeAtXPosition(xpos)>=stopTime&&(scope.$emit("intentChange",{intent:"pause",caller:"editAnnotations"}),stopTime=null)}break;default:console.log("Not sure what : nr8ControlUpdate inside editAnnotations directive.")}});var uniqueDirectiveId=(Math.random()+"").slice(2)+"_"+scope.$id;$(window).on("resize."+uniqueDirectiveId,function(){states&&($timeout.cancel(promise),console.log("Resize inside editAnnotations"),scope.$emit("editAnnotationStateCancel",{caller:"editAnnotations"}),redraw())}),scope.$on("$destroy",function(){console.log("Destroying the resize event inside editFromSource"),$(window).off("resize."+uniqueDirectiveId)})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("editFromSource",function($rootScope,$timeout){return{template:'<div class = "edit_annotations_class"> </div>',transclude:!0,restrict:"E",link:function(scope,element,attrs){function updateEditWidth(){totalWidth=sizeIndicator[0][0].getBBox().width,editWidth=totalWidth-2*editMargin}function getXposFromPercentString(percentString){return parseFloat(percentString.substring(0,percentString.length-1))*totalWidth/100}function getArrowTipXpos(arrow){return parseFloat(arrow.attr("x").substring(0,arrow.attr("x").length-1))*totalWidth/100+arrowWidth/2}function getPercentAtXpos(xpos){return(100*xpos/totalWidth).toString()+"%"}function getTimeAtXPosition(xpos){return(xpos-editMargin)/editWidth*duration}function startTimerHoveredLongEnough(){timerHoveredLongEnough=$timeout(function(){hoveredLongEnough=!0,!1===isPlaying&&moveMarkerFamily(lastMousePosition)},timerDurationHoveredLongEnough)}function startTimerCancelHoveredLongEnough(){timerCancelHoveredLongEnough=$timeout(function(){hoveredLongEnough=!1},timerDurationCancelHoveredLongEnough)}function onclickPlaySourceSelection(){var startTime=getTimeAtXPosition(getArrowTipXpos(solidArrow1));null===solidArrow2?(stopTime=null,states.forEach(function(state){if(!stopTime&&state.mte>=startTime)return void(stopTime=state.mte)})):getArrowTipXpos(solidArrow1)<=getArrowTipXpos(solidArrow2)?stopTime=getTimeAtXPosition(getArrowTipXpos(solidArrow2)):(startTime=getTimeAtXPosition(getArrowTipXpos(solidArrow2)),stopTime=getTimeAtXPosition(getArrowTipXpos(solidArrow1))),scope.$emit("intentChange",{intent:"externalSeekRequest",seekToSeconds:startTime,caller:"editFromSource"}),scope.$emit("intentChange",{intent:"play",caller:"editFromSource"})}function resetEditGlobals(){removeMarkerBg(),removeSolidArrows(),removeSelectionBackground(),removeSelectionRectangle(),removePlayMenu(),removeMarkerFamily()}function removeMarkerBg(){null!==markerBg&&(markerBg.remove(),markerBg=null)}function removeStates(){stateRectangles=[],editFromSourceSVG.selectAll("rect").remove()}function removeSelectionBackground(){null!==selectionBackground&&(selectionBackground.remove(),selectionBackground=null)}function removeSelectionRectangle(){null!==selectionRectangle&&(selectionRectangle.remove(),selectionRectangle=null)}function removePlayMenu(){null!==playSelectionMenu&&(playSelectionMenu.remove(),playSelectionMenu=null)}function removeMarkerFamily(){null!==marker&&(marker.remove(),marker=null),null!==markerTime&&(markerTime.remove(),markerTime=null),null!==markerMenu&&(markerMenu.remove(),markerMenu=null)}function removeInputs(){editFromSourceSVG.selectAll(function(){return this.getElementsByTagName("foreignObject")}).remove()}function machineTime(input){var seconds,split=input.split(":");return 3===split.length?seconds=60*+split[0]*60+60*+split[1]+ +split[2]:2===split.length?seconds=60*+split[0]+ +split[1]:1===split.length&&(seconds=+split[0]),seconds}function drawArrowInput(arrow,isLeft){var arrowTipXpos=getArrowTipXpos(arrow),value=getTimeAtXPosition(arrowTipXpos).humanTime();console.log("coming here value.",arrowTipXpos,value);var inputXpos=arrowTipXpos+(isLeft?arrowInputLeftBuffer:arrowInputRightBuffer),inputXPercent=getPercentAtXpos(inputXpos),inputWidthPercent=(100*inputWidth/totalWidth).toString()+"%",timerUpdateDuration=null,_aX=inputXPercent,_aY=markerElementsHeight+annotationBarHeight+editBarHeight;scope.isMobileAny&&(isLeft?inputXpos<50&&(_aX=arrowTipXpos-7.5,_aY+=20):totalWidth-inputXpos<89&&(_aX=arrowTipXpos-inputWidth,_aY+=20)),editFromSourceSVG.append("svg:foreignObject").attr("x",_aX).attr("y",_aY).attr("height",32).attr("width",inputWidthPercent).append("xhtml:body").attr("style","background-color: transparent;").append("input").attr("type","text").attr("style","position : relative; top : 0; background-color: #efefef; border: 1px solid #bbb; font-size: 0.7em; width: 39px; padding: 0 2px;outline:none").attr("value",value).on("keypress",function(e){function updateDuration(value){var position=editMargin+machineTime(value)*editWidth/duration,bound1=solidArrow1_leftBound,bound2=solidArrow1_rightBound;arrow===solidArrow2&&(bound1=solidArrow2_leftBound,bound2=solidArrow2_rightBound),bound1<=position&&position<=bound2&&(arrow.attr("x",getPercentAtXpos(position-arrowWidth/2)),refreshInputs(),drawSelectionRectangle(!1))}var el=angular.element(this);$timeout.cancel(timerUpdateDuration),13===d3.event.charCode?updateDuration(el.val()):timerUpdateDuration=$timeout(function(){updateDuration(el.val())},3e3)})}function refreshInputs(){removeInputs(),getXposFromPercentString(solidArrow1.attr("x"))>getXposFromPercentString(solidArrow2.attr("x"))?(lastPrevLts=getTimeAtXPosition(getArrowTipXpos(solidArrow2)),lastPrevLte=getTimeAtXPosition(getArrowTipXpos(solidArrow1)),drawArrowInput(solidArrow1,!1),drawArrowInput(solidArrow2,!0)):(lastPrevLts=getTimeAtXPosition(getArrowTipXpos(solidArrow1)),lastPrevLte=getTimeAtXPosition(getArrowTipXpos(solidArrow2)),drawArrowInput(solidArrow1,!0),drawArrowInput(solidArrow2,!1))}function moveMarkerFamily(xpos){var xPercent=getPercentAtXpos(xpos);null===marker?marker=editFromSourceSVG.append("svg:rect").attr("x",xPercent).attr("y",markerElementsHeight/2).attr("width",2).attr("height",markerElementsHeight/2).attr("fill","black"):marker.attr("x",xPercent);var markerTimePercent=getPercentAtXpos(xpos-24);if(null===markerTime?markerTime=editFromSourceSVG.append("svg:text").attr("font-family","sans-serif").attr("font-size","10px").attr("x",markerTimePercent).attr("y",markerElementsHeight-6).text(function(){return getTimeAtXPosition(xpos).humanTime()}):(markerTime.attr("x",markerTimePercent),markerTime.text(function(){return getTimeAtXPosition(xpos).humanTime()})),!1===isPlaying&&hoveredLongEnough){var startTime=getTimeAtXPosition(xpos);scope.$emit("intentChange",{intent:"externalSeekRequest",seekToSeconds:startTime,caller:"editFromSource"})}else{var xposMenu=xpos+3;null===markerMenu?console.log("ok, delete me. moveMarkerFamily in editFromSource."):markerMenu.attr("transform","translate("+xposMenu+", 0)")}}function removeSolidArrows(){null!==solidArrow1&&(solidArrow1.remove(),solidArrow1=null),null!==solidArrow2&&(solidArrow2.remove(),solidArrow2=null),removeInputs()}function drawArrow(xpos,bound1,bound2){function getNormalizedXPosition(){var xpos=d3.event.x;return xpos<bound1?xpos=bound1:xpos>bound2&&(xpos=bound2),xpos}var arrow=editFromSourceSVG.append("svg:image").attr("x",getPercentAtXpos(xpos-arrowWidth/2)).attr("y",markerElementsHeight+annotationBarHeight+editBarHeight).attr("width",getPercentAtXpos(arrowWidth)).attr("height",arrowHeight).attr("xlink:href","https://nr8-images.s3.amazonaws.com/assets/icons/nr8RedArrow.svg").attr("cursor","move");return arrow.call(d3.behavior.drag().on("drag",function(){var xpos=getNormalizedXPosition();arrow.attr("x",getPercentAtXpos(xpos-arrowWidth/2)),refreshInputs(),drawSelectionRectangle()})),arrow}function drawSelectionBackground(){null===selectionBackground&&(selectionBackground=editFromSourceSVG.append("svg:rect").attr("x",editMargin).attr("y",markerElementsHeight+annotationBarHeight).attr("width",editWidth).attr("height",editBarHeight).attr("fill",bgColor).on("mouseover",function(d){isPlaying?selectionBackground.attr("cursor","default"):selectionBackground.attr("cursor","pointer"),$timeout.cancel(timerCancelHoveredLongEnough),startTimerHoveredLongEnough(),$timeout.cancel(timerMarkerFamily)}).on("mouseout",function(d){$timeout.cancel(timerHoveredLongEnough),startTimerCancelHoveredLongEnough(),!1===isPlaying&&startTimerMarkerFamily()}).on("mousemove",function(d){lastMousePosition=d3.mouse(this)[0],!1===isPlaying&&moveMarkerFamily(d3.mouse(this)[0])}).on("click",function(d){!1===isPlaying&&(scope.$emit("intentChange",{intent:"externalSeekRequest",seekToSeconds:getTimeAtXPosition(d3.mouse(this)[0]),caller:"editFromSource"}),scope.$emit("intentChange",{intent:"play",caller:"editFromSource"}),isPlaying=!0,moveMarkerFamily(d3.mouse(this)[0]))}))}function drawSelectionRectangle(){var xposArrow1Tip=getArrowTipXpos(solidArrow1),xposArrow2Tip=getArrowTipXpos(solidArrow2),solidArrow1IsLeft=xposArrow1Tip<=xposArrow2Tip,start=solidArrow1IsLeft?xposArrow1Tip:xposArrow2Tip,end=solidArrow1IsLeft?xposArrow2Tip:xposArrow1Tip,startPercent=getPercentAtXpos(start),widthPercent=getPercentAtXpos(end-start);null===selectionRectangle?selectionRectangle=editFromSourceSVG.append("svg:rect").attr("x",startPercent).attr("y",markerElementsHeight+annotationBarHeight).attr("width",widthPercent).attr("height",editBarHeight).attr("fill","#c23a0a").on("mouseover",function(d){isPlaying?selectionRectangle.attr("cursor","default"):selectionRectangle.attr("cursor","pointer"),$timeout.cancel(timerCancelHoveredLongEnough),startTimerHoveredLongEnough(),$timeout.cancel(timerMarkerFamily)}).on("mouseout",function(d){$timeout.cancel(timerHoveredLongEnough),startTimerCancelHoveredLongEnough(),!1===isPlaying&&startTimerMarkerFamily()}).on("mousemove",function(d){lastMousePosition=d3.mouse(this)[0],!1===isPlaying&&moveMarkerFamily(d3.mouse(this)[0])}).on("click",function(d){!1===isPlaying&&(scope.$emit("intentChange",{intent:"play",caller:"editFromSource"}),isPlaying=!0,moveMarkerFamily(d3.mouse(this)[0]))}):(selectionRectangle.attr("x",startPercent),selectionRectangle.attr("width",widthPercent));var overflow=0;end+arrowInputRightBuffer+39>totalWidth-editMargin&&(overflow=end+arrowInputRightBuffer+39-(totalWidth-editMargin)),scope.$emit("segmentSelectionActivity",{startTime:getTimeAtXPosition(start),endTime:getTimeAtXPosition(end),overflow:overflow,caller:"editFromSource"})}function drawStateFill(state,startTime,endTime){var colors,colorcode,id="state"+state,startPercent=getPercentAtXpos(editMargin+editWidth*startTime/duration),widthPercent=getPercentAtXpos(editWidth*(endTime-startTime)/duration);console.log("startPercent, widthPercent : ",startPercent,widthPercent),""===states[state].rp.text?colors=["grey","grey"]:(colorcode=state%2,0===colorcode?colors=["#2fede9",bgColor]:1===colorcode&&(colors=["#11d6d2",bgColor]));var stateFill=editFromSourceSVG.append("svg:rect").attr("id",id).attr("x",startPercent).attr("y",markerElementsHeight).attr("width",widthPercent).attr("height",annotationBarHeight).attr("fill",colors[0]).on("mouseover",function(d){isPlaying?stateFill.attr("cursor","default"):stateFill.attr("cursor","pointer"),$timeout.cancel(timerCancelHoveredLongEnough),startTimerHoveredLongEnough(),$timeout.cancel(timerMarkerFamily)}).on("mousemove",function(d){lastMousePosition=d3.mouse(this)[0],!1===isPlaying&&moveMarkerFamily(d3.mouse(this)[0])}).on("mouseout",function(d){$timeout.cancel(timerHoveredLongEnough),startTimerCancelHoveredLongEnough(),!1===isPlaying&&startTimerMarkerFamily()}).on("click",function(){!1===isPlaying&&(scope.$emit("intentChange",{intent:"play",caller:"editFromSource"}),isPlaying=!0,moveMarkerFamily(d3.mouse(this)[0]))});stateRectangles[state]=stateFill}function startTimerMarkerFamily(){timerMarkerFamily=$timeout(function(){removeMarkerFamily()},timerDurationAddElements)}function drawStates(prevLts,prevLte){updateEditWidth(),markerBg=editFromSourceSVG.append("svg:rect").attr("x",editMargin).attr("y",0).attr("width",editWidth).attr("height",markerElementsHeight).attr("fill",markerBgColorOrange),0===annotationBarHeight?(solidArrow1_leftBound=solidArrow2_leftBound=editMargin,solidArrow1_rightBound=solidArrow2_rightBound=editMargin+editWidth):(markerBg.attr("fill",markerBgColorBlue),states.forEach(function(state,i){drawStateFill(i,state.mts,state.mte)}),solidArrow1_leftBound=solidArrow1_rightBound=getXposFromPercentString(stateRectangles[0].attr("x")),solidArrow2_leftBound=solidArrow2_rightBound=getXposFromPercentString(stateRectangles[stateRectangles.length-1].attr("x"))+getXposFromPercentString(stateRectangles[stateRectangles.length-1].attr("width")),""===states[0].rp.text&&(solidArrow1_rightBound=getXposFromPercentString(stateRectangles[0].attr("x"))+getXposFromPercentString(stateRectangles[0].attr("width"))),""===states[states.length-1].rp.text&&(solidArrow2_leftBound=getXposFromPercentString(stateRectangles[stateRectangles.length-1].attr("x")))),console.log("left1, right1, left2, right2 : ",solidArrow1_leftBound,solidArrow1_rightBound,solidArrow2_leftBound,solidArrow2_rightBound),solidArrow1_initPosition=void 0===prevLts?solidArrow1_leftBound:editMargin+editWidth*prevLts/duration,solidArrow2_initPosition=void 0===prevLte?solidArrow2_rightBound:editMargin+editWidth*prevLte/duration,solidArrow1=drawArrow(solidArrow1_initPosition,solidArrow1_leftBound,solidArrow1_rightBound),solidArrow2=drawArrow(solidArrow2_initPosition,solidArrow2_leftBound,solidArrow2_rightBound),refreshInputs(),drawSelectionBackground(),drawSelectionRectangle()}function redraw(newValues){promise=setTimeout(function(){0!==duration&&(removeStates(),resetEditGlobals(),newValues?drawStates(globalPrevLts,globalPrevLte):drawStates(lastPrevLts,lastPrevLte))},1e3)}scope.isMobileAny=isMobile.any,scope.context=attrs.context||"edit";var markerElementsHeight=15,annotationBarHeight=15,editBarHeight=15,arrowHeight=22,sizeIndicator=null,totalWidth=0,editWidth=0,editMargin=50,arrowWidth=15,arrowInputLeftBuffer=-49,arrowInputRightBuffer=12,inputWidth=32,duration=0,globalPrevLts=0,globalPrevLte=0,lastPrevLts=0,lastPrevLte=0,timerDurationAddElements=50,states=null,editFromSourceContainer=null,editFromSourceSVG=null,solidArrow1=null,solidArrow1_leftBound=null,solidArrow1_rightBound=null,solidArrow1_initPosition=null,solidArrow2=null,solidArrow2_leftBound=null,solidArrow2_rightBound=null,solidArrow2_initPosition=null,selectionRectangle=null,selectionBackground=null,timerMarkerFamily=null,marker=null,markerBg=null,markerTime=null,markerMenu=null,stopTime=null,playSelectionMenu=null,stateRectangles=[],isPlaying=!1,promise=null,hoveredLongEnough=!1,timerHoveredLongEnough=null,timerCancelHoveredLongEnough=null,timerDurationHoveredLongEnough=500,timerDurationCancelHoveredLongEnough=50,lastMousePosition=null,bgColor="#f6ddd4",markerBgColorOrange="#fdf2ee",markerBgColorBlue="#f7fefe";editFromSourceContainer=d3.select(element[0]),editFromSourceSVG=editFromSourceContainer.select(".edit_annotations_class").append("svg:svg").attr("width","100%").attr("height",markerElementsHeight+annotationBarHeight+editBarHeight+arrowHeight),sizeIndicator=editFromSourceSVG.append("svg:line").attr("x1",0).attr("y1",0).attr("x2","100%").attr("y2",0).attr("fill","white"),scope.$on("statesForEditFromSource",function(e,newStates,prevLts,prevLte){globalPrevLts=lastPrevLts=prevLts,globalPrevLte=lastPrevLte=prevLte,duration=newStates[newStates.length-1].mte,states=newStates,annotationBarHeight=1===states.length&&""===states[0].rp.text?0:15,redraw(!0)}),scope.$on("statesForEditAnnotations",function(e,newStates){states=null,resetEditGlobals(),removeStates()}),scope.$on("resetToPrevSelection",function(e){null!==solidArrow1&&solidArrow1.attr("x",getPercentAtXpos(solidArrow1_initPosition-arrowWidth/2)),null!==solidArrow2&&solidArrow2.attr("x",getPercentAtXpos(solidArrow2_initPosition-arrowWidth/2)),refreshInputs(),drawSelectionRectangle()}),scope.$on("hidingEditFromSource",function(e){resetEditGlobals(),removeStates()}),scope.$on("playSourceSelection",function(e){console.log("playSourceSelection"),onclickPlaySourceSelection()}),scope.$on("nr8IntentUpdate",function(e,event){switch(event.update){case"playing":isPlaying=!0;break;case"ended":case"paused":isPlaying=!1,startTimerMarkerFamily();break;default:console.log("Not sure what : nr8IntentUpdate inside editFromSource directive.")}}),scope.$on("nr8ControlUpdate",function(e,event){switch(event.update){case"timeUpdate":case"progressUpdate":break;case"progressAndTimeUpdate":if(isPlaying=!0,0!==duration){var xpos=editMargin+event.progressPercent*editWidth/100;moveMarkerFamily(xpos),stopTime&&getTimeAtXPosition(xpos)>=stopTime&&(scope.$emit("intentChange",{intent:"pause",caller:"editAnnotations"}),stopTime=null)}break;default:console.log("Not sure what : nr8ControlUpdate inside editFromSource directive.")}});var uniqueDirectiveId=(Math.random()+"").slice(2)+"_"+scope.$id;$(window).on("resize."+uniqueDirectiveId,function(){states&&($timeout.cancel(promise),console.log("Resize inside editFromSource"),redraw(!1))}),scope.$on("$destroy",function(){console.log("Destroying the resize event inside editFromSource"),$(window).off("resize."+uniqueDirectiveId)})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("fullscreen",function(){var findFunction=function(elem,funcNames){var fn=_.find(funcNames,function(fn){return _.isFunction(elem[fn])});return null===fn&&console.warn("Could not find Fullscreen mode function."),elem[fn]||_.noop},gotoFullscreen=function(elem){findFunction(elem,["requestFullscreen","msRequestFullscreen","mozRequestFullScreen","webkitRequestFullscreen"]).call(elem)},exitFullscreen=function(elem){var fn=findFunction(elem,["exitFullscreen","mozCancelFullScreen","webkitCancelFullScreen","msExitFullscreen"]);console.log("Found the exit function?",fn),fn.call(elem)};return{restrict:"A",controller:function($scope){this.enable=function(){console.log("Fullscreen scope:",$scope),gotoFullscreen($scope.target)},this.exit=function(){exitFullscreen(document)}},link:function(scope,elem,attrs){scope.target=angular.element(elem)[0]}}})}();
!function(){"use strict";angular.module("mean.articles").directive("hasFocus",function($stateParams){return{restrict:"A",scope:"=",link:function(scope,element,attrs){scope.disableHasFocus||$stateParams.focusOn===attrs.name&&setTimeout(function(){angular.element(element).focus()},200)}}})}();
!function(){"use strict";angular.module("mean.articles").directive("imagedirective",function($rootScope,IMAGE_ANIMATION_CONFIG,PLAYER_CONFIG){var imageServer=$rootScope.imageServer&&""!=$rootScope.imageServer?$rootScope.imageServer:"https://images.nr8.com";return console.log("===>imagedirective:imageServer",imageServer),{templateUrl:"articles/views/directive-image.html",transclude:!0,restrict:"E",require:"^fullscreen",link:function(scope,element,attrs,fullscreenCtrl){function getImageUrl(host,id,width){return"yt"===host?imageServer+"/host/yt/"+id+"/"+width:"is"===host?imageServer+"/host/is/"+encodeURIComponent(id)+"/"+width:void 0}function loadImageIntoCache(imageKey,callback){var imageUrl=getImageUrl(imageKey.split("&")[0],imageKey.split("&")[1],imageWidth);$('<img src="'+imageUrl+'" style="width:100%" />').load(function(){var $this=$(this);console.log("Adding ",imageKey,$this,"to the buffer:",cache),cache[imageKey]=$this,callback&&callback(imageKey,$this)})}function applyAnimation(canvas,animation,isIn){var elem=angular.element(canvas),animationFn=IMAGE_ANIMATION_CONFIG.getAnimationFn(animation,isIn);if(!animationFn)return void elem.show();isIn||(outAnimHideFlag=!0),animationFn(elem,animation.options,function(){!isIn&&outAnimHideFlag&&(elem.hide(),outAnimHideFlag=!1)})}var cache={},container=angular.element("div.directive_image_class",element),imageParent=angular.element(".image_class > div",container);scope.context=attrs.context||"playback","playback"!==scope.context&&"editmaster"!==scope.context||(scope.covermask=!0);var imageCanvas=angular.element("div.image_class",container);imageCanvas.css("overflow","hidden");var imageContainer=angular.element(".image_container",imageCanvas),playState=0,imageWidth=850,outAnimHideFlag=!1,applyImage=function(imageKey){var lastImage=$("img",imageParent);lastImage&&lastImage.detach();var targetImage=cache[imageKey];console.log("Target image: ",cache,imageKey,targetImage,typeof targetImage),targetImage&&(imageContainer.css("display","none"),targetImage.addClass("img-responsive"),imageContainer.append(targetImage))},coverImageKey=attrs.coverimage||"";!function(coverImage){scope.imageKeys.forEach(function(imageKey){loadImageIntoCache(imageKey,function(){coverImage===imageKey&&(applyImage(coverImage),imageContainer.show())}),console.log("Appended",imageKey,"to buffer",cache,"and context is",scope.context)})}(coverImageKey),scope.playPause=function(){1===playState?(scope.$emit("intentChange",{intent:"pause",caller:"imagedirective"}),playState=0):0===playState&&(scope.$emit("intentChange",{intent:"play",caller:"imagedirective"}),playState=1,void 0!==window.orientation&&0!==window.orientation&&function(){scope.iOSAppFullScreen?angular.element("body").addClass("ios-fullscreen"):fullscreenCtrl.enable()}())},scope.$on("imageUpdate",function(e,event){switch(console.log("imageUpdate",event),outAnimHideFlag=!1,event.update){case"animation":event.hasOwnProperty("inAnim")?imageContainer.hide(function(){applyAnimation(imageContainer,event.inAnim,!0)},0):event.hasOwnProperty("outAnim")&&(imageContainer.show(),applyAnimation(imageContainer,event.outAnim,!1));break;case"image":!event.hasOwnProperty("cover")||"playback"!==scope.context&&"editmaster"!==scope.context?scope.covermask=!1:scope.covermask=!0,applyImage(scope.imageKeys[event.imageKeyIndex]),playState=event.playState,event.hasOwnProperty("inAnim")?(console.log("The image segment in animation",event.inAnim),imageContainer.hide(function(){applyAnimation(imageContainer,event.inAnim,!0)},0)):imageContainer.show();break;default:console.log("Not sure what : imageUpdate inside image directive.")}}),scope.$on("nr8IntentUpdate",function(e,event){switch(event.update){case"playing":playState=1;break;case"paused":case"ended":playState=0;break;default:console.log("Not sure what : nr8IntentUpdate inside imagedirective.")}}),scope.$on("imageKeysUpdate",function(e,caller){var cachedKeys=_.keys(cache),deletedKey=_.difference(cachedKeys,scope.imageKeys),missingKey=_.difference(scope.imageKeys,cachedKeys),applyCover=function(){console.log("imagedirective imageKeysUpdate : new cover in : ",scope.context,scope.imageKeys[0]),applyImage(scope.imageKeys[0]),imageContainer.show()};0!==deletedKey.length&&(console.log("imagedirective imageKeysUpdate : An image key has been deleted in ",scope.context),delete cache[deletedKey[0]],applyCover()),0!==missingKey.length?(console.log("imagedirective imageKeysUpdate : An image key key has been added in ",scope.context),loadImageIntoCache(missingKey[0],applyCover)):(console.log("imagedirective imageKeysUpdate : No action in ",scope.context),applyCover())})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("narrative",function($rootScope,PLAYER_CONFIG){return{templateUrl:"articles/views/directive-narrative.html",transclude:!0,restrict:"E",scope:{article:"=instance",analyticsContext:"=analytics"},link:function(scope,element,attrs){scope.analyticsContext=_.merge({playerContext:attrs.playerContext||"create"},scope.analyticsContext),scope.nr8=scope.article.actions,scope.cover=scope.article.image,PLAYER_CONFIG.setPlayerConfig(),$scope.playingSupported=PLAYER_CONFIG.isPlayingSupported(),!0===$scope.playingSupported&&($scope.numberOfPlayers=PLAYER_CONFIG.getNumberOfPlayers(),$scope.isAndroid=PLAYER_CONFIG.isAndroid(),$scope.iOSApp=PLAYER_CONFIG.isIOSApp(),$scope.iOS10=PLAYER_CONFIG.isIOS10(),$scope.iOSAppFullScreen=PLAYER_CONFIG.getIOSAppFullScreen()),scope.isMobileAny=isMobile.any;var ua=navigator.userAgent.toLowerCase();scope.isSafari=-1!=ua.indexOf("safari")&&!(ua.indexOf("chrome")>-1)}}})}();
!function(){"use strict";angular.module("mean.articles").controller("ngTagsAddonCtrl",function($scope){$scope.showLengthErrorMsg=!1,$scope.showErrorMsg=!1}).directive("ngTagsAddon",function($rootScope){return{restrict:"A",link:function(scope,element,attrs){var pauseTimer,minLength=parseInt(attrs.minLength);minLength=minLength>0?minLength:3,angular.element(element).find("input").on("input",function(){clearTimeout(pauseTimer);var value=angular.element(this).val();value?value.length<minLength?pauseTimer=setTimeout(function(){scope.$apply(function(){scope.showLengthErrorMsg=!0,scope.showErrorMsg=!0})},1e3):scope.$apply(function(){scope.showLengthErrorMsg=!1,scope.showErrorMsg=!0}):scope.$apply(function(){scope.showErrorMsg=!1})}).on("blur",function(){var value=angular.element(this).val();console.log(value.length,"l"),value.length>minLength-1&&(console.log(value.length,"oo"),scope.$apply(function(){scope.showErrorMsg=!1}))})}}})}();
!function(){"use strict";function registerAction(action){void 0===window.onYouTubeIframeAPIReady&&(window.onYouTubeIframeAPIReady=function(){for(var i in apiReadyActions)apiReadyActions[i].call()}),apiReadyActions.push(action)}var apiReadyActions=[];angular.module("mean.articles").directive("player",function($state,$http,$rootScope,YoutubeMetadata,YT_ANIMATION_CONFIG,$timeout){return{restrict:"E",transclude:!0,template:'<div class="player embed-responsive embed-responsive-16by9" />',link:function(scope,element,attrs){function createPlaceholder(num){var template='<span class="player_'+num+'"></span>';container.append(template)}function missingHotKeyLoaded(){scope.hotKeyNotCachedOrPrebuffered&&!0===cache.hasOwnProperty(scope.anticipatedVideoKey)&&!0===cache[scope.anticipatedVideoKey].player.nr8.unstarted&&(scope.hotKeyNotCachedOrPrebuffered=!1,scope.showType="video",scope.$$phase||scope.$apply(),null!==scope.pendingOnComplete&&void 0!==scope.pendingOnComplete&&(console.log("****** scope.hotKeyNotCachedOrPrebuffered : ",scope.hotKeyNotCachedOrPrebuffered),pendingTogglePlayersPar?togglePlayers(pendingTogglePlayersPar.videoKey,pendingTogglePlayersPar.seekPosition,pendingTogglePlayersPar.playMode):scope.pendingOnComplete(),pendingTogglePlayersPar=null,scope.pendingOnComplete=null))}function updateCacheStatus(){var cacheSize=_.size(cache),cacheStatus=_.cloneDeep(cacheStatusStruct);for(var cacheKey in cache)!1===cache[cacheKey].player.nr8.unstarted&&cacheStatus.pendingUnstarted++,cacheKey===scope.anticipatedVideoKey&&(cacheStatus.anticipatedVideoKeyUnstarted=cache[cacheKey].player.nr8.unstarted),!1===cache[cacheKey].player.nr8.preBuffered&&cacheStatus.pendingPrebuffer++,cacheKey===scope.anticipatedVideoKey&&(cacheStatus.anticipatedVideoKeyPlayingToPreBuffer=cache[cacheKey].player.nr8.playingToPreBuffer,cacheStatus.anticipatedVideoKeyPrebuffered=cache[cacheKey].player.nr8.preBuffered);scope.cacheStatus=cacheStatus,0===scope.cacheStatus.pendingUnstarted&&(scope.loadingRelatedActivity("playersUnstartedCompleted"),cacheStatus.anticipatedVideoKeyPlayingToPreBuffer&&scope.loadingRelatedActivity("playersUnstartedHOAKeyPlayingToPreBuffer"),cacheStatus.anticipatedVideoKeyPrebuffered&&scope.loadingRelatedActivity("playersUnstartedHOAKeyPrebuffered")),0===scope.cacheStatus.pendingPrebuffer&&console.log("All players prebuffered"),console.log("+++","cacheStatus: ",cacheStatus),scope.cacheStatus.anticipatedVideoKeyPrebuffered&&0===scope.cacheStatus.pendingPrebuffer&&cacheSize===targetCacheSize&&scope.loadingRelatedActivity("prebufferCompleted")}function playHotkey(){scope.iOS10&&hotKey&&!0===cache.hasOwnProperty(hotKey)&&playIntent&&cache[hotKey].player.playVideo()}function setPlayerVolume(player,volumeLevel){volumeLevel<0||volumeLevel>100||(relativeVolume=volumeLevel,(scope.masterVolumeMultiplier<0||scope.masterVolumeMultiplier>1)&&(scope.masterVolumeMultiplier=1),(scope.ytVolumeMultiplier<0||scope.ytVolumeMultiplier>1)&&(scope.ytVolumeMultiplier=1),console.log("scope.masterVolumeMultiplier, scope.ytVolumeMultiplier, volumeLevel",scope.masterVolumeMultiplier,scope.ytVolumeMultiplier,volumeLevel),player.setVolume(volumeLevel*scope.masterVolumeMultiplier*scope.ytVolumeMultiplier))}function loadPlayer(videoKey,videoId,lts,uid,onCreate){createPlaceholder(uid);var player=new YT.Player(angular.element(".player_"+uid,element[0])[0],{videoId:videoId,playerVars:{controls:0,rel:0,fs:0,modestbranding:1,playsinline:1,showinfo:showinfo,origin:"https://www.nr8.com"},events:{onReady:function(){"edit"!==scope.context&&"source"!==scope.context||scope.$apply(function(){var duration=player.getDuration()-1;console.log(scope.context,segmentId,"Video duration obtained : ",duration),scope.$emit("recomposeSourceNr8WithTrueDuration",{videoId:videoId,duration:duration,caller:"yt"})}),player.nr8={unstarted:!1,preBuffered:!1,playingToPreBuffer:!1,videoKey:videoKey,videoId:videoId,lts:lts},player.setPlaybackQuality("default"),player.mute(),player.seekTo(lts,!0),player.playVideo(),console.log(TAG+"playVideo() from loadPlayer : "+player.nr8.videoKey.split("&")[0]+" hotkey : "+hotKey),YoutubeMetadata.register(videoId,player),onCreate(player)},onStateChange:function(event){onPlayerStateChange(player,event)},onError:function(event){"edit"===scope.context?scope.$emit("videoSegmentPlayerError",{errorCode:event.data,videoId:videoId,caller:"yt"}):event.data>=100&&$http.get("/check-availability/"+$state.params.articleId+"/"+videoId).then(function(response){response.data.available&&event.data>100?scope.$emit("error.yt.contentNonEmbeddable",videoId,"A video is not permitted to be embedded in NR8."):response.data.available?scope.$emit("error.yt.retryInAWhile",videoId,"The YouTube player could not the load video, but it appears available."):scope.$emit("error.yt.contentUnavailable",videoId,"Content is unavailable.")},function(response){400===response.status?scope.$emit("error.badRequest",videoId,response.data.message):scope.$emit("error.internal",videoId,response.data)})}}})}function createPlayer(videoKey,index,onCreate){var videoId=videoKey.split("&")[0],lts=parseFloat(videoKey.split("&")[1]);try{loadPlayer(videoKey,videoId,lts,index,onCreate)}catch(e){console.warn(scope.context,"YT may not be in scope, this happens only on page load."),console.error(scope.context,e),registerAction(function(){loadPlayer(videoKey,videoId,lts,index,onCreate)})}}function reloadPlayer(prevKey,nextKey,seekPosition,playMode){console.log(TAG,"reloadPlayer("+prevKey+","+nextKey+")");var errorMsg=null;prevKey===nextKey?errorMsg="reloadPlayer: prevKey is nextKey":scope.hotKeyNotCachedOrPrebuffered?prevKey===scope.anticipatedVideoKey&&(errorMsg="reloadPlayer: prevKey is hotKey"):prevKey===hotKey?errorMsg="reloadPlayer: prevKey is hotKey":nextKey===hotKey&&(errorMsg="reloadPlayer: nextKey is hotKey"),errorMsg&&console.error(TAG+" "+errorMsg);var cacheEntry=cache[prevKey];delete cache[prevKey],cache[nextKey]=cacheEntry;var tokens=nextKey.split("&");cacheEntry.player.nr8.videoId=tokens[0],cacheEntry.player.nr8.lts=tokens[1],cacheEntry.player.nr8.videoKey=nextKey,cacheEntry.player.nr8.unstarted=!1,cacheEntry.player.nr8.preBuffered=!1,cacheEntry.player.mute();var cuePlayer=scope.noPrebufferingDuringPlaying,seekPositionLocal=tokens[1];void 0!==playMode&&null!==playMode&&!0===playMode&&(cuePlayer=!1),seekPosition&&(seekPositionLocal=seekPosition),cuePlayer&&"loading"!==scope.showType?cacheEntry.player.cueVideoById(tokens[0],seekPositionLocal,"default"):cacheEntry.player.loadVideoById(tokens[0],seekPositionLocal,"default"),YoutubeMetadata.register(tokens[0],cacheEntry.player),scope.iOS10&&!cuePlayer&&(expectingFalsePauseIOS=2),console.log(TAG+"--newCacheKey-- calling loadVideoById() for new cache key : "+tokens[0]+" hotKey : "+hotKey)}function prebufferPlayers(){for(var cacheKey in cache)console.log("prebufferPlayers 1"),!1===cache[cacheKey].player.nr8.preBuffered&&(cache[cacheKey].player.mute(),console.log("prebufferPlayers 2"),cache[cacheKey].player.playVideo())}function findPlayerHTMLElement(player){var htmlElem;return _.forOwn(player,function(p){p instanceof HTMLElement&&angular.element(p).attr("src")&&(htmlElem=angular.element(p))}),htmlElem}function hidePlayer(player,callback){var $p=findPlayerHTMLElement(player);null!==$p&&$p.hide(0,callback)}function showPlayer(player){var $p=findPlayerHTMLElement(player);null!==$p&&$p.show(0)}function applyAnimation(player,anim,isIn){var animation=_.cloneDeep(anim),elem=findPlayerHTMLElement(player),animationFn=YT_ANIMATION_CONFIG.getAnimationFn(anim,isIn);if(!animationFn)return void elem.show();isIn||(animation.options.duration=animation.options.duration-100,outAnimHideFlag=!0),animationFn(elem,animation.options,function(){!isIn&&outAnimHideFlag&&(elem.hide(),outAnimHideFlag=!1)})}function inAudioT(player,timeoutValue){setPlayerVolume(player,inAudioTVolumes[volumeIndex]),console.log("audioLevel in",inAudioTVolumes[volumeIndex]),++volumeIndex<inAudioTVolumes.length&&(timerAudioT=$timeout(function(){inAudioT(player,timeoutValue)},timeoutValue))}function outAudioT(player,timeoutValue){setPlayerVolume(player,outAudioTVolumes[volumeIndex]),console.log("audioLevel out",outAudioTVolumes[volumeIndex]),++volumeIndex<outAudioTVolumes.length&&(timerAudioT=$timeout(function(){outAudioT(player,timeoutValue)},timeoutValue))}function applyAudioT(player,audioT,isIn){var timeoutValue=0;$timeout.cancel(timerAudioT),volumeIndex=0,isIn?(timeoutValue=audioT.options.duration/inAudioTVolumes.length,inAudioT(player,timeoutValue)):(timeoutValue=audioT.options.duration/outAudioTVolumes.length,outAudioT(player,timeoutValue))}function getKeyIndex(key){return _.indexOf(scope.videoKeys,key)}function convertKeyArrayToIndexArray(keyArray){var indexArray=[];return keyArray.forEach(function(key){indexArray.push(_.indexOf(scope.videoKeys,key))}),indexArray}function alignCache(hotOrAnticipatedKey,numberOfNewKeys){console.log("**** comes into alignCache with hotOrAnticipatedKey",hotOrAnticipatedKey,getKeyIndex(hotOrAnticipatedKey)),scope.videoKeys.length>=maxCacheSize&&_.size(cache)!==maxCacheSize&&console.log(TAG,"Handle this error case"),console.log(TAG,videoKeysString);var hotOrAnticipatedKeyIndex=getKeyIndex(hotOrAnticipatedKey);if(-1===hotOrAnticipatedKeyIndex)return void console.warn(TAG,"**** alignCache: hotKey is not in videoKeys");var cacheIndices=convertKeyArrayToIndexArray(_.keys(cache));console.log("prepping cacheIndices:",cacheIndices);var ideal=[];ideal.push(hotOrAnticipatedKeyIndex);for(var len=_.min([scope.videoKeys.length,maxCacheSize]),keyIndex=hotOrAnticipatedKeyIndex,i=ideal.length;i<len;i++)keyIndex++,keyIndex>=scope.videoKeys.length&&(keyIndex=0),ideal.push(keyIndex);console.log("prepping ideal:",ideal);var missing=_.difference(ideal,cacheIndices);console.log("prepping missing:",missing),missing=_.take(missing,numberOfNewKeys),console.log("prepping missing 2:",missing);var canGo=_.difference(cacheIndices,ideal);if(console.log("prepping canGo:",canGo),0===missing.length)return void console.log(TAG,"prepping missing zero");for(var i=0;i<missing.length;i++)i<canGo.length&&(reloadPlayer(scope.videoKeys[canGo[i]],scope.videoKeys[missing[i]]),console.log("prepping : outKey, inKey : ",canGo[i],scope.videoKeys[canGo[i]],missing[i],scope.videoKeys[missing[i]]))}function prepNewPlayer(newHotKey,seekPosition,playMode,oncomplete){if(console.log("prepping entering: ",getKeyIndex(hotKey),getKeyIndex(newHotKey),convertKeyArrayToIndexArray(_.keys(cache))),!0===cache.hasOwnProperty(newHotKey)&&!0===cache[newHotKey].player.nr8.unstarted)return console.log("%%%%%%%%%%%%%%%% found the hotKey"),scope.hotKeyNotCachedOrPrebuffered&&(scope.hotKeyNotCachedOrPrebuffered=!1,scope.showType="video",scope.pendingOnComplete=null,scope.$$phase||scope.$apply()),void(null!==oncomplete&&void 0!==oncomplete&&oncomplete());console.log("hotkey miss: maxCacheSize",maxCacheSize,seekPosition,playMode),scope.anticipatedVideoKey=newHotKey,scope.hotKeyNotCachedOrPrebuffered=!0,scope.showType="loading",scope.$$phase||scope.$apply(),scope.pendingOnComplete=oncomplete,scope.seekCircleMouseDown?console.log("%%%%%%%%%%%%%%%% seekCircleMouseDown is true, so call alignCache() when released."):(console.log("%%%%%%%%%%%%%%%% seekCircleMouseDown is false, so call alignCache()",oncomplete),!0===scope.noPrebufferingDuringPlaying&&prebufferPlayers(),alignCache(scope.anticipatedVideoKey,1))}function togglePlayers(newHotKey,seekPosition,playMode,inAnimation,inAudioT){if(console.log("prepping : hotKey inside togglePlayers : ",getKeyIndex(hotKey)),console.log("prepping : newHotKey inside togglePlayers : ",getKeyIndex(newHotKey)),!1===togglePlayersLock&&!1===hidePlayerLock){togglePlayersLock=!0,hidePlayerLock=!0;var oldHotKey=hotKey;hotKey=newHotKey;var animateOrShowNewPlayer=function(){console.log("****** : animateOrShowNewPlayer()"),void 0!==inAnimation&&null!==inAnimation?void 0!==cache[newHotKey]&&applyAnimation(cache[newHotKey].player,inAnimation,!0):void 0!==cache[newHotKey]&&showPlayer(cache[hotKey].player),hidePlayerLock=!1,togglePlayersLock||null===togglePlayersCb||togglePlayersCb()};void 0!==seekPosition&&cache[hotKey].player.seekTo(seekPosition,!0),null!==oldHotKey&&cache.hasOwnProperty(oldHotKey)&&null!==cache[oldHotKey]&&void 0!==cache[oldHotKey]&&null!==cache[oldHotKey].player?(hidePlayer(cache[oldHotKey].player,animateOrShowNewPlayer),hotKey!==oldHotKey&&(cache[oldHotKey].player.pauseVideo(),console.log(TAG+"--oldHotKey- calling pauseVideo() for oldHotKey : "+cache[oldHotKey].player.nr8.videoKey.split("&")[0]+" hotKey : "+hotKey),cache[oldHotKey].player.seekTo(cache[oldHotKey].player.nr8.lts))):animateOrShowNewPlayer(),maxCacheSize>1&&scope.videoKeys.length>2&&!scope.seekCircleMouseDown&&alignCache(hotKey,2),!0===playMode?(!1===cache[hotKey].player.nr8.preBuffered&&(cache[hotKey].player.nr8.preBuffered=!0,cache[hotKey].player.unMute()),void 0!==inAudioT&&null!==inAudioT?applyAudioT(cache[hotKey].player,inAudioT,!0):($timeout.cancel(timerAudioT),setPlayerVolume(cache[hotKey].player,100)),cache[hotKey].player.playVideo(),console.log(TAG+"--newHotKey-- calling playVideo() for hotkey : "+cache[hotKey].player.nr8.videoKey.split("&")[0]+" hotKey : "+hotKey)):setPlayerVolume(cache[hotKey].player,100),togglePlayersLock=!1,"edit"!==scope.context&&(expectingFalsePause=!0,expectingFalsePauseTimer=$timeout(function(){expectingFalsePause=!1},600)),hidePlayerLock||null===togglePlayersCb||togglePlayersCb()}else togglePlayersCb=function(){console.log("Toggle player Called Back ===================================== YEA."),togglePlayersCb=null,togglePlayers(newHotKey,seekPosition,playMode,inAnimation)}}function expectingFalsePauseTimerCancellation(){$timeout.cancel(expectingFalsePauseTimer),expectingFalsePause=!1,console.log(TAG+" : Expecting false pause timer cancellation")}function initCache(anticipatedKeys){var cachedKeys=_.keys(cache);_.difference(anticipatedKeys,cachedKeys).forEach(function(missingKey){createPlayer(missingKey,uniqueId++,function(player){cache[missingKey]={},cache[missingKey].player=player,missingKey!==hotKey&&hidePlayer(player);var playersCreated=0;for(var cacheKey in cache)cache[cacheKey].hasOwnProperty("player")&&playersCreated++;console.log("playersCreated : ",playersCreated),playersCreated!==scope.videoKeys.length&&playersCreated!==maxCacheSize||scope.loadingRelatedActivity("playersCreationCompleted")})})}function initialize(){if(console.log(scope.context,segmentId,"Initialize : keys PASSED : ",scope.videoKeys,maxCacheSize),scope.videoKeys.forEach(function(state,i){videoKeysString=videoKeysString+",  "+i+": "+scope.videoKeys[i].split("&")[0]}),scope.coverIsVideo){!1===cache.hasOwnProperty(scope.videoKeys[0])?createPlayer(scope.videoKeys[0],uniqueId++,function(player){cache[scope.videoKeys[0]]={player:player},togglePlayers(scope.videoKeys[0])}):togglePlayers(scope.videoKeys[0]);var keys=[];keys.push(scope.videoKeys[0]),initCache(_.take(_.difference(scope.videoKeys,keys),maxCacheSize-1))}else initCache(_.take(scope.videoKeys,maxCacheSize))}var container=angular.element("div",element);scope.context=attrs.context||"playback";var segmentId=attrs.segmentid||"n.a.",cache={},uniqueId=0,maxCacheSize=1;scope.numberOfPlayers&&(maxCacheSize=scope.numberOfPlayers);var timerAudioT,volumeIndex,expectingFalsePause=!1,expectingFalsePauseTimer=null,videoKeysString="",TAG=">>>player:::::",hotKey=null,playIntent=!1,togglePlayersLock=!1,togglePlayersCb=null,hidePlayerLock=!1,pendingTogglePlayersPar=null,relativeVolume=100,inAudioTVolumes=[0,1,2,4,8,16,32,64,100],outAudioTVolumes=[100,64,32,16,8,4,2,1,0],outAnimHideFlag=!1,targetCacheSize=scope.videoKeys.length>maxCacheSize?maxCacheSize:scope.videoKeys.length,cacheStatusStruct={targetCacheSize:targetCacheSize,pendingUnstarted:0,anticipatedVideoKeyUnstarted:!1,pendingPrebuffer:0,anticipatedVideoKeyPrebuffered:!1,anticipatedVideoKeyPlayingToPreBuffer:!1};scope.cacheStatus=_.cloneDeep(cacheStatusStruct);var expectingFalsePauseIOS=0;(scope.iOS10||scope.iOSApp)&&(expectingFalsePauseIOS=2);var showinfo=!0;(scope.iOS10||scope.iOSApp)&&"edit"!=scope.playerContext&&(showinfo=!1),scope.noPrebufferingDuringPlaying=!1;var onPlayerStateChange=function(player,event){switch(event.data){case YT.PlayerState.UNSTARTED:player.nr8.unstarted=!0,updateCacheStatus(),scope.hotKeyNotCachedOrPrebuffered&&missingHotKeyLoaded();break;case YT.PlayerState.ENDED:if("edit"===scope.context||"source"===scope.context)hotKey=null;else{var key=player.nr8.videoKey;player.destroy(),delete cache[key],createPlayer(key,uniqueId++,function(player){cache[key]={player:player}})}scope.$emit("intentChange",{intent:"ytended",caller:"yt"});break;case YT.PlayerState.PLAYING:console.log(TAG+"YT.PlayerState.PLAYING : "+player.nr8.videoKey.split("&")[0]+" hotkey : "+hotKey),!1===player.nr8.preBuffered?(!1===player.nr8.playingToPreBuffer&&(player.nr8.playingToPreBuffer=!0,updateCacheStatus()),playHotkey(),player.pauseVideo(),playHotkey(),console.log(TAG+"--newCacheKey-- YT.PlayerState.PLAYING .. calling pauseVideo() preBuffered=false")):player.nr8.videoKey===hotKey?(console.log(TAG+"--newHotKey-- YT.PlayerState.PLAYING .. hotKey is playing"),playIntent=!0,scope.$emit("intentChange",{intent:"play",caller:"yt"})):(player.pauseVideo(),console.log(TAG+"YT.PlayerState.PLAYING .. preBuffered is true and not a hotKey. ERROR--------------------------------"));break;case YT.PlayerState.PAUSED:console.log(TAG+"YT.PlayerState.PAUSED : "+player.nr8.videoKey.split("&")[0]+" hotkey : "+hotKey),!1===player.nr8.preBuffered?(console.log(TAG+"YT.PlayerState.PAUSED .. Not a hotKey"),player.nr8.preBuffered=!0,player.unMute(),updateCacheStatus()):player.nr8.videoKey===hotKey&&(console.log(TAG+"YT.PlayerState.PAUSED : Pausing hotKey. playerState : "+player.getPlayerState()+" hotkey : "+hotKey+"If you did not click on the player, it is an ERROR--------------------------------"),expectingFalsePause||scope.iOS10&&hotKey&&!0===cache.hasOwnProperty(hotKey)&&playIntent&&expectingFalsePauseIOS?(console.log(TAG+"ERROR : Could be a false pause. Hence calling play."),expectingFalsePauseIOS>0&&expectingFalsePauseIOS--,scope.hotkeypauseDebugIOS&&scope.$emit("hotkeypause"),player.playVideo()):(console.log(TAG+"Not ERROR : Emitting pause intent"),playIntent=!1,scope.$emit("intentChange",{intent:"pause",caller:"yt"})));break;case YT.PlayerState.BUFFERING:player.nr8.videoKey===hotKey&&!0===player.nr8.preBuffered&&scope.$emit("intentChange",{intent:"buffering",caller:"yt"});break;case YT.PlayerState.CUED:}};if(initialize(),console.log("In player ( non singular). Number of allowed max players : ",scope.numberOfPlayers),attrs.seektime)try{parseInt(attrs.seektime)}catch(ex){console.error(ex)}scope.$on("ytUpdate",function(e,event){switch(outAnimHideFlag=!1,console.log("ytupdate:",event,event.inAnim,event.outAnim,event.inAudioT,event.inAudioT),event.update){case"animation":event.hasOwnProperty("inAnim")?applyAnimation(cache[hotKey].player,event.inAnim,!0):event.hasOwnProperty("outAnim")&&applyAnimation(cache[hotKey].player,event.outAnim,!1);break;case"audioT":event.hasOwnProperty("inAudioT")?applyAudioT(cache[hotKey].player,event.inAudioT,!0):event.hasOwnProperty("outAudioT")&&applyAudioT(cache[hotKey].player,event.outAudioT,!1);break;case"animationAndAudioT":event.hasOwnProperty("inAnim")?applyAnimation(cache[hotKey].player,event.inAnim,!0):event.hasOwnProperty("outAnim")&&applyAnimation(cache[hotKey].player,event.outAnim,!1),event.hasOwnProperty("inAudioT")?applyAudioT(cache[hotKey].player,event.inAudioT,!0):event.hasOwnProperty("outAudioT")&&applyAudioT(cache[hotKey].player,event.outAudioT,!1);break;case"setvolume":setPlayerVolume(cache[hotKey].player,event.volume);break;case"applyVolumeMultipliers":setPlayerVolume(cache[hotKey].player,relativeVolume);break;case"play":if(scope.hotKeyNotCachedOrPrebuffered)return;expectingFalsePauseTimerCancellation(),!1===cache[hotKey].player.nr8.preBuffered&&(cache[hotKey].player.nr8.preBuffered=!0,cache[hotKey].player.unMute()),cache[hotKey].player.playVideo(),console.log(TAG+" calling playVideo() for hotkey from play ytUpdate : "+cache[hotKey].player.nr8.videoKey.split("&")[0]+" hotKey : "+hotKey);break;case"pause":if(scope.hotKeyNotCachedOrPrebuffered)return;if(playIntent=!1,expectingFalsePauseTimerCancellation(),"transition"===event.reason||"image"===event.reason){var key=hotKey;hotKey=null,cache[key].player.pauseVideo(),console.log(TAG+"calling pauseVideo() from pause ytUpdate : "+cache[key].player.nr8.videoKey.split("&")[0]),cache[key].player.seekTo(cache[key].player.nr8.lts),hidePlayer(cache[key].player)}else cache[hotKey].player.pauseVideo(),console.log(TAG+"calling pauseVideo() from pause ytUpdate : "+cache[hotKey].player.nr8.videoKey.split("&")[0]+" hotKey : "+hotKey);break;case"seek":if(scope.hotKeyNotCachedOrPrebuffered)return;cache[hotKey].player.seekTo(event.seekPosition,!0),showPlayer(cache[hotKey].player),$timeout.cancel(timerAudioT),setPlayerVolume(cache[hotKey].player,100);break;case"stop":if(scope.hotKeyNotCachedOrPrebuffered)return;expectingFalsePauseTimerCancellation(),cache[hotKey].player.pauseVideo(),console.log(TAG+"calling pauseVideo() from stop ytUpdate : ",cache[hotKey].player.nr8.videoKey.split("&")[0]+" hotKey : "+hotKey);break;case"load":expectingFalsePauseTimerCancellation(),event.hasOwnProperty("inAnim")&&console.log(event.inAnim),prepNewPlayer(scope.videoKeys[event.keyIndex],event.seekPosition,!0,function(){togglePlayers(scope.videoKeys[event.keyIndex],event.seekPosition,!0,event.inAnim,event.inAudioT)});break;case"cue":expectingFalsePauseTimerCancellation(),event.hasOwnProperty("videoSegEditAfterOutAnim")&&event.videoSegEditAfterOutAnim?(cache[hotKey].player.seekTo(event.seekPosition),$timeout(function(){showPlayer(cache[hotKey].player)},200)):prepNewPlayer(scope.videoKeys[event.keyIndex],event.seekPosition,!0,function(){togglePlayers(scope.videoKeys[event.keyIndex],event.seekPosition)});break;default:console.log("Not sure what : ytUpdate inside youtube directive.")}}),scope.$on("seekCircleMouseUp",function(e,event){console.log("!!!!! positionPercent, intent : ",event.positionPercent,event.intent);var infoAtPosition=scope.getInfoAtPosition(event.positionPercent),intentPassed="pause";return"playPauseToSeek"===event.intent&&(intentPassed="play"),"video"!=infoAtPosition.type||"video"===infoAtPosition.type&&!scope.hotKeyNotCachedOrPrebuffered?(console.log("!!!!!! calling emit with the following intent : ",intentPassed),void("play"===intentPassed&&scope.$emit("intentChange",{intent:"play",caller:"not-yt-on-purpose"}))):scope.anticipatedVideoKey!==infoAtPosition.videoKey?void console.log("!!!!!! Error"):(pendingTogglePlayersPar=infoAtPosition,pendingTogglePlayersPar.playMode="play"===intentPassed,void(scope.hotKeyNotCachedOrPrebuffered&&(console.log("!!!!!! call alignCache() now.",pendingTogglePlayersPar),!0===scope.noPrebufferingDuringPlaying&&prebufferPlayers(),alignCache(scope.anticipatedVideoKey,1))))}),scope.$on("videoKeysUpdate",function(e,caller){console.log("videoKeysUpdate before:",caller,scope.videoKeys,_.keys(cache));var cachedKeys=_.keys(cache);if("edit"===scope.context)hotKey=scope.videoKeys[0],cachedKeys[0]!==scope.videoKeys[0]&&(cache[hotKey]={},cache[hotKey].player=cache[cachedKeys[0]].player,delete cache[cachedKeys[0]],cache[hotKey].player.nr8.videoKey=hotKey,cache[hotKey].player.nr8.videoId=hotKey.split("&")[0],cache[hotKey].player.nr8.lts=hotKey.split("&")[1]),cache[hotKey].player.seekTo(hotKey.split("&")[1]),void 0!==scope.initialYtVolume&&null!==scope.initialYtVolume&&setPlayerVolume(cache[hotKey].player,scope.initialYtVolume);else if("source"===scope.context&&cachedKeys[0]!==scope.videoKeys[0]){var player=cache[cachedKeys[0]].player,$p=findPlayerHTMLElement(player);null!==$p&&$p.remove(),delete cache[cachedKeys[0]],initialize()}console.log("videoKeysUpdate after:",caller,scope.videoKeys,_.keys(cache))}),scope.$on("loadnarrative",function(e,caller){console.log("loadnarrative request received. Go through the player cache and play pause each video.");for(var cacheKey in cache)cache[cacheKey].player.nr8.preBuffered=!1,cache[cacheKey].player.mute(),cache[cacheKey].player.seekTo(cacheKey.split("&")[1]),cache[cacheKey].player.playVideo()})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("playerControlBar",function($rootScope,$timeout,PLAYER_CONFIG){return{transclude:!0,restrict:"E",require:"^fullscreen",link:function(scope,element,attrs,fullscreenCtrl){function updateWidths(){totalWidth=progressBackground[0][0].getBBox().width,seekWidth=totalWidth-seekCircleDiameter,pagesX=totalWidth-pagesSubtractionValue,leftArrowBoxX=totalWidth-pagesSubtractionValue+pagesLength,leftArrowX=totalWidth-pagesSubtractionValue+pagesLength+arrowOffsetInBox,rightArrowBoxX=totalWidth-pagesSubtractionValue+pagesLength+arrowBoxWidth,rightArrowX=totalWidth-pagesSubtractionValue+pagesLength+arrowBoxWidth+arrowOffsetInBox,audioTrackMenuIconX=totalWidth-audioTrackMenuIconLength,allowfullscreen&&(fullScreenBoxX=totalWidth-pagesSubtractionValue+pagesLength+2*arrowBoxWidth,fullScreenX=totalWidth-pagesSubtractionValue+pagesLength+2*arrowBoxWidth+iconOffsetInBox)}function cleanupPlayPauseReplay(){play&&play.remove(),pause&&pause.remove(),replay&&replay.remove()}function enterFullScreen(){scope.iOSAppFullScreen?angular.element("body").addClass("ios-fullscreen"):fullscreenCtrl.enable()}function exitFullScreen(){scope.iOSAppFullScreen?angular.element("body").removeClass("ios-fullscreen"):fullscreenCtrl.exit()}function showPlay(){"play"!==iconState&&"pause"!==intent&&"playPauseToSeek"!==intent&&(iconState="play",intent="pause",cleanupPlayPauseReplay(),play=playerControlBarSVG.append("svg:image").attr("x",playBoxLeftMargin+iconOffsetInBox).attr("y",iconsTopMargin).attr("width",iconDimension).attr("height",iconDimension).attr("xlink:href",playIcon).on("mouseover",function(d){"loading"!==scope.showType&&playPauseReplay.attr("fill","#c23a0a")}).on("mouseout",function(d){playPauseReplay.attr("fill",backgroundColor)}).on("click",function(d){"loading"!==scope.showType&&(scope.$emit("intentChange",{intent:"play",caller:"playerControlBar"}),showPause(),void 0!==window.orientation&&0!==window.orientation&&enterFullScreen())}))}function showPause(){"pause"!==iconState&&(intent="play",iconState="pause",cleanupPlayPauseReplay(),pause=playerControlBarSVG.append("svg:image").attr("x",playBoxLeftMargin+iconOffsetInBox).attr("y",iconsTopMargin).attr("width",iconDimension).attr("height",iconDimension).attr("xlink:href",pauseIcon).on("mouseover",function(d){"loading"!==scope.showType&&playPauseReplay.attr("fill","#c23a0a")}).on("mouseout",function(d){playPauseReplay.attr("fill",backgroundColor)}).on("click",function(d){"loading"!==scope.showType&&(scope.$emit("intentChange",{intent:"pause",caller:"playerControlBar"}),showPlay())}))}function showReplay(){"replay"!==iconState&&"playPauseToSeek"!==intent&&"pausedSeeking"!==intent&&(iconState="replay",intent="ended",cleanupPlayPauseReplay(),replay=playerControlBarSVG.append("svg:image").attr("x",playBoxLeftMargin+iconOffsetInBox).attr("y",iconsTopMargin).attr("width",iconDimension).attr("height",iconDimension).attr("xlink:href",replayIcon).on("mouseover",function(d){"loading"!==scope.showType&&playPauseReplay.attr("fill","#c23a0a")}).on("mouseout",function(d){playPauseReplay.attr("fill",backgroundColor)}).on("click",function(d){"loading"!==scope.showType&&(scope.$emit("intentChange",{intent:"play",caller:"playerControlBar"}),showPause(),intent="play",void 0!==window.orientation&&0!==window.orientation&&enterFullScreen())}))}function seekerAndFillUpdate(progressWidth){var percentStringSeekCirlce=(progressWidth/totalWidth*100).toString()+"%";0===progressWidth?percentStringSeekCirlce=((progressWidth-3)/totalWidth*100).toString()+"%":progressWidth===seekWidth&&(percentStringSeekCirlce=((progressWidth+2)/totalWidth*100).toString()+"%");var percentStringFill=((progressWidth+seekCircleDiameter/2)/totalWidth*100).toString()+"%";seekCircle.attr("x",percentStringSeekCirlce),progressFill.attr("width",percentStringFill)}function goToPercent(){seekerAndFillUpdate(seekWidth*(scope.seekToPercent/100))}function goToPosition(xpos){var progressWidth=xpos-seekCircleDiameter/2;progressWidth<0?progressWidth=0:progressWidth>seekWidth&&(progressWidth=seekWidth),seekerAndFillUpdate(progressWidth),scope.seekToPercent=progressWidth/(totalWidth-seekCircleDiameter)*100,scope.$emit("intentChange",{intent:"seek",seekToPercent:scope.seekToPercent,caller:"playerControlBar"})}function mousedownOrTouchstart(){if("loading"!==scope.showType){var onMouseUp;scope.seekCircleMouseDown=!0,onMouseUp=function(){scope.seekCircleMouseDown=!1,scope.$emit("seekCircleMouseUp",{intent:intent,positionPercent:scope.seekToPercent}),seekCircle.attr("xlink:href",seekIconGrey),100===scope.seekToPercent&&(intent="ended",showReplay()),"playPauseToSeek"===intent?intent="play":"pausedSeeking"===intent&&(intent="pause",console.log("back to being paused")),isMobile.any?angular.element(window).unbind("touchend",onMouseUp):angular.element(window).unbind("mouseup",onMouseUp)},isMobile.any?angular.element(window).bind("touchend",onMouseUp):angular.element(window).bind("mouseup",onMouseUp),"play"===intent||"ended"===intent?(intent="playPauseToSeek",scope.$emit("intentChange",{intent:"pause",caller:"playerControlBar"})):"pause"===intent&&(intent="pausedSeeking")}}function repositionRightSideElements(){allowfullscreen&&(scope.hasAudioTracks&&audioTrackMenuIcon.attr("x",audioTrackMenuIconX),fullScreenBox.attr("x",fullScreenBoxX),fullScreenIcon.attr("x",fullScreenX),exitFullScreenBox.attr("x",fullScreenBoxX),exitFullScreenIcon.attr("x",fullScreenX))}var allowfullscreen="true"===attrs.allowfullscreen;attrs.totalpages;var intent="yetToLoad",iconState="undefined",svgWidth="100%",progressBarHeight=8,totalWidth=0,seekWidth=0,seekCircleDiameter=18,iconsTopMargin=23,textTopMargin=35,iconBoxTopMargin=18,playPauseReplayBoxHeight=28,volumeIconWhiteTopMargin=20,volumeIconWhiteDimension=22;scope.seekToPercent=0;var seekCircle,progressFill,progressBackground,playPauseReplay,fullScreenBox,exitFullScreenBox,fullScreenIcon,exitFullScreenIcon,play,pause,replay,playerControlBarSVG,playTime,volumeIcon,audioTrackMenuIcon,audioTrackMenuIconX,durationString="0:00";scope.seekCircleMouseDown=!1;var playBoxLeftMargin=13,playBoxWidth=38,iconOffsetInBox=10,iconDimension=18,playTimeOffset=13,arrowBoxWidth=28,arrowOffsetInBox=5,pagesLength=50,audioTrackMenuIconLength=105,pagesSubtractionValue=playBoxLeftMargin+2*arrowBoxWidth+pagesLength;allowfullscreen&&(pagesSubtractionValue+=playBoxWidth);var pagesX=0,leftArrowBoxX=0,rightArrowBoxX=0,leftArrowX=0,rightArrowX=0,fullScreenBoxX=0,fullScreenX=0,promise=null,backgroundColor="black",seekIconGrey="https://nr8-images.s3.amazonaws.com/assets/icons/seek-solid-grey.svg",playIcon="https://nr8-images.s3.amazonaws.com/assets/icons/play-white.svg",pauseIcon="https://nr8-images.s3.amazonaws.com/assets/icons/pause-white.svg",replayIcon="https://nr8-images.s3.amazonaws.com/assets/icons/replay-white.svg",fullscreenIconWhite="https://nr8-images.s3.amazonaws.com/assets/icons/fullscreen-icon-white.svg",exitFullscreenIconWhite="https://nr8-images.s3.amazonaws.com/assets/icons/exit-fullscreen-icon-white.svg",volumeIconWhite="https://nr8-images.s3.amazonaws.com/assets/icons/volume-icon.png";scope.$on("nr8IntentUpdate",function(e,event){if("playerControlBar"===event.caller)return void console.log("Echo of my own intentChange signal. Please ignore.");switch(event.update){case"playing":showPause();break;case"paused":showPlay();break;case"ended":showReplay();break;case"reset":showPlay();break;default:console.log("Not sure what : nr8IntentUpdate inside playerControlBar directive.")}}),scope.$on("nr8ControlUpdate",function(e,event){switch(event.update){case"timeUpdate":playTime.text(function(){return event.playerTime.humanTime()+" / "+durationString});break;case"progressUpdate":scope.seekToPercent=event.progressPercent,goToPercent();break;case"progressAndTimeUpdate":scope.seekToPercent=event.progressPercent,goToPercent(),playTime.text(function(){return event.playerTime.humanTime()+" / "+durationString});break;default:console.log("Not sure what : nr8ControlUpdate inside playerControlBar directive.")}}),scope.$on("nr8TotalDurationUpdate",function(e,event){switch(event.update){case"durationUpdate":durationString=event.duration.humanTime(),playTime.text(function(){return"0:00 / "+durationString});break;default:console.log("Not sure what : nr8TotalDurationUpdate inside playerControlBar directive.")}}),scope.$on("nr8AnnotationControlUpdate",function(e,event){}),durationString=Number(attrs.initialplaytime).humanTime(),playerControlBarSVG=d3.select(element[0]).append("svg:svg").attr("class","c000 tdn bg-000").attr("width",svgWidth).attr("height",50),playerControlBarSVG.append("svg:rect").attr("x",0).attr("y",0).attr("width",svgWidth).attr("height",50).attr("fill",backgroundColor),playTime=playerControlBarSVG.append("svg:text").attr("font-family","sans-serif").attr("font-size","11px").attr("fill","white").attr("x",playBoxLeftMargin+playBoxWidth+playTimeOffset).attr("y",textTopMargin).text(function(){return"0:00 / "+durationString}),function(){progressBackground=playerControlBarSVG.append("svg:rect").attr("width",svgWidth).attr("height",progressBarHeight).attr("x",0).attr("y",6).attr("fill","#3f3c3c").on("click",function(){"loading"!==scope.showType&&goToPosition(d3.event.offsetX)})}(),function(){progressFill=playerControlBarSVG.append("svg:rect").attr("width",0).attr("height",progressBarHeight).attr("x",0).attr("y",6).attr("fill","#9f9f9f").on("click",function(){"loading"!==scope.showType&&goToPosition(d3.event.offsetX)})}(),function(){seekCircle=playerControlBarSVG.append("svg:image").attr("x",-3).attr("y",1).attr("width",seekCircleDiameter).attr("height",seekCircleDiameter).attr("xlink:href",seekIconGrey).attr("cursor","pointer").call(d3.behavior.drag().on("drag",function(){scope.seekCircleMouseDown&&goToPosition(d3.event.x)})).on("touchstart",mousedownOrTouchstart).on("mousedown",mousedownOrTouchstart)}(),function(){playPauseReplay=playerControlBarSVG.append("svg:rect").attr("width",playBoxWidth).attr("height",playPauseReplayBoxHeight).attr("x",playBoxLeftMargin).attr("y",iconBoxTopMargin).on("mouseover",function(d){"loading"!==scope.showType&&playPauseReplay.attr("fill","#c23a0a")}).on("mouseout",function(d){playPauseReplay.attr("fill",backgroundColor)}).on("click",function(d){"loading"!==scope.showType&&("play"===intent?(scope.$emit("intentChange",{intent:"pause",caller:"playerControlBar"}),showPlay(),intent="pause"):(scope.$emit("intentChange",{intent:"play",caller:"playerControlBar"}),showPause(),intent="play",void 0!==window.orientation&&0!==window.orientation&&enterFullScreen()))}).attr("fill",backgroundColor)}(),showPlay(),function(){volumeIcon=playerControlBarSVG.append("svg:image").attr("x",playBoxLeftMargin+iconOffsetInBox+115).attr("y",volumeIconWhiteTopMargin).attr("width",volumeIconWhiteDimension).attr("height",volumeIconWhiteDimension).attr("xlink:href",volumeIconWhite).on("mouseover",function(d){}).on("mouseout",function(d){}).on("click",function(d){scope.showVolumeControl=!scope.showVolumeControl,scope.$$phase||scope.$apply()})}(),updateWidths(),intent="yetToPlay",scope.hasAudioTracks&&function(){console.log("Audio track",audioTrackMenuIconX,playBoxLeftMargin+playBoxWidth+playTimeOffset+400),audioTrackMenuIcon=playerControlBarSVG.append("svg:text").attr("font-family","sans-serif").attr("font-size","11px").attr("fill","white").attr("font-weight","bold").attr("x",audioTrackMenuIconX).attr("y",textTopMargin).classed("cud",!0).text(function(){return"LANG"}).on("mouseover",function(){}).on("mouseout",function(){}).on("click",function(d){scope.showAudioTrackMenu=!scope.showAudioTrackMenu,scope.$$phase||scope.$apply()})}(),allowfullscreen&&(function(){fullScreenBox=playerControlBarSVG.append("svg:rect").attr("width",playBoxWidth).attr("height",playPauseReplayBoxHeight).attr("x",fullScreenBoxX).attr("y",iconBoxTopMargin).attr("class","hide-on-fullscreen").on("mouseover",function(d){fullScreenBox.attr("fill","#c23a0a")}).on("mouseout",function(d){fullScreenBox.attr("fill",backgroundColor)}).on("click",function(d){enterFullScreen()}).attr("fill",backgroundColor)}(),function(){fullScreenIcon=playerControlBarSVG.append("svg:image").attr("width",iconDimension).attr("height",iconDimension).attr("x",fullScreenX).attr("y",iconsTopMargin).attr("xlink:href",fullscreenIconWhite).attr("class","hide-on-fullscreen").on("mouseover",function(d){fullScreenBox.attr("fill","#c23a0a")}).on("mouseout",function(d){fullScreenBox.attr("fill",backgroundColor)}).on("click",function(d){enterFullScreen()}).attr("fill",backgroundColor)}(),function(){console.log("coming here"),exitFullScreenBox=playerControlBarSVG.append("svg:rect").attr("width",playBoxWidth).attr("height",playPauseReplayBoxHeight).attr("x",fullScreenBoxX).attr("y",iconBoxTopMargin).attr("class","dn show-on-fullscreen").on("mouseover",function(d){exitFullScreenBox.attr("fill","#c23a0a")}).on("mouseout",function(d){exitFullScreenBox.attr("fill",backgroundColor)}).on("click",function(d){exitFullScreen()}).attr("fill",backgroundColor)}(),function(){exitFullScreenIcon=playerControlBarSVG.append("svg:image").attr("width",iconDimension).attr("height",iconDimension).attr("x",fullScreenX).attr("y",iconsTopMargin).attr("xlink:href",exitFullscreenIconWhite).attr("class","dn show-on-fullscreen").on("mouseover",function(d){exitFullScreenBox.attr("fill","#c23a0a")}).on("mouseout",function(d){exitFullScreenBox.attr("fill",backgroundColor)}).on("click",function(d){exitFullScreen()}).attr("fill",backgroundColor)}());var uniqueDirectiveId=(Math.random()+"").slice(2)+"_"+scope.$id;$(window).on("resize."+uniqueDirectiveId,function(){console.log("Resize inside playerControlBar"),adjustSize()}),scope.$on("$destroy",function(){console.log("Destroying the resize event inside playerControlBar"),$(window).off("resize."+uniqueDirectiveId)}),scope.$on("exitFullScreen",function(e,caller){exitFullScreen()}),angular.element(document).on("visibilitychange",function(){document.hidden&&isMobile.any&&scope.$emit("intentChange",{intent:"pause",caller:"controlBar"})}),scope.$on("smallVideoOnScroll",function(){console.log("smallVideoOnScroll the resize event inside playerControlBar"),adjustSize()});var adjustSize=function(){allowfullscreen&&(fullScreenBox.attr("fill",backgroundColor),exitFullScreenBox.attr("fill",backgroundColor)),$timeout.cancel(promise),promise=$timeout(function(){updateWidths(),goToPercent(),repositionRightSideElements()},250)}}}})}();
!function(){"use strict";angular.module("mean.articles").directive("playerMetadata",function($rootScope,$timeout){return{template:'<div class = "player-metadata"> </div>',transclude:!0,restrict:"E",link:function(scope,element,attrs){function updateWidth(){totalWidth=sizeIndicator[0][0].getBBox().width;var duration=states[states.length-1].end;states.forEach(function(state,i){state.startpercent=(100*state.start/duration).toFixed(2).toString()+"%",state.endpercent=(100*state.end/duration).toFixed(2).toString()+"%",state.widthpercent=(100*(state.end-state.start)/duration).toFixed(2).toString()+"%"})}function drawStateFill(state){var stateFill=playerMetadataSVG.append("svg:rect").attr("x",state.startpercent).attr("y",0).attr("width",state.widthpercent).attr("height",svgHeight).on("mouseover",function(d){"loading"!==scope.showType&&"metadata-annot-bg"!==state.color&&"metadata-source-bg"!==state.color&&stateFill.attr("cursor","pointer")}).on("click",function(){"loading"!==scope.showType&&"metadata-annot-bg"!==state.color&&"metadata-source-bg"!==state.color&&(stopAtPercent=100*state.end/states[states.length-1].end,stopAtsetUpComplete=!1,scope.$emit("intentChange",{intent:"externalSeekRequest",seekToSeconds:state.start,caller:"playerMetadata"}),scope.$emit("intentChange",{intent:"play",caller:"playerMetadata"}))});stateFill.attr("class",state.color)}function drawStates(){playerMetadataSVG.selectAll("rect").remove(),updateWidth(),states.forEach(function(state,i){drawStateFill(state)})}var playerMetadataContainer=null,sizeIndicator=null,playerMetadataSVG=null,svgHeight=8,totalWidth=0,rawstates=[],states=[],stopAtPercent=null,stopAtsetUpComplete=!1,uniqueDirectiveId=(Math.random()+"").slice(2)+"_"+scope.$id;playerMetadataContainer=d3.select(element[0]),playerMetadataSVG=playerMetadataContainer.select(".player-metadata").append("svg:svg").attr("width","100%").attr("height",svgHeight),sizeIndicator=playerMetadataSVG.append("svg:line").attr("x1",0).attr("y1",0).attr("x2","100%").attr("y2",0).attr("fill","white"),"playback"!==attrs.context&&"editmaster"!==attrs.context||(rawstates=JSON.parse(attrs.states),function(){states=[];var color="metadata-annot-bg",pageGroups_=_.groupBy(rawstates,function(rawstate){return parseInt(rawstate.rp.page)});_.values(pageGroups_).forEach(function(pagegroup,i){var pageSubgroups_=_.groupBy(pagegroup,function(p){return p.rp.text});_.values(pageSubgroups_).forEach(function(ps,i){color="metadata-annot-bg",ps[0].rp.text.length&&(color="metadata-annot-1",parseInt(ps[0].rp.page)%2&&(color="metadata-annot-2")),states.push({start:ps[0].mts,end:ps[ps.length-1].mte,color:color})})})}(),updateWidth(),drawStates()),scope.$on("sourceMetadataUpdate",function(e,event){states=[],event.meta.sort(function(a,b){return parseFloat(a.start)-parseFloat(b.start)});var end=0;0===event.meta[0].start&&(states.push({start:0,end:event.meta[0].end,color:"metadata-source"}),end=event.meta[0].end),event.meta.forEach(function(m,i){m.end>end&&(end<m.start?(states.push({start:end,end:m.start,color:"metadata-source-bg"}),states.push({start:m.start,end:m.end,color:"metadata-source"}),end=m.end):(states[states.length-1].end=m.end,end=m.end))}),end<event.duration&&states.push({start:end,end:event.duration,color:"metadata-source-bg"}),drawStates()}),scope.$on("nr8ControlUpdate",function(e,event){switch(event.update){case"timeUpdate":null!==stopAtPercent&&(!1===stopAtsetUpComplete?stopAtsetUpComplete=!0:stopAtPercent=null);break;case"progressUpdate":break;case"progressAndTimeUpdate":null!==stopAtPercent&&event.progressPercent>=stopAtPercent&&(scope.$emit("intentChange",{intent:"pause",caller:"playerMetadata"}),stopAtPercent=null,stopAtsetUpComplete=!1);break;default:console.log("Not sure what : nr8ControlUpdate inside editAnnotations directive.")}}),scope.$on("$destroy",function(){console.log("Destroying the resize event inside playerMetadata"),$(window).off("resize."+uniqueDirectiveId)})}}})}();
!function(){"use strict";function registerAction(action){void 0===window.onYouTubeIframeAPIReady&&(window.onYouTubeIframeAPIReady=function(){for(var i in apiReadyActions)apiReadyActions[i].call()}),apiReadyActions.push(action)}var apiReadyActions=[];angular.module("mean.articles").directive("playerSingular",function($rootScope,YoutubeMetadata,YT_ANIMATION_CONFIG){return{restrict:"E",transclude:!0,template:'<div class="media-player player embed-responsive embed-responsive-16by9" />',link:function(scope,element,attrs){function createPlaceholder(num){var template='<span class="player_'+num+'"></span>';container.append(template)}function loadPlayer(videoKey,videoId,lts,uid,onCreate){createPlaceholder(uid);var player=new YT.Player(angular.element(".player_"+uid,element[0])[0],{videoId:videoId,playerVars:{controls:0,rel:0,fs:0,modestbranding:1,playsinline:1},events:{onReady:function(){"edit"!==scope.context&&"source"!==scope.context||scope.$apply(function(){var duration=player.getDuration()-1;console.log(scope.context,segmentId,"Video duration obtained : ",duration),scope.$emit("recomposeSourceNr8WithTrueDuration",{videoId:videoId,duration:duration,caller:"yt"})}),player.nr8={preBufferred:!1,videoKey:videoKey,videoId:videoId,lts:lts},player.setPlaybackQuality("large"),player.mute(),player.seekTo(lts,!0),player.playVideo(),YoutubeMetadata.register(videoId,player),onCreate(player)},onStateChange:function(event){onPlayerStateChange(player,event)}}})}function createPlayer(videoKey,index,onCreate){var videoId=videoKey.split("&")[0],lts=parseFloat(videoKey.split("&")[1]);try{loadPlayer(videoKey,videoId,lts,index,onCreate)}catch(e){console.warn(scope.context,"YT may not be in scope, this happens only on page load."),console.error(scope.context,e),registerAction(function(){loadPlayer(videoKey,videoId,lts,index,onCreate)})}}function initialize(){console.log(scope.context,segmentId,"Initialize theplayer : keys PASSED yoyo: ",scope.videoKeys),createPlayer(scope.videoKeys[scope.videoKeys.length-1],uniqueId++,function(player){theplayer=player,hotKey=scope.videoKeys[scope.videoKeys.length-1],console.log("created the theplayer : ",theplayer)})}var container=angular.element("div",element);scope.context=attrs.context||"playback";var segmentId=attrs.segmentid||"n.a.",cache={},uniqueId=0,hotKey=null,playIntent=!1,theplayer=null,veryFirst=!0,onPlayerStateChange=function(player,event){switch(event.data){case YT.PlayerState.UNSTARTED:console.log("PlayerState.UNSTARTED"),scope.loadingRelatedActivity("playersUnstartedCompleted");break;case YT.PlayerState.ENDED:if("edit"===scope.context||"source"===scope.context)hotKey=null;else{var key=player.nr8.videoKey;player.destroy(),delete cache[key],createPlayer(key,uniqueId++,function(player){cache[key]={player:player}})}scope.$emit("intentChange",{intent:"ytended",caller:"yt"});break;case YT.PlayerState.PLAYING:console.log("PlayerState.PLAYING"),!0===veryFirst?player.pauseVideo():scope.$emit("intentChange",{intent:"play",caller:"yt"});break;case YT.PlayerState.PAUSED:console.log("PlayerState.PAUSED"),!0===veryFirst?(veryFirst=!1,player.unMute(),console.log("unmuting theplayer in paused state handler."),scope.loadingRelatedActivity("prebufferCompleted")):"video"===scope.showType&&(playIntent=!1,scope.$emit("intentChange",{intent:"pause",caller:"yt"}));break;case YT.PlayerState.BUFFERING:console.log("PlayerState.BUFFERING"),player.nr8.videoKey===hotKey&&scope.$emit("intentChange",{intent:"buffering",caller:"yt"});break;case YT.PlayerState.CUED:}};if(initialize(),console.log("In player-singular"),attrs.seektime)try{parseInt(attrs.seektime)}catch(ex){console.error(ex)}scope.$on("ytUpdate",function(e,event){switch(console.log("event.update : ",event),event.update){case"play":console.log("theplayer coming into play."),theplayer.playVideo();break;case"pause":console.log("request to pause theplayer"),theplayer.pauseVideo();break;case"seek":theplayer.seekTo(event.seekPosition,!0),console.log("handling seek");break;case"stop":console.log("stop stop"),theplayer.pauseVideo(),theplayer.cueVideoById(scope.videoKeys[scope.videoKeys.length-1].split("&")[0]);break;case"load":if(hotKey===scope.videoKeys[event.keyIndex])theplayer.seekTo(event.seekPosition),theplayer.playVideo();else{hotKey=scope.videoKeys[event.keyIndex];var videoId=scope.videoKeys[event.keyIndex].split("&")[0];theplayer.loadVideoById(videoId,event.seekPosition),YoutubeMetadata.register(videoId,theplayer)}break;case"cue":if(console.log("in cue : ",event),hotKey===scope.videoKeys[event.keyIndex])theplayer.seekTo(event.seekPosition);else{hotKey=scope.videoKeys[event.keyIndex];var videoId=scope.videoKeys[event.keyIndex].split("&")[0];theplayer.cueVideoById(videoId,event.seekPosition),YoutubeMetadata.register(videoId,theplayer)}break;default:console.log("Not sure what : ytUpdate inside youtube directive.")}}),scope.$on("videoKeysUpdate",function(e,caller){console.log("caller of videoKeysUpdate :",caller),initialize()})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("sourceVideos",function($rootScope,Nr8Composer,$anchorScroll,YoutubeMetadata,$mixpanel){return{restrict:"AE",transclude:!0,templateUrl:"articles/views/directive-source-videos.html",scope:!0,link:function(scope,element,attrs){YoutubeMetadata.attach(scope);var sources=Nr8Composer.retrieveSources(_.cloneDeep(scope.nr8.states),!1);scope.sourceImages=[],scope.showPopover=!0,scope.showAttribution=!0,scope.type="video",scope.showSourceThumbnails=!1,scope.isMobile=isMobile.any,console.log("initializing the sourceVideos directive. Why is it initialized here ?");var selectSource=function(sourceId){scope.currentSourceId=sourceId,scope.cover={host:"yt",id:scope.currentSourceId},scope.sourceNr8=Nr8Composer.composeVideoSegment(-100,scope.currentSourceId,0,0),sources.forEach(function(source,i){if(source.sourceId===sourceId)return void(scope.source=source)})};0===sources.length?scope.sourcesExist=!1:(scope.sourcesExist=!0,sources.forEach(function(source){scope.sourceImages.push({host:"yt",id:source.sourceId})}),selectSource(sources[0].sourceId),1===sources.length?scope.ifPlural="":scope.ifPlural="s"),scope.changeSelectedSource=function(image){scope.currentSourceId!==image.id&&(selectSource(image.id),scope.$broadcast("Nr8Updated",{update:"Nr8Recomposed",updatedNr8:scope.sourceNr8,caller:"sourceVideo"}))},scope.showSources=function(article){$mixpanel.track("ShowSource",{nr8_id:scope.article._id}),scope.showSourceThumbnails=!0,scope.currentSourceId!==sources[0].sourceId&&selectSource(sources[0].sourceId),setTimeout(function(){var elem=angular.element("#source-videos-section");angular.element("html,body").animate({scrollTop:elem.offset().top})},200)},scope.hideSources=function(article){scope.showSourceThumbnails=!1,setTimeout(function(){var elem=angular.element("#topElement");angular.element("html,body").animate({scrollTop:elem.offset().top})},200)},scope.closePopover=function(){scope.showPopover=!1},scope.$on("recomposeSourceNr8WithTrueDuration",function(e,event){scope.sourceNr8=Nr8Composer.composeVideoSegment(-100,event.videoId,0,event.duration),scope.$broadcast("Nr8Updated",{update:"duration",updatedNr8:scope.sourceNr8,caller:"sourceVideos"}),scope.$broadcast("sourceMetadataUpdate",{duration:event.duration,meta:_.cloneDeep(scope.source.meta)}),scope.ifPluralSegments="",scope.forPluarlSegments="the",scope.source.meta.length>1&&(scope.ifPluralSegments="s",scope.forPluarlSegments="any of the "+scope.source.meta.length)}),console.log("sources.length",sources.length),sources.length>0&&setTimeout(function(){scope.showSources()},200)}}})}();
!function(){"use strict";angular.module("mean.articles").directive("thumbnails",function(){return{templateUrl:"articles/views/directive-thumbnails.html",transclude:!0,scope:{images:"=",click:"=",responsive:"&responsive"},restrict:"E",link:function(scope,element,attrs){var initialSlide=0,outernav="true"===attrs.outernav,responsive=scope.responsive();scope.selectedImageIndex=parseInt(attrs.selectedimageindex),scope.slidesToShow=parseInt(attrs.number)||6,scope.respondTo=attrs.respondto||"window",scope.selectedImageIndex>scope.slidesToShow-1&&(initialSlide=scope.selectedImageIndex-(scope.slidesToShow-1)),scope.arrowDown="false"!==attrs.arrowdown,scope.navinverse="true"===attrs.navinverse,scope.$watchCollection("images",function(){!0===outernav&&(console.log("Applying the outernav"),$(".thumbnail-gallery",element).addClass("outer-nav")),void 0===responsive&&(responsive=[{breakpoint:1300,settings:{slidesToShow:5}},{breakpoint:1024,settings:{slidesToShow:5}},{breakpoint:768,settings:{slidesToShow:4}},{breakpoint:480,settings:{slidesToShow:3}},{breakpoint:320,settings:{slidesToShow:2}}]),$(".slick-slider.slider-nav",element).slick({infinite:!1,slidesToShow:scope.slidesToShow,slidesToScroll:1,dots:!0,initialSlide:initialSlide,respondTo:scope.respondTo,responsive:responsive})}),scope.select=function($event,image){!0===scope.arrowDown?(console.log("arrow-down in select"),$(".thumbnail",element).removeClass("selected arrow-down"),$($event.currentTarget).closest(".thumbnail").addClass("selected arrow-down")):(console.log("arrow-up in select"),$(".thumbnail",element).removeClass("selected arrow-up"),$($event.currentTarget).closest(".thumbnail").addClass("selected arrow-up")),$event.stopPropagation(),scope.click(image)},scope.$on("deselectThumnails",function(e){!0===scope.arrowDown?$(".thumbnail",element).removeClass("selected arrow-down"):$(".thumbnail",element).removeClass("selected arrow-up")})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("transcriptView",["$rootScope","TranscriptService",function($rootScope,TranscriptService){return{templateUrl:"articles/views/directive-transcriptView.html",transclude:!0,restrict:"E",replace:!1,link:function(scope,element,attrs){scope.selectedLanguage="English",scope.currenPara="",scope.playtime="",scope.currentPlayTime="",scope.transcripts=attrs.transcripts?attrs.transcripts:scope.article.transcripts;!function(){for(var defaultLang="",i=scope.transcripts.length-1;i>=0;i--)scope.selectedLanguage==scope.transcripts[i].language&&(defaultLang=scope.transcripts[i].language),0==i&&""==defaultLang&&(defaultLang=scope.transcripts[i].language);scope.selectedLanguage=defaultLang}(),scope.isParaChanged=function(paraNum){return""==scope.currenPara?(scope.currenPara=paraNum,!0):scope.currenPara!=paraNum&&(scope.currenPara=paraNum,!0)},scope.playSentence=function(transcript){scope.playtime=transcript.start;var seekTo=TranscriptService.convertToSeconds(transcript.start);scope.$emit("intentChange",{intent:"externalSeekRequest",seekToSeconds:seekTo,caller:"transcript"}),scope.$emit("intentChange",{intent:"play",caller:"transcript"})},scope.reformatData=function(data){for(var prePara,currPara,formattedTranscript=[],i=0,index=-1;i<data.length;i++)currPara=data[i].paragraph,prePara==currPara?formattedTranscript[index].push(data[i]):(prePara=currPara,index++,formattedTranscript[index]=[],formattedTranscript[index].push(data[i]));return formattedTranscript},scope.isPlaying=function(paraData){var sartTime=TranscriptService.convertToSeconds(paraData.start),endTime=TranscriptService.convertToSeconds(paraData.end);return""!=scope.currentPlayTime&&scope.currentPlayTime>=sartTime&&scope.currentPlayTime<=endTime},scope.$on("nr8ControlUpdate",function(e,event){switch(event.update){case"timeUpdate":case"progressAndTimeUpdate":scope.currentPlayTime=event.playerTime}})}}}])}();
!function(){"use strict";angular.module("mean.articles").directive("transition",function($rootScope,$timeout,TEXT_ANIMATION_CONFIG,PLAYER_CONFIG){return{templateUrl:"articles/views/directive-transition.html",transclude:!0,restrict:"E",require:"^fullscreen",link:function(scope,element,attrs,fullscreenCtrl){function applyAnimation(canvas,animation,isIn){var elem=angular.element(canvas),animationFn=TEXT_ANIMATION_CONFIG.getAnimationFn(animation,isIn);if(!animationFn)return void elem.show();isIn||(outAnimHideFlag=!0),animationFn(elem,animation.options,function(){!isIn&&outAnimHideFlag&&(elem.hide(),outAnimHideFlag=!1)})}var container=angular.element("div.textSegmentContainer",element),textParent=angular.element(".textSegment",container),elem=(angular.element("div",textParent),angular.element(".transition-text",element)),resizeTransitionFont=function(containerWidth){var fontSize,container=element.closest(".embed-responsive-item"),containerHeight=.12*container.width();isNaN(containerWidth)&&(containerWidth=container.width()),fontSize=.04*containerWidth;var textLength=elem.text().length,inlineFontSize=!1;textLength<60&&textLength>0&&(fontSize+=fontSize-fontSize*((textLength+40)/100),inlineFontSize=!0),inlineFontSize?elem.addClass("inline-fontsize"):elem.removeClass("inline-fontsize"),elem.css({"font-size":fontSize,"line-height":containerHeight/2*.98+"px"})};angular.element(window).on("resize",function(){resizeTransitionFont()}),resizeTransitionFont(),setTimeout(function(){resizeTransitionFont()},500),scope.context=attrs.context||"playback",scope.style={theme:"text-theme-6",font:"playfair-display"};var outAnimHideFlag=!1,applyText=function(text,style){scope.transitionText=text,style&&(1<=style.theme<=6?scope.style.theme="text-theme-"+style.theme.toString():scope.style.theme="text-theme-1",scope.style.font="text-font-"+style.font.toString(),scope.applyLineFontSizes())};scope.firstLineFontFlag=!1,scope.applyLineFontSizes=function(){$timeout(function(){var transEle=element.find(".transition-text"),transHtml=transEle.html();scope.firstLineFontFlag=transHtml.indexOf("<br>")>-1||transHtml.indexOf("<br />")>-1,$timeout(function(){transEle.toggle().toggle()},0)},0)};var playState=0;console.log("attrs.covertransitionstyle : ",attrs.covertransitionstyle.length),attrs.covertransitionstyle.length?(scope.style=JSON.parse(attrs.covertransitionstyle),applyText(attrs.covertransition||"",scope.style)):applyText(attrs.covertransition||"",null),scope.playPause=function(){1===playState?(scope.$emit("intentChange",{intent:"pause",caller:"transition"}),playState=0):0===playState&&(scope.$emit("intentChange",{intent:"play",caller:"transition"}),playState=1,void 0!==window.orientation&&0!==window.orientation&&function(){scope.iOSAppFullScreen?angular.element("body").addClass("ios-fullscreen"):fullscreenCtrl.enable()}())},scope.$on("transitionUpdate",function(e,event){switch(console.log("transition update :",event),outAnimHideFlag=!1,event.update){case"animation":event.hasOwnProperty("inAnim")?textParent.hide(0,function(){applyAnimation(textParent,event.inAnim,!0)}):event.hasOwnProperty("outAnim")&&(textParent.show(),applyAnimation(textParent,event.outAnim,!1));break;case"text":applyText(event.transitionText,event.style),playState=event.playState,event.hasOwnProperty("inAnim")?(console.log("justtextshow-inanim"),console.log("The transition segment in animation",event.inAnim),textParent.hide(0,function(){applyAnimation(textParent,event.inAnim,!0)})):(textParent.show(),console.log("justtextshow"));break;default:console.log("Not sure what : transitionUpdate inside transition directive.")}}),scope.$on("nr8IntentUpdate",function(e,event){switch(event.update){case"playing":playState=1;break;case"ended":case"paused":playState=0;break;default:console.log("Not sure what : nr8IntentUpdate inside transition directive.")}})}}})}();
!function(){"use strict";angular.module("mean.articles").filter("filesize",[function(){var units=["B","kB","MB","GB","TB","PB","EB","ZB","YB"];return function(bytes,precision){if(isNaN(parseFloat(bytes)))return"-";if(bytes<1)return"0 B";isNaN(precision)&&(precision=1);var unitIndex=Math.floor(Math.log(bytes)/Math.log(1e3));return(bytes/Math.pow(1e3,unitIndex)).toFixed(precision)+" "+units[unitIndex]}}])}();
!function(){"use strict";angular.module("mean.articles").config(["$stateProvider","FacebookProvider","$mixpanelProvider","$disqusProvider",function($stateProvider,FacebookProvider,$mixpanelProvider,$disqusProvider){function resolveArticle(Articles,$http,$stateParams,isEdit){var url="/articles/"+$stateParams.articleId+(isEdit?"?incr=false":"");return $http.get(url).then(function(response){return new Articles(response.data)})}function getArticleSet($http,articleSet){return $http.get("/article-sets/"+articleSet).then(function(response){var articleSets=response.data,articles={};return articleSets.forEach(function(articleSet){articleSet.articles.forEach(function(article){articles[article._id]=article})}),_.values(articles)})}function getRecommendedArticles($http){return $http.get("/recommended").then(function(response){var articleSets=response.data,articles={};return articleSets.forEach(function(articleSet){articleSet.articles.forEach(function(article){articles[article._id]=article})}),_.values(articles)})}function checkAnonymousSessionAccess(UserSession,$stateParams){return UserSession.checkAnonymousSessionAccess({state:"articles_list",params:$stateParams})}$disqusProvider.setShortname("nr8"),FacebookProvider.setAppId("472686176232553"),FacebookProvider.setSdkVersion("v2.4"),$mixpanelProvider.apiKey(mixpanelApiToken),$stateProvider.state("articles_list",{url:"/",templateUrl:"articles/views/list.html",controller:"ListController",resolve:{articles:["$http",getRecommendedArticles],restrict:["UserSession","$stateParams",checkAnonymousSessionAccess],siteConfig:function(SiteConfig){return SiteConfig().then(function(config){return config})}}}).state("articles_list_slider",{url:"/narratives-slider/",templateUrl:"articles/views/list-slider.html",controller:"ListController",resolve:{articles:["$http",getRecommendedArticles],restrict:["UserSession","$stateParams",checkAnonymousSessionAccess],siteConfig:function(SiteConfig){return SiteConfig().then(function(config){return config})}}}).state("articles_browse",{url:"/narratives/all",templateUrl:"articles/views/list.html",controller:"ListController",resolve:{articles:function(Articles){return Articles.query(function(articles){return articles}).$promise},restrict:function(UserSession,$stateParams){return UserSession.checkLoggedin({state:"articles_browse",params:$stateParams})},siteConfig:function(SiteConfig){return SiteConfig().then(function(config){return config})}}}).state("article_edit",{url:"/narratives/:articleId/edit",abstract:!0,params:{article:null},templateUrl:"articles/views/create.html",controller:"CreateController",allowMobile:!1,resolve:{article:function(Articles,$http,$stateParams){return resolveArticle(Articles,$http,$stateParams,!0)},howtoArticle:function(Articles,$http,siteConfig){return resolveArticle(Articles,$http,{articleId:siteConfig.howtoNarrative},!1)},challenges:["$http",function($http){return $http.get("/api/challenges?open=true").then(function(response){return response.data})}],restrictToOwner:function(UserSession,$stateParams,article){return UserSession.checkIsUser(article.user.username,{state:"article_edit.create",params:$stateParams})},siteConfig:function(SiteConfig){return SiteConfig().then(function(config){return console.log("Resolved and here is the config",config),config})},audioFiles:["$http","article",function($http,article){return $http.get("/api/audio/"+article._id).then(function(response){return article.actions.audio={files:response.data},console.log("AUDIO FILES: ",article.actions.audio),response.data})}]}}).state("article_edit.create",{url:"/create",templateUrl:"articles/views/create-segments.html"}).state("article_edit.describe",{params:{focusOn:null},url:"/describe",templateUrl:"articles/views/create-describe.html"}).state("article_edit.preview",{url:"/preview",templateUrl:"articles/views/create-preview.html"}).state("article_edit.status",{url:"/status",templateUrl:"articles/views/create-status.html"}).state("article_view",{url:"/narratives/:articleId",params:{passphrase:null,seekTo:null},templateUrl:"articles/views/view.html",controller:"ViewController",resolve:{article:function(Articles,$http,$stateParams,$state){var url="/articles/"+$stateParams.articleId;return $stateParams.hasOwnProperty("passphrase")&&null!==$stateParams.passphrase&&(url+="?passphrase="+$stateParams.passphrase),$http.get(url).then(function(response){return new Articles(response.data)},function(err){return 404!==err.status&&400!==err.status||$state.go("error.notfound"),403===err.status&&$state.go("error.unauthorized"),!1})},restrict:function(UserSession,$stateParams){return UserSession.checkAnonymousSessionAccess({state:"article_view",params:$stateParams})},siteConfig:function(SiteConfig){return SiteConfig().then(function(config){return config})},playViews:function(siteConfig,article,Global){return Global.user&&_.intersection(Global.user.roles,["admin","super"]).length>0?{show:!0,count:article.playViews}:{show:!1}},myopinion:function($http,article,Global){return Global.user&&Global.user._id?(console.log("GLOBAL.USER",Global.user),$http.get("/api/articles/"+article._id+"/me").then(function(response){return response.data})):{like:!1,dislike:!1}},audioFiles:["$http","article",function($http,article){return $http.get("/api/audio/"+article._id).then(function(response){return article.actions.audio={files:response.data},response.data})}]}}).state("article_embed",{url:"/embed/:articleId",params:{passphrase:null,seekTo:null},templateUrl:"articles/views/embed.html",controller:"ViewController",resolve:{article:function(Articles,$http,$stateParams,$state){var url="/articles/"+$stateParams.articleId;return $stateParams.hasOwnProperty("passphrase")&&null!==$stateParams.passphrase&&(url+="?passphrase="+$stateParams.passphrase),$http.get(url).then(function(response){return new Articles(response.data)},function(err){return 404!==err.status&&400!==err.status||$state.go("error.notfound"),403===err.status&&$state.go("error.unauthorized"),!1})},restrict:function(UserSession,$stateParams){return UserSession.checkAnonymousSessionAccess({state:"article_embed",params:$stateParams})},siteConfig:function(SiteConfig){return SiteConfig().then(function(config){return config})},playViews:function(siteConfig,article,Global){return Global.user&&_.intersection(Global.user.roles,["admin","super"]).length>0?{show:!0,count:article.playViews}:{show:!1}},myopinion:function($http,article,Global){return Global.user&&Global.user._id?(console.log("GLOBAL.USER",Global.user),$http.get("/api/articles/"+article._id+"/me").then(function(response){return response.data})):{like:!1,dislike:!1}}}}).state("article_passphrase",{url:"/narratives/:articleId/enter-passphrase",params:{passphrase:null},templateUrl:"articles/views/passphrase.html",controller:"PassphraseController"}).state("article_search",{url:"/search/:query",templateUrl:"articles/views/search-results.html",controller:"SearchResultsController",resolve:{articles:function($http,$stateParams){return $http.get("/api/search?query="+$stateParams.query).then(function(response){return{query:$stateParams.query,results:response.data}})}}}).state("challenges",{abstract:!0,url:"/page",template:"<ui-view></ui-view>"}).state("challenges.redirect",{url:"/",resolve:{redirect:function(redirectState){return["$state","$q",function($state,$q){var deferred=$q.defer();return setTimeout(function(){$state.go(redirectState)},0),deferred.promise}]}("challenges.list")}}).state("challenges.list",{url:"",controller:"ListChallengesController",templateUrl:"articles/views/challenges/list.html",resolve:{siteConfig:function(SiteConfig){return SiteConfig().then(function(config){return config})},challenges:["$http","siteConfig",function($http,siteConfig){var query="",challengeList=siteConfig.challengeList||[];return challengeList.length>0&&(query="?keys="+_.map(challengeList,function(val,key){return val.key}).join()),$http.get("/api/challenges"+query).then(function(response){return response.data})}],query:[function(){return{q:null}}]}}).state("challenges.search",{url:"/search/:query",controller:"ListChallengesController",templateUrl:"articles/views/challenges/list.html",resolve:{siteConfig:function(SiteConfig){return SiteConfig().then(function(config){return config})},challenges:["$http","$stateParams",function($http,$stateParams){return $http.get("/api/challenges/search/"+$stateParams.query).then(function(response){return response.data})}],query:["$stateParams",function($stateParams){try{return JSON.parse(atob($stateParams.query))}catch(e){return{q:null,parseFail:!0}}}]}}).state("challenges.show",{url:"/:challenge",controller:"ViewChallengeController",templateUrl:"articles/views/challenges/view.html",resolve:{challenge:["$stateParams","$http",function($stateParams,$http){return $http.get("/api/challenges/"+encodeURIComponent($stateParams.challenge)).then(function(response){return response.data})}],featuredEntries:["$http","challenge",function($http,challenge){return getArticleSet($http,challenge.articleSet)}],narratives:["$stateParams","$http",function($stateParams,$http){var url="/api/challenges/"+encodeURIComponent($stateParams.challenge)+"/narratives";return $http.get(url).then(function(response){return response.data})}],siteConfig:function(SiteConfig){return SiteConfig().then(function(config){return config})}}}).state("error.yt",{url:"/youtube",abstract:!0,template:"<ui-view></ui-view>",params:{videoId:null}}).state("error.yt.contentNonEmbeddable",{url:"/content-nonembeddable",templateUrl:"articles/views/errors/yt-content-nonembeddable.html",controller:"YtContentNAController"}).state("error.yt.retryInAWhile",{url:"/retry-in-a-while",templateUrl:"articles/views/errors/yt-retry-in-a-while.html",controller:"YtContentNAController"}).state("error.yt.contentUnavailable",{url:"/content-unavailable",templateUrl:"articles/views/errors/yt-content-unavailable.html",controller:"YtContentNAController"})}]),angular.module("mean.articles").run(["$state","$rootScope","$mixpanel","Global","UserSession","Articles","$filter","GoogleLDService","OembedService",function($state,$rootScope,$mixpanel,Global,UserSession,Articles,$filter,GoogleLDService,OembedService){Global.user&&Global.user._id&&($mixpanel.identify(Global.user._id),$mixpanel.people.set({$email:Global.user.email,$first_name:Global.user.firstname,$last_name:Global.user.lastname,$username:Global.user.username,$last_login:new Date})),$rootScope.$on("create-nr8",function(e,articlePrototype){UserSession.checkLoggedin().then(function(){var date=new Date;date=$filter("date")(date,"MM/dd/yy HH:mm");var article=new Articles(_.merge({title:"Untitled narrative - "+date,visibility:"Draft",isEmpty:!0,actions:{states:[],audio:{files:[]}}},articlePrototype));return article.$save(article,function(response){$state.go("article_edit.create",{articleId:response._id,article:response})})},function(){})}),$rootScope.$on("$stateNotFound",function(event,toState,toParams,fromState,fromParams,error){console.log("$stateNotFound : ",error)})}])}();
!function(){"use strict";angular.module("mean.articles").service("GoogleLDService",["$rootScope","$state",function($rootScope,$state){var imageServer="https://images.nr8.com";switch(window.location.hostname){case"www.nr8.com":case"nr8.com":imageServer="https://images.nr8.com";break;case"dev.nr8.com":imageServer="https://devimage.nr8.com";break;case"localhost":imageServer="http://172.17.0.6:8080"}$rootScope.imageServer=imageServer,console.log("===>GoogleLDService:imageServer",imageServer);var getImageUrl=function(image,width){return imageServer+"/host/"+image.host+"/"+encodeURIComponent(image.id)+"/"+width},updateNarrativeInformation=function(article){var narrativeUrl="https://www.nr8.com/narratives/"+article._id,imageUrl=getImageUrl(article.image,1600),userImageUrl=getImageUrl(article.user.image,400),usernameWithAt="@"+article.user.username,narrativeMetadata=angular.element('head > script[id="ld-narrative"]'),content=JSON.stringify([{"@context":"http://schema.org","@type":"NewsArticle",mainEntityOfPage:{"@type":"WebPage","@id":narrativeUrl},headline:article.title,image:{"@type":"ImageObject",url:imageUrl,height:1600,width:900},datePublished:"2015-02-05T08:00:00+08:00",dateModified:"2015-02-05T09:20:00+08:00",author:{"@type":"Person",name:article.user.firstname+" "+article.user.lastname},publisher:{"@type":"Organization",name:"NR8",logo:{"@type":"ImageObject",url:"https://google.com/logo.jpg",width:600,height:60}},description:article.description},{"@context":"http://schema.org","@type":"BreadcrumbList",itemListElement:[{"@type":"ListItem",position:1,item:{"@id":"https://www.nr8.com/",name:"Narratives",image:"https://www.nr8.com/"}},{"@type":"ListItem",position:2,item:{"@id":"https://www.nr8.com/"+usernameWithAt,name:usernameWithAt,image:userImageUrl}},{"@type":"ListItem",position:3,item:{"@id":narrativeUrl,name:article.title,image:imageUrl}}]}]);narrativeMetadata.length?narrativeMetadata.html(content):angular.element("head").append('<script id="ld-narrative" type="application/ld+json">'+content+"<\/script>")};$rootScope.$on("$stateChangeSuccess",function(event,toState){if("article_view"===toState.name&&$state.$current.locals["@"].article)try{updateNarrativeInformation($state.$current.locals["@"].article)}catch(e){}"article_view"!==toState.name&&angular.element('head > script[id="ld-narrative"]').remove()})}])}();
!function(){"use strict";angular.module("mean.articles").service("MetaTagService",["$window",function($window){var self=this;self.setMetaTags=function(data){return _.forOwn(data,function(value,key){var selector='head > meta[name="'+key+'"]';angular.element(selector).length||angular.element("<meta>",{name:key}).appendTo("head"),angular.element(selector).attr("content",value)}),self},self.setTitle=function(title){return angular.element("head > title").text(title),self}}])}();
!function(){"use strict";angular.module("mean.articles").service("Nr8Composer",[function(){function roundTime(time){return parseFloat(time.toFixed(1))}function getImageId(state){return"image"===state.lp.type?null===state.lp.image?null:state.lp.image.id:"video"===state.lp.type?state.lp.videoId:void 0}function mergeWithLeftEmptyState(nr8,state){return state>=1&&""===nr8.states[state-1].rp.text&&(state--,nr8.states[state].mte=nr8.states[state+1].mte,nr8.states.splice(state+1,1)),state}function mergeWithRightEmptyState(nr8,state){console.log("Deleting the right empty state.==============="),console.log(state),console.log(nr8.states.length),state<=nr8.states.length-2&&""===nr8.states[state+1].rp.text&&(nr8.states[state].mte=nr8.states[state+1].mte,nr8.states.splice(state+1,1))}this.newImageObject=function(host,id){return{host:host,id:id}},this.composeImageSegment=function(segmentId,image,duration){return{states:[{mts:0,mte:duration,seg:segmentId,lp:{type:"image",image:image},rp:{type:"text",text:"",page:"0"}}]}},this.addCoverImage=function(image,master){if(console.log("Master : ===============  ",master),master.states[0]&&master.states[0].hasOwnProperty("seg")&&-1===master.states[0].seg)console.log("addCoverImage : Found a previous cover."),master.states[0].lp.image=image;else{console.log("addCoverImage : coming here in else.");var coverSegment=this.composeImageSegment(-1,image,0);master.states.splice(0,0,coverSegment.states[0])}return master},this.addCoverToSegment=function(nr8){var cover=_.cloneDeep(nr8.states[0]);return cover.mte=0,cover.hasOwnProperty("inAnim")&&delete cover.inAnim,cover.hasOwnProperty("outAnim")&&delete cover.outAnim,cover.hasOwnProperty("inAudioT")&&delete cover.inAudioT,cover.hasOwnProperty("outAudioT")&&delete cover.outAudioT,nr8.states.splice(0,0,cover),nr8},this.isCoverAffectedBySegmentDeletion=function(coverImage,segmentsClone,segmentDeletePosition){if("text"===segmentsClone[segmentDeletePosition].states[0].lp.type)return!1;if(getImageId(segmentsClone[segmentDeletePosition].states[0])!==coverImage.id)return!1;var affected=!0;return segmentsClone.splice(segmentDeletePosition,1),segmentsClone.forEach(function(segment){if(getImageId(segment.states[0])===coverImage.id)return void(affected=!1)}),affected},this.isCoverAffectedByImageUpdate=function(coverImage,segmentsClone){var affected=!0;return segmentsClone.forEach(function(segment){if(getImageId(segment.states[0])===coverImage.id)return void(affected=!1)}),affected},this.addCustomCoverImage=function(customCoverImage,master){return master.states[0].customCoverImage=customCoverImage,master},this.retrieveCustomCoverImage=function(states){var customCoverImage=null;return states.length>0&&states[0].hasOwnProperty("seg")&&-1===states[0].seg&&(customCoverImage=states[0].customCoverImage||null),customCoverImage},this.composeVideoSegment=function(segmentId,videoId,startTime,endTime){return{states:[{mts:0,mte:roundTime(endTime-startTime),seg:segmentId,lp:{action:"change",type:"video",videoId:videoId,lts:startTime,lte:endTime},rp:{type:"text",text:"",page:0}}]}},this.composeTextSegment=function(segmentId,text,style,duration){return{states:[{mts:0,mte:duration,seg:segmentId,lp:{type:"text",text:text,style:style},rp:{type:"text",text:"",page:0}}]}},this.add_inAnim=function(nr8,animation){return null!==animation&&void 0!==animation&&nr8.states[nr8.states.length-1].mte>=animation.options.duration/1e3&&(animation.startTime=0,nr8.states[0].inAnim=animation),nr8},this.add_outAnim=function(nr8,animation){if(null!==animation&&void 0!==animation&&nr8.states[nr8.states.length-1].mte>=animation.options.duration/1e3){animation.startTime=roundTime(nr8.states[nr8.states.length-1].mte-animation.options.duration/1e3);var s=0;nr8.states.forEach(function(state,i){if(state.mts<=animation.startTime&&state.mte>animation.startTime)return void(s=i)}),nr8.states[s].outAnim=animation}return nr8},this.get_inAnim=function(nr8){var inAnim=null;return nr8.states[0].hasOwnProperty("inAnim")&&(inAnim=_.cloneDeep(nr8.states[0].inAnim),delete inAnim.startTime),inAnim},this.get_outAnim=function(nr8){var outAnim=null;return nr8.states.forEach(function(state,i){state.hasOwnProperty("outAnim")&&(outAnim=_.cloneDeep(state.outAnim),delete outAnim.startTime)}),outAnim},this.remove_inAnim=function(nr8){return nr8.states[0].hasOwnProperty("inAnim")&&delete nr8.states[0].inAnim,nr8},this.remove_outAnim=function(nr8){return nr8.states.forEach(function(state,i){state.hasOwnProperty("outAnim")&&delete state.outAnim}),nr8},this.add_inAudioT=function(nr8,audioTransition){return null!==audioTransition&&void 0!==audioTransition&&nr8.states[nr8.states.length-1].mte>=audioTransition.options.duration/1e3&&(audioTransition.startTime=0,nr8.states[0].inAudioT=audioTransition),nr8},this.add_outAudioT=function(nr8,audioTransition){if(null!==audioTransition&&void 0!==audioTransition&&nr8.states[nr8.states.length-1].mte>=audioTransition.options.duration/1e3){audioTransition.startTime=roundTime(nr8.states[nr8.states.length-1].mte-audioTransition.options.duration/1e3);var s=0;nr8.states.forEach(function(state,i){if(state.mts<=audioTransition.startTime&&state.mte>audioTransition.startTime)return void(s=i)}),nr8.states[s].outAudioT=audioTransition}return nr8},this.get_inAudioT=function(nr8){var inAudioT=null;return nr8.states[0].hasOwnProperty("inAudioT")&&(inAudioT=_.cloneDeep(nr8.states[0].inAudioT),delete inAudioT.startTime),inAudioT},this.get_outAudioT=function(nr8){var outAudioT=null;return nr8.states.forEach(function(state,i){state.hasOwnProperty("outAudioT")&&(outAudioT=_.cloneDeep(state.outAudioT),delete outAudioT.startTime)}),outAudioT},this.remove_inAudioT=function(nr8){return nr8.states[0].hasOwnProperty("inAudioT")&&delete nr8.states[0].inAudioT,nr8},this.remove_outAudioT=function(nr8){return nr8.states.forEach(function(state,i){state.hasOwnProperty("outAudioT")&&delete state.outAudioT}),nr8},this.remove_anims_audioTs=function(nr8){return nr8=this.remove_inAnim(nr8),nr8=this.remove_outAnim(nr8),nr8=this.remove_inAudioT(nr8),nr8=this.remove_outAudioT(nr8)},this.add_anims_audioTs=function(nr8,inAnim,outAnim,inAudioT,outAudioT){return nr8=this.add_inAnim(nr8,inAnim),nr8=this.add_outAnim(nr8,outAnim),nr8=this.add_inAudioT(nr8,inAudioT),nr8=this.add_outAudioT(nr8,outAudioT)},this.isNewDurationValid=function(imageNr8,duration){var delta=roundTime(duration-imageNr8.states[imageNr8.states.length-1].mte);if(duration<2)return console.log("The duration cannot be less that 2 seconds."),!1;if(0===delta)return console.log("Nothing to update. The new duration is the same as the old one."),!1;if(delta<0){delta=Math.abs(delta);var lastStateIndex=imageNr8.states.length-1,rear=0,front=0;if(""===imageNr8.states[lastStateIndex].rp.text&&(rear=roundTime(imageNr8.states[lastStateIndex].mte-imageNr8.states[lastStateIndex].mts)),lastStateIndex>0&&""===imageNr8.states[0].rp.text&&(front=imageNr8.states[0].mte),roundTime(rear+front)<delta)return console.log("Please readjust annotations at the beginning or the end and try again."),!1}return!0},this.updateSegmentDuration=function(nr8,duration){console.log("nr8 inside nr8Composer : ",_.cloneDeep(nr8));var delta=roundTime(duration-nr8.states[nr8.states.length-1].mte),lastStateIndex=nr8.states.length-1;if(0===delta)return console.log("No change in duration.",delta),{status:"notok",message:"Nothing to update",nr8:null};var inAnim=this.get_inAnim(nr8),outAnim=this.get_outAnim(nr8),inAudioT=this.get_inAudioT(nr8),outAudioT=this.get_outAudioT(nr8);if(delta>0){if(console.log("Increasing duration",delta),nr8=this.remove_anims_audioTs(nr8),""===nr8.states[lastStateIndex].rp.text)nr8.states[lastStateIndex].mte=roundTime(nr8.states[lastStateIndex].mte+delta);else{var newState=_.cloneDeep(nr8.states[lastStateIndex]);newState.rp.text="",newState.mts=nr8.states[lastStateIndex].mte,newState.mte=roundTime(nr8.states[lastStateIndex].mte+delta),nr8.states.splice(lastStateIndex+1,0,newState)}return nr8=this.add_anims_audioTs(nr8,inAnim,outAnim,inAudioT,outAudioT),{status:"ok",message:"Duration increased",nr8:nr8}}if(delta<0){delta=Math.abs(delta),console.log("Decreasing duration",delta,nr8);var rear=0,front=0;return""===nr8.states[lastStateIndex].rp.text&&(rear=roundTime(nr8.states[lastStateIndex].mte-nr8.states[lastStateIndex].mts)),(lastStateIndex>0&&""===nr8.states[0].rp.text&&(front=nr8.states[0].mte),roundTime(rear+front)<delta)?{status:"notok",message:"Please readjust annotations at the beginning or the end and try again.",nr8:null}:(nr8=this.remove_anims_audioTs(nr8),rear>0&&(rear>delta?(nr8.states[lastStateIndex].mte=roundTime(nr8.states[lastStateIndex].mte-delta),delta=0):(nr8.states.splice(lastStateIndex,1),delta=roundTime(delta-rear))),delta>0&&front>0&&lastStateIndex>0&&(nr8.states.forEach(function(state,i){state.mts=roundTime(state.mts-delta),state.mte=roundTime(state.mte-delta)}),nr8.states[0].mts=0,0===nr8.states[0].mte&&nr8.states.splice(0,1)),nr8=this.add_anims_audioTs(nr8,inAnim,outAnim,inAudioT,outAudioT),{status:"ok",message:"Duration decreased.",nr8:nr8})}},this.addAnnotation=function(nr8,state,mts,mte,text){var segmentType=nr8.states[0].lp.type;if("video"===segmentType)var delta=nr8.states[0].lp.lts;var inAnim=this.get_inAnim(nr8),outAnim=this.get_outAnim(nr8),inAudioT=this.get_inAudioT(nr8),outAudioT=this.get_outAudioT(nr8);nr8=this.remove_anims_audioTs(nr8),nr8.states[state].rp.text="",mts!==nr8.states[state].mts&&(state=mergeWithLeftEmptyState(nr8,state)),mte!==nr8.states[state].mte&&mergeWithRightEmptyState(nr8,state);var oldState=_.cloneDeep(nr8.states[state]),position=state;if(roundTime(mts-oldState.mts)<=0)nr8.states[position].rp.text=text;else{nr8.states[position].mte=mts;var newState=_.cloneDeep(oldState);newState.mts=mts,newState.mte=mte,newState.rp.text=text,nr8.states.splice(position+1,0,newState),position++}roundTime(oldState.mte-mte)>0&&(nr8.states[position].mte=mte,oldState.mts=nr8.states[position].mte,nr8.states.splice(position+1,0,oldState));var statesArrayNew=[],newIndex=0,stateNew=null,page=0;return"video"===segmentType?(nr8.states.forEach(function(state,i){stateNew=_.cloneDeep(state),stateNew.lp.action="cont",stateNew.lp.type="video",stateNew.lp.lts=roundTime(state.mts+delta),stateNew.lp.lte=roundTime(state.mte+delta),0!==newIndex&&stateNew.rp.text===statesArrayNew[newIndex-1].rp.text?(statesArrayNew[newIndex-1].lp.lte=stateNew.lp.lte,statesArrayNew[newIndex-1].mte=stateNew.mte):(""!==stateNew.rp.text&&page++,stateNew.rp.page=page,statesArrayNew[newIndex++]=stateNew)}),nr8.states=statesArrayNew,nr8.states[0].lp.action="change"):"image"!==segmentType&&"text"!==segmentType||(nr8.states.forEach(function(state,i){stateNew=_.cloneDeep(state),stateNew.lp.type=segmentType,0!==newIndex&&stateNew.rp.text===statesArrayNew[newIndex-1].rp.text?statesArrayNew[newIndex-1].mte=stateNew.mte:(""!==stateNew.rp.text&&page++,stateNew.rp.page=page,statesArrayNew[newIndex++]=stateNew)}),nr8.states=statesArrayNew),nr8=this.add_anims_audioTs(nr8,inAnim,outAnim,inAudioT,outAudioT)},this.deleteAnnotation=function(nr8,state){var segmentType=nr8.states[0].lp.type;if("video"===segmentType)var delta=nr8.states[0].lp.lts;var inAnim=this.get_inAnim(nr8),outAnim=this.get_outAnim(nr8),inAudioT=this.get_inAudioT(nr8),outAudioT=this.get_outAudioT(nr8);nr8=this.remove_anims_audioTs(nr8),nr8.states[state].rp.text="",state=mergeWithLeftEmptyState(nr8,state),mergeWithRightEmptyState(nr8,state);var page=0;return"video"===segmentType?nr8.states.forEach(function(state,i){state.lp.lts=roundTime(state.mts+delta),state.lp.lte=roundTime(state.mte+delta),""!==state.rp.text&&page++,state.rp.page=page}):"image"===segmentType&&nr8.states.forEach(function(state,i){""!==state.rp.text&&page++,state.rp.page=page}),nr8=this.add_anims_audioTs(nr8,inAnim,outAnim,inAudioT,outAudioT)},this.hasAnnotatedArea=function(nr8){var hasAnnotatedArea=!1;return nr8.states.forEach(function(state,i){if(""!==state.rp.text)return void(hasAnnotatedArea=!0)}),hasAnnotatedArea},this.hasNonAnnotatedArea=function(nr8){var hasNonAnnotatedArea=!1;return nr8.states.forEach(function(state,i){if(""===state.rp.text)return void(hasNonAnnotatedArea=!0)}),hasNonAnnotatedArea},this.mergeWithSource=function(nr8,duration){var newState;return 0!==nr8.states[0].lp.lts&&(""===nr8.states[0].rp.text?nr8.states[0].lp.lts=0:(newState=_.cloneDeep(nr8.states[0]),newState.lp.lts=0,newState.lp.lte=nr8.states[0].lp.lts,newState.rp.text="",nr8.states.splice(0,0,newState)),nr8.states.forEach(function(state,i){state.mts=state.lp.lts,state.mte=state.lp.lte})),nr8.states[nr8.states.length-1].lp.lte!==duration&&(""===nr8.states[nr8.states.length-1].rp.text?(nr8.states[nr8.states.length-1].lp.lte=duration,nr8.states[nr8.states.length-1].mte=duration):(newState=_.cloneDeep(nr8.states[nr8.states.length-1]),newState.lp.lts=nr8.states[nr8.states.length-1].lp.lte,newState.mts=nr8.states[nr8.states.length-1].mte,newState.lp.lte=duration,newState.mte=duration,newState.rp.text="",nr8.states.push(newState))),nr8},this.retrieveSources=function(states,includeDummies){var sources=[],source=null,start=null,end=null,segmentGroups=_.groupBy(states,function(state){return state.seg});return _.values(segmentGroups).forEach(function(segment,i){"video"===segment[0].lp.type&&""!==segment[0].lp.videoId&&(start=segment[0].lp.lts,end=segment[segment.length-1].lp.lte,(includeDummies||!includeDummies&&0!==end)&&(source=_.find(sources,function(source){return source.sourceId===segment[0].lp.videoId}),source?source.meta.push({segmentId:segment[0].seg,start:start,end:end}):sources.push({sourceId:segment[0].lp.videoId,meta:[{segmentId:segment[0].seg,start:start,end:end}]})))}),sources},this.retrieveImages=function(states,withCover,withYtImages){var images=[],segmentGroups=_.groupBy(states,function(state){return state.seg}),segmentsArray=_.values(segmentGroups),imageFound=!1,image=null,coverImage=null;return segmentsArray.forEach(function(segment,i){-1===segment[0].seg?withCover&&(coverImage=segment[0].lp.image):withYtImages&&"video"===segment[0].lp.type&&""!==segment[0].lp.videoId?(imageFound=_.find(images,function(image){return image.id===segment[0].lp.videoId}),imageFound?console.log("Found a duplicate : ",segment[0].lp.videoId):(image={host:"yt",id:segment[0].lp.videoId},images.push(image))):"image"===segment[0].lp.type&&null!==segment[0].lp.image&&((imageFound=_.find(images,function(image){return image.id===segment[0].lp.image.id}))||(image={host:"is",id:segment[0].lp.image.id},images.push(image)))}),coverImage&&images.splice(0,0,coverImage),images},this.getSourceIdFromNr8=function(nr8){return nr8.states[0].lp.videoId},this.recomposeWithNewSourceTimes=function(oldNr8,newStartTime,newEndTime,inAnim,outAnim,inAudioT,outAudioT){var newState=null;return 1===oldNr8.states.length&&""===oldNr8.states[0].rp.text?(console.log("No annotation ==========================="),oldNr8.states[0].lp.lts=newStartTime,oldNr8.states[0].lp.lte=newEndTime):(newStartTime!==oldNr8.states[0].lp.lts&&(newStartTime<oldNr8.states[0].lp.lts?""===oldNr8.states[0].rp.text?oldNr8.states[0].lp.lts=newStartTime:(newState=_.cloneDeep(oldNr8.states[0]),newState.lp.lts=newStartTime,newState.lp.lte=oldNr8.states[0].lp.lts,newState.rp.text=""):oldNr8.states[0].lp.lts=newStartTime),newEndTime!==oldNr8.states[oldNr8.states.length-1].lp.lte&&(newEndTime>oldNr8.states[oldNr8.states.length-1].lp.lte?""===oldNr8.states[oldNr8.states.length-1].rp.text?oldNr8.states[oldNr8.states.length-1].lp.lte=newEndTime:(newState=_.cloneDeep(oldNr8.states[oldNr8.states.length-1]),newState.lp.lts=oldNr8.states[oldNr8.states.length-1].lp.lte,newState.lp.lte=newEndTime,newState.rp.text=""):oldNr8.states[oldNr8.states.length-1].lp.lte=newEndTime)),oldNr8.states.forEach(function(state,i){state.mts=roundTime(state.lp.lts-newStartTime),state.mte=roundTime(state.lp.lte-newStartTime)}),oldNr8=this.add_anims_audioTs(oldNr8,inAnim,outAnim,inAudioT,outAudioT)},this.isEmpty=function(article){if(-1===article.title.indexOf("Untitled narrative"))return!1;if(article.hasOwnProperty("content")&&void 0!==article.content&&""!==article.content)return!1;if(article.actions.states[0].hasOwnProperty("customCoverImage"))return!1;for(var state=null,i=1;i<article.actions.states.length;i++){if(state=article.actions.states[i],"video"===state.lp.type&&""!==state.lp.videoId)return!1;if("image"===state.lp.type&&null!==state.lp.image)return!1;if("text"===state.lp.type&&""!==state.lp.text)return!1}return!0},this.isPublishable=function(article,placeholderId){var missing=[];article.title.indexOf("Untitled narrative")>-1&&missing.push("title (describe tab)"),article.actions.states[0].lp.image.id===placeholderId&&missing.push("cover image (describe tab)"),article.actions.states[article.actions.states.length-1].mte<=0&&missing.push(" valid segment (create tab)");var returnString="";return 0===missing.length?returnString="true":(returnString="Please add the following items before you can publish it : ",missing.forEach(function(item,i){0!==i&&i!==missing.length-1?returnString+=", ":0!==i&&i===missing.length-1&&(returnString+=" and "),returnString+=item,i===missing.length-1&&(returnString+=".")})),returnString},this.setVideoSegmentAsUnavailable=function(nr8){return nr8.states.forEach(function(state){state.lp.unavailable=!0}),nr8},this.isContentMissing=function(segments){for(var i=0;i<segments.length;i++)if(console.log("segment to be checked : ",segments[i]),segments[i].states[0].lp.unavailable)return!0;return!1},this.retrieveSegmentsData=function(segments){var allSegmentsCount=0,videoSegmentsCount=0,textSegmentsCount=0,imageSegmentsCount=0;return segments.forEach(function(segment){allSegmentsCount++,console.log("segment : ",segment),"video"===segment.states[0].lp.type?videoSegmentsCount++:"text"===segment.states[0].lp.type?textSegmentsCount++:"image"===segment.states[0].lp.type&&imageSegmentsCount++}),{allSegmentsCount:allSegmentsCount,videoSegmentsCount:videoSegmentsCount,textSegmentsCount:textSegmentsCount,imageSegmentsCount:imageSegmentsCount}},this.retrieveSegments=function(states){var offset=0,page=0,masterPagesStart=null,masterPagesEnd=null,masterPageNumberInfo="",annotations=0;states.length>0&&-1===states[0].seg&&(console.log("Discarding the cover segment."),states.splice(0,1));var segmentGroups=_.groupBy(states,function(state){return state.seg}),segmentsArray=_.values(segmentGroups);return segmentsArray.forEach(function(segment,i){offset=segment[0].mts,page=0,masterPagesStart=null,masterPagesEnd=null,segment.forEach(function(state,j){state.mts=roundTime(state.mts-offset),state.mte=roundTime(state.mte-offset),state.hasOwnProperty("inAnim")&&(state.inAnim.startTime=roundTime(state.inAnim.startTime-offset)),state.hasOwnProperty("outAnim")&&(state.outAnim.startTime=roundTime(state.outAnim.startTime-offset)),state.hasOwnProperty("inAudioT")&&(state.inAudioT.startTime=roundTime(state.inAudioT.startTime-offset)),state.hasOwnProperty("outAudioT")&&(state.outAudioT.startTime=roundTime(state.outAudioT.startTime-offset)),state.seg=i,""!==state.rp.text&&(null===masterPagesStart?(masterPagesStart=state.rp.page,masterPagesEnd=state.rp.page):masterPagesEnd=state.rp.page),""!==state.rp.text&&page++,state.rp.page=page}),null===masterPagesStart?(masterPageNumberInfo="none",annotations=0):(annotations=masterPagesEnd-masterPagesStart+1,masterPageNumberInfo=masterPagesStart===masterPagesEnd?masterPagesStart.toString():masterPagesStart.toString()+"-"+masterPagesEnd.toString());var meta={segmentId:segment[0].seg,type:segment[0].lp.type,mastertime:offset,duration:segment[segment.length-1].mte,masterPageNumberInfo:masterPageNumberInfo,annotations:annotations};segmentsArray[i]={states:segment,meta:meta}}),segmentsArray},this.composeMaster=function(coverImage,customCoverImage,segments){var newState,newStates=[],offset=0,page=0,annotation="",masterPagesStart=null,masterPagesEnd=null,masterPageNumbersInfo="";segments.forEach(function(segment,i){masterPagesStart=null,masterPagesEnd=null,masterPageNumbersInfo="",segment.states.forEach(function(state,j){newState=_.cloneDeep(state),newState.mts=roundTime(newState.mts+offset),newState.mte=roundTime(newState.mte+offset),newState.hasOwnProperty("inAnim")&&(newState.inAnim.startTime=newState.mts),newState.hasOwnProperty("outAnim")&&(newState.outAnim.startTime=newState.outAnim.startTime+offset),newState.hasOwnProperty("inAudioT")&&(newState.inAudioT.startTime=newState.mts),newState.hasOwnProperty("outAudioT")&&(newState.outAudioT.startTime=newState.outAudioT.startTime+offset),""===newState.rp.text?(newState.rp.page=page.toString(),annotation=""):(newState.rp.text!==annotation&&(page++,annotation=newState.rp.text),newState.rp.page=page.toString()),newStates.push(newState),""!==state.rp.text&&(null===masterPagesStart?(masterPagesStart=newState.rp.page,masterPagesEnd=newState.rp.page):masterPagesEnd=newState.rp.page)}),offset=newState.mte,segment.hasOwnProperty("meta")&&(null===masterPagesStart?(segment.meta.masterPageNumberInfo="none",segment.meta.annotations=0):(segment.meta.annotations=masterPagesEnd-masterPagesStart+1,segment.meta.masterPageNumberInfo=masterPagesStart===masterPagesEnd?masterPagesStart.toString():masterPagesStart.toString()+"-"+masterPagesEnd.toString()))});var master={states:newStates};return coverImage&&(master=this.addCoverImage(coverImage,master)),customCoverImage&&(master=this.addCustomCoverImage(customCoverImage,master)),master}}])}();
!function(){"use strict";angular.module("mean.articles").factory("Nr8ServiceFactory",["$timeout","Nr8Composer",function($timeout,Nr8Composer){function Nr8ServiceFactory(){this.create=function(){return new Nr8Service}}function Nr8Service(){function syncVideoPosition(playState){if(console.log("syncVideoPosition"),"video"===states[currentState].lp.type){var videoDelta=currentTime/1e3-states[currentState].mts;fireEvent("nr8ContentUpdate",{update:"videoPosition",playState:playState,seekPosition:states[currentState].lp.lts+videoDelta,caller:"nr8"})}}function changeState(playState,normalPlayback){if(console.log("inside change state"),handle_outAnim=!0,handle_outAudioT=!0,"text"===states[currentState].lp.type&&(currentTransitionText!==states[currentState].lp.text||currentStyle.hasOwnProperty("theme")&&currentStyle.theme!==states[currentState].lp.style.theme||currentStyle.hasOwnProperty("font")&&currentStyle.font!==states[currentState].lp.style.font)){console.log("Inside transition change"),currentImageKeyIndex=-1,currentKeyIndex=-1,currentTransitionText=states[currentState].lp.text,currentStyle=states[currentState].lp.style||null;var transitionUpdateInfo={update:"transition",playState:playState,transitionText:currentTransitionText,style:currentStyle,caller:"nr8"};normalPlayback&&states[currentState].hasOwnProperty("inAnim")&&(transitionUpdateInfo.inAnim=states[currentState].inAnim),fireEvent("nr8ContentUpdate",transitionUpdateInfo)}else if("video"===states[currentState].lp.type)if(currentKeyIndex!==states[currentState].keyIndex){console.log("changestate video - new videokey"),currentImageKeyIndex=-1,currentTransitionText="",currentStyle=null,currentKeyIndex=states[currentState].keyIndex;var videoUpdateInfo={update:"video",playState:playState,keyIndex:states[currentState].keyIndex,caller:"nr8"};normalPlayback&&states[currentState].hasOwnProperty("inAnim")&&(videoUpdateInfo.inAnim=states[currentState].inAnim),normalPlayback&&states[currentState].hasOwnProperty("inAudioT")&&(videoUpdateInfo.inAudioT=states[currentState].inAudioT),videoUpdateInfo.seekPosition=states[currentState].lp.lts,playState&&normalPlayback||(videoUpdateInfo.seekPosition=states[currentState].lp.lts+(currentTime/1e3-states[currentState].mts)),fireEvent("nr8ContentUpdate",videoUpdateInfo),$timeout.cancel(promise),timerRunning=0,timerSuspended=0}else if(0===currentTime){if(normalPlayback&&(states[currentState].hasOwnProperty("inAnim")||states[currentState].hasOwnProperty("inAudioT"))){var animationAudioTUpdateInfo={segmentType:states[currentState].lp.type,caller:"nr8",keyIndex:states[currentState].keyIndex};states[currentState].hasOwnProperty("inAnim")&&states[currentState].hasOwnProperty("inAudioT")?(animationAudioTUpdateInfo.update="animationAndAudioT",animationAudioTUpdateInfo.inAnim=states[currentState].inAnim,animationAudioTUpdateInfo.inAudioT=states[currentState].inAudioT):states[currentState].hasOwnProperty("inAnim")?(animationAudioTUpdateInfo.update="animation",animationAudioTUpdateInfo.inAnim=states[currentState].inAnim):states[currentState].hasOwnProperty("inAudioT")&&(animationAudioTUpdateInfo.update="audioT",animationAudioTUpdateInfo.inAudioT=states[currentState].inAudioT),fireEvent("nr8ContentUpdate",animationAudioTUpdateInfo)}}else"cont"!==states[currentState].lp.action&&0!==currentTime&&(console.log("changestate video same videokey but different lts"),fireEvent("nr8ContentUpdate",{update:"videoPosition",playState:playState,seekPosition:states[currentState].lp.lts+(currentTime/1e3-states[currentState].mts),caller:"nr8"}));else if("image"===states[currentState].lp.type&&currentImageKeyIndex!==states[currentState].imageKeyIndex){currentKeyIndex=-1,currentTransitionText="",currentStyle=null,currentImageKeyIndex=states[currentState].imageKeyIndex,console.log("Image found ^^^^^^^^^^^^^^^^^^^ ",currentImageKeyIndex);var imageUpdateInfo={update:"image",playState:playState,imageKeyIndex:currentImageKeyIndex,caller:"nr8"};normalPlayback&&states[currentState].hasOwnProperty("inAnim")&&(imageUpdateInfo.inAnim=states[currentState].inAnim),fireEvent("nr8ContentUpdate",imageUpdateInfo)}if("text"===states[currentState].rp.type&&currentAnnotationText!==states[currentState].rp.text){console.log("Inside text change---------------------------------"),currentPage=states[currentState].rp.page,currentAnnotationText=states[currentState].rp.text;var isAnnotationEmpty=!0;""!==currentAnnotationText&&(isAnnotationEmpty=!1),fireEvent("nr8ContentUpdate",{update:"text",annotationText:currentAnnotationText,isAnnotationEmpty:isAnnotationEmpty,currentPage:currentPage,totalPages:totalPages,caller:"nr8"})}}function end(){if(handle_outAnim=!0,handle_outAudioT=!0,timerRunning=currentState=currentTime=timeoutValue=0,currentTransitionText=currentAnnotationText="",fireEvent("nr8ControlUpdate",{update:"ended",caller:"nr8"}),"image"===states[0].lp.type)currentImageKeyIndex=states[0].imageKeyIndex,fireEvent("nr8ContentUpdate",{update:"image",playState:timerRunning,imageKeyIndex:currentImageKeyIndex,cover:!0,caller:"nr8"});else if("video"===states[0].lp.type){var potentialVideoSegEditAfterOutAnim=!1;-1===currentKeyIndex&&(potentialVideoSegEditAfterOutAnim=!0),fireEvent("nr8ContentUpdate",{update:"video",playState:timerRunning,keyIndex:states[currentState].keyIndex,seekPosition:states[0].lp.lts,potentialVideoSegEditAfterOutAnim:potentialVideoSegEditAfterOutAnim,caller:"nr8"}),currentKeyIndex=states[0].keyIndex}else"text"===states[0].lp.type&&""!==states[0].lp.text&&(currentTransitionText=states[0].lp.text,currentStyle=states[0].lp.style,fireEvent("nr8ContentUpdate",{update:"transition",playState:0,transitionText:currentTransitionText,style:currentStyle,caller:"nr8"}));if(currentPage=states[0].rp.page,"text"===states[0].rp.type){currentAnnotationText=states[0].rp.text;""!==currentAnnotationText&&!1,fireEvent("nr8ContentUpdate",{update:"text",annotationText:states[0].rp.text,currentPage:currentPage,totalPages:totalPages,caller:"nr8"})}currentStyle=null,currentKeyIndex=-1,currentImageKeyIndex=-1,currentTransitionText="","video"===states[0].lp.type&&(currentKeyIndex=states[currentState].keyIndex)}function timer(lastTimeStamp){var timeElapsed=0;lastTimeStamp&&(timeElapsed=parseInt((new Date).getTime()-lastTimeStamp));var newTimeStamp=(new Date).getTime();if((!timeElapsed||timeElapsed>2e3)&&(timeElapsed=timeoutValue),currentTime+timeElapsed>=1e3*states[currentState].mte&&(timeElapsed=1e3*states[currentState].mte-currentTime),accumulator+=timeElapsed,accumulator>=accumulatorMaxValue&&(fireEvent("playTimeUpdate",{duration:accumulator}),accumulator=0),currentTime+=timeElapsed,currentTimeSec=currentTime/1e3,fireEvent("nr8ControlUpdate",{update:"progressAndTimeUpdate",progressPercent:currentTime/(1e3*totalTime)*100,playerTime:currentTimeSec,caller:"nr8"}),handle_outAnim&&states[currentState].hasOwnProperty("outAnim")&&currentTime>=1e3*states[currentState].outAnim.startTime&&("video"===states[currentState].lp.type?currentKeyIndex=-1:"image"===states[currentState].lp.type?currentImageKeyIndex=-1:"text"===states[currentState].lp.type&&(currentTransitionText=""),fireEvent("nr8ContentUpdate",{update:"animation",segmentType:states[currentState].lp.type,outAnim:states[currentState].outAnim,caller:"nr8"}),handle_outAnim=!1),handle_outAudioT&&states[currentState].hasOwnProperty("outAudioT")&&currentTime>=1e3*states[currentState].outAudioT.startTime){var audioTUpdateInfo={update:"audioT",segmentType:states[currentState].lp.type,outAudioT:states[currentState].outAudioT,caller:"nr8"};"video"===states[currentState].lp.type&&(audioTUpdateInfo.keyIndex=states[currentState].keyIndex),fireEvent("nr8ContentUpdate",audioTUpdateInfo),handle_outAudioT=!1}if(currentTime>=1e3*states[currentState].mte)if(currentTimeSec<totalTime){for(currentState++;states[currentState].mts===states[currentState].mte&&currentState<states.length-1;)currentState++;changeState(timerRunning,!0)}else{if(!loop)return void end();currentState=currentTime=0,handle_outAnim=handle_outAudioT=!0}timeoutValue=defaultTimeoutValue,1e3*states[currentState].mte-currentTime<timeoutValue&&(timeoutValue=1e3*states[currentState].mte-currentTime),handle_outAnim&&states[currentState].hasOwnProperty("outAnim")&&1e3*states[currentState].outAnim.startTime-currentTime<timeoutValue&&(timeoutValue=1e3*states[currentState].outAnim.startTime-currentTime),handle_outAudioT&&states[currentState].hasOwnProperty("outAudioT")&&1e3*states[currentState].outAudioT.startTime-currentTime<timeoutValue&&(timeoutValue=1e3*states[currentState].outAudioT.startTime-currentTime),timerRunning&&(promise=$timeout(function(){timer(newTimeStamp)},timeoutValue))}function fireEvent(eventName,context){var eventHandlers=handlers[eventName];if(void 0!==eventHandlers)for(var i in eventHandlers)eventHandlers[i](context)}var states,promise,currentImageKeyIndex=-1,currentKeyIndex=-1,currentTransitionText="",currentStyle=null,currentAnnotationText="",totalTime=0,totalPages=0,currentTime=0,currentTimeSec=0,currentPage=0,timeoutValue=0,defaultTimeoutValue=200,accumulatorMaxValue=5e3,accumulator=0,currentState=0,timerRunning=0,timerSuspended=0,handle_outAnim=!0,handle_outAudioT=!0,videoKeys=[],imageKeys=[],audioKeys=["/api/audio/574857db14009a0fce5a844c/file/01-04-%20Times%20Like%20These.mp3"],handlers={nr8ControlUpdate:[],nr8ContentUpdate:[],playTimeUpdate:[]},loop=!1;this.initialize=function(actions){console.log("The states are ========= ",actions.states),states=_.cloneDeep(actions.states),currentState=0,videoKeys=[];var videoKey=null;if(imageKeys=[],totalTime=states[states.length-1].mte,currentAnnotationText=states[currentState].rp.text,totalPages=states[states.length-1].rp.page,1===states.length&&"video"===states[0].lp.type&&0===states[0].mte)videoKeys[0]=states[0].lp.videoId+"&"+states[0].lp.lts;else{var keyIndex=0,imageKeyIndex=0,segmentGroups=_.groupBy(states,function(state){return state.seg});_.values(segmentGroups).forEach(function(segment,i){"video"===segment[0].lp.type&&segment.length>1&&segment[0].mts===segment[0].mte&&console.log("Please do not comment out this line. This is an error condition and should not be reached. WWWWWWWWWWWWWWWWWWW"),"video"===segment[0].lp.type&&segment[0].mts<segment[segment.length-1].mte?(videoKey=segment[0].lp.videoId+"&"+segment[0].lp.lts,keyIndex=_.indexOf(videoKeys,videoKey),-1!==keyIndex?segment.forEach(function(state){state.keyIndex=keyIndex}):(keyIndex=videoKeys.length,videoKeys[keyIndex]=segment[0].lp.videoId+"&"+segment[0].lp.lts,segment.forEach(function(state){state.keyIndex=keyIndex}))):"image"===segment[0].lp.type&&null!==segment[0].lp.image&&(imageKeys[imageKeyIndex]=segment[0].lp.image.host+"&"+segment[0].lp.image.id,segment.forEach(function(state){state.imageKeyIndex=imageKeyIndex}),imageKeyIndex++)})}console.log("Image keys are ============== &&&&&&&&&&&&&&&&& : ",imageKeys);var initData={videoKeys:videoKeys,imageKeys:imageKeys,audioKeys:audioKeys,initialPlayTime:totalTime,annotationText:currentAnnotationText,currentPage:states[currentState].rp.page,totalPages:totalPages};return"image"===states[currentState].lp.type?(initData.coverType="image",initData.coverImage=imageKeys[states[currentState].imageKeyIndex]):"text"===states[currentState].lp.type&&""!==states[currentState].lp.text?(initData.coverType="text",currentStyle=states[currentState].lp.style||null,initData.coverTransition=states[currentState].lp.text,initData.coverTransitionStyle=currentStyle):"video"===states[currentState].lp.type&&(initData.coverType="video",currentKeyIndex=states[currentState].keyIndex,initData.initialYtVolume=100,states.length>1&&states[currentState+1].hasOwnProperty("inAudioT")&&(initData.initialYtVolume=0)),console.log("videoKeys array in nr8Service : ",videoKeys),initData},this.getAnticipatedVideoKey=function(seekTo){if(!seekTo||seekTo<0||seekTo>states[states.length-1].mte)return console.log("anticipatedVideoKey : seekTo value is undefined or invalid"),videoKeys[0];for(var sendNextVideoKey=!1,i=0;i<states.length-1;i++){if(sendNextVideoKey&&"video"===states[i].lp.type)return states[i].lp.videoId+"&"+states[i].lp.lts;if(states[i].mts<=seekTo&&seekTo<=states[i].mte){if("video"===states[i].lp.type)return states[i].lp.videoId+"&"+states[i].lp.lts;sendNextVideoKey=!0}}return videoKeys[0]},this.seek=function(seekTo,actualTime){if(!0===actualTime?(currentTime=1e3*seekTo,currentTimeSec=seekTo):(currentTimeSec=seekTo/100*totalTime,currentTime=1e3*currentTimeSec),1===timerRunning&&($timeout.cancel(promise),timerRunning=0,timerSuspended=1),fireEvent("nr8ControlUpdate",{update:"timeUpdate",playerTime:currentTimeSec,caller:"nr8"}),currentTimeSec>=totalTime)return void end();if(currentTimeSec>=states[currentState].mts&&currentTimeSec<states[currentState].mte)"video"===states[currentState].lp.type&&syncVideoPosition(timerSuspended);else{for(currentState=0;currentState<states.length&&!(currentTimeSec>=states[currentState].mts&&currentTimeSec<states[currentState].mte);currentState++);changeState(timerSuspended,!1)}1===timerSuspended&&0===timerRunning&&(timerRunning=1,timer(),timerSuspended=0)},this.getInfoAtPosition=function(positionPercent){var infoAtPosition=null,positionTimeSec=positionPercent/100*totalTime;return positionTimeSec<0||totalTime<positionTimeSec?infoAtPosition:(infoAtPosition={},states.forEach(function(state,i){state.mts<=positionTimeSec&&positionTimeSec<=state.mte&&(infoAtPosition.type=state.lp.type,"video"===state.lp.type&&(infoAtPosition.videoKey=videoKeys[state.keyIndex],infoAtPosition.seekPosition=state.lp.lts+(currentTimeSec-state.mts)))}),infoAtPosition)},this.begin=function(){1!==timerRunning&&(timerRunning=1,timer())},this.pause=function(){0!==timerRunning&&($timeout.cancel(promise),timerRunning=0)},this.suspend=function(){0!==timerRunning&&($timeout.cancel(promise),timerRunning=0)},this.externalSeekRequest=function(seekToSeconds){fireEvent("nr8ControlUpdate",{update:"progressUpdate",progressPercent:seekToSeconds/totalTime*100,caller:"nr8"}),this.seek(seekToSeconds,!0)},this.scrollAnnotation=function(direction){var statesArrayIndex,currentPageNum=parseInt(states[currentState].rp.page);if(0===currentTimeSec&&"left"===direction)return void end();if("left"===direction)for(statesArrayIndex=0;parseInt(states[statesArrayIndex].rp.page)<currentPageNum-1;)statesArrayIndex++;else if("right"===direction)for(statesArrayIndex=currentState;parseInt(states[statesArrayIndex].rp.page)===currentPageNum;)statesArrayIndex++;this.externalSeekRequest(states[statesArrayIndex].mts)},this.durationUpdate=function(updatedNr8,caller){this.initialize(updatedNr8),fireEvent("nr8ControlUpdate",{update:"durationUpdate",duration:totalTime,caller:caller})},this.resetAndUpdate=function(updatedNr8,caller){this.suspend(),timerRunning=currentState=currentTime=timeoutValue=0,currentTransitionText=currentAnnotationText="",currentStyle=null,currentKeyIndex=-1,currentImageKeyIndex=-1,fireEvent("nr8ControlUpdate",{update:"reset",caller:"nr8"}),fireEvent("nr8ControlUpdate",{update:"progressUpdate",progressPercent:0,caller:"nr8"}),fireEvent("nr8ControlUpdate",{update:"initUpdate",initData:this.initialize(updatedNr8),caller:caller})},this.setLoop=function(value){loop=value},this.on=function(eventName,handler){if(void 0===handlers[eventName])throw"Event "+eventName+" does not exist.";handlers[eventName].push(handler)}}return new Nr8ServiceFactory}])}();
!function(){"use strict";angular.module("mean.articles").service("OembedService",["$rootScope","$state",function($rootScope,$state){var removeOembedDisco=function(){angular.element('head > link[type="application/json+oembed"]').remove(),angular.element('head > link[type="text/xml+oembed"]').remove()},createOrUpdate=function(element,narrativeUrl,format,title){var href=narrativeUrl+"&format="+format,contentType="json"===format?"application/json+oembed":"text/xml+oembed";if(0===element.length){var html='<link rel="alternate" type="'+contentType+'"';html+=' href="'+href+'" title="'+title+'" />',angular.element("head").append(html)}else element.attr("title",title).attr("href",href)},updateOembedDisco=function(article){var narrativeUrl="https://www.nr8.com/oembed?url="+encodeURIComponent("https://www.nr8.com/embed/"+article._id),ombedJson=angular.element('head > link[type="application/json+oembed"]'),ombedXml=angular.element('head > link[type="text/xml+oembed"]');createOrUpdate(ombedJson,narrativeUrl,"json",article.title),createOrUpdate(ombedXml,narrativeUrl,"xml",article.title)};return $rootScope.$on("$stateChangeSuccess",function(event,toState){"article_view"===toState.name&&updateOembedDisco($state.$current.locals["@"].article),"article_view"!==toState.name&&removeOembedDisco()}),!0}])}();
!function(){"use strict";angular.module("mean.articles").service("TranscriptService",[function(){this.supportedLang=[{lang:"Arabic"},{lang:"Bengali"},{lang:"Chinese"},{lang:"English"},{lang:"French"},{lang:"German"},{lang:"Greek"},{lang:"Gujarati"},{lang:"Hebrew"},{lang:"Hindi"},{lang:"Italian"},{lang:"Kannada"},{lang:"Malayalam"},{lang:"Marathi"},{lang:"Portuguese"},{lang:"Punjabi"},{lang:"Russian"},{lang:"Slovak"},{lang:"Spanish"},{lang:"Tamil"},{lang:"Telugu"}],this.parseText=function(lang,content){var returnData={language:lang,content:content,transcription:[]};if(content&&null!=content&&""!=content){var sentances=[],paragraphs=[],currentTime="",paraIndex=1,sentanceIndex=1;paragraphs=content.split(/\n/g),console.log("===> lang, paragraphs length ==> ",lang,paragraphs);for(var i=0;i<paragraphs.length;i++)if(paragraphs[i]&&""!=paragraphs[i]&&!_.isEmpty(paragraphs[i])){sentances=paragraphs[i].split(/\[([^[]*)\]/g),sentanceIndex=1;var timestampFormat=this.filterTimeSlots(sentances),paraUpdated=!1;if(timestampFormat)if(timestampFormat.length>1)for(var j=0;j<timestampFormat.length;j++)if(0==i&&0==j)currentTime=this.isDuration(timestampFormat[j],!1)?timestampFormat[j]:"00:00";else{var paragraphSentancedata={paragraph:paraIndex,sentence:sentanceIndex,start:"",end:"",text:""};if(!this.isDuration(timestampFormat[j],!0)){var takeSantanceWithTime=this.formatSantanceWithTime(currentTime,i,j,paragraphs);takeSantanceWithTime.end&&""!=takeSantanceWithTime.end&&(currentTime=takeSantanceWithTime.end),takeSantanceWithTime.text&&""!=takeSantanceWithTime.text&&(paragraphSentancedata.text=takeSantanceWithTime.text,paragraphSentancedata.start=""!=takeSantanceWithTime.start?takeSantanceWithTime.start:paragraphSentancedata.start,paragraphSentancedata.end=takeSantanceWithTime.end,returnData.transcription.push(paragraphSentancedata),sentanceIndex++,paraUpdated=!0)}}else{0==i&&(currentTime=this.isDuration(timestampFormat[j],!1)?timestampFormat[j]:"00:00");var paragraphSentancedata={paragraph:paraIndex,sentence:sentanceIndex,start:"",end:"",text:""},takeSantanceWithTime=this.formatSantanceWithTime(currentTime,i,0,paragraphs);takeSantanceWithTime.end&&""!=takeSantanceWithTime.end&&(currentTime=takeSantanceWithTime.end),takeSantanceWithTime.text&&""!=takeSantanceWithTime.text&&(paragraphSentancedata.text=takeSantanceWithTime.text,paragraphSentancedata.start=""!=takeSantanceWithTime.start?takeSantanceWithTime.start:paragraphSentancedata.start,paragraphSentancedata.end=takeSantanceWithTime.end,returnData.transcription.push(paragraphSentancedata),sentanceIndex++,paraUpdated=!0)}paraUpdated&&paraIndex++}console.log("===> returnData ==> ",returnData)}return returnData},this.filterTimeSlots=function(sentances){var returnData=sentances,sentanceData=[];if(console.log("===> filterTimeSlots sentances ==> ",sentances),returnData&&null!=returnData&&returnData.length>0){for(var i=0,index=0;i<sentances.length;i++)if(sentances[i]=sentances[i].trim(),sentances[i]&&null!=sentances[i]&&""!=sentances[i]){if(0==index){var duration=this.isValidDuration(sentances[i]);!1!==duration?sentanceData.push(duration):sentanceData.push("00:00"),index++;continue}if(index>0&&sentanceData.length>0&&this.isDuration(sentanceData[index-1],!1)&&this.isDuration(sentances[i],!1))continue;if(-1==_.findIndex(sentanceData,function(val){return val==sentances[i]}))if(this.isDuration(sentances[i],!1)){var duration=this.isValidDuration(sentances[i]);!1!==duration&&(sentanceData.push(duration),index++)}else sentanceData.push(sentances[i]),index++}returnData=sentanceData}return console.log("===> filterTimeSlots return ==> ",returnData),returnData},this.isDuration=function(duration,debug){var returnData=!1;return 1==(duration.match(/:/g)||[]).length&&(returnData=!0),returnData},this.isValidDuration=function(duration){var returnData=!1,count=(duration.match(/:/g)||[]).length;if(duration&&null!=duration&&1==count){var hour_minute_seconds=duration.split(":");hour_minute_seconds&&hour_minute_seconds[0];hour_minute_seconds&&hour_minute_seconds[0]&&!isNaN(hour_minute_seconds[0])&&hour_minute_seconds[1]&&!isNaN(hour_minute_seconds[1])&&(returnData=duration)}return returnData},this.formatSantanceWithTime=function(currentTime,paragraphIndex,tiemslotIndex,paragraphs){for(var breakLoop=!1,paraIndex=paragraphIndex,sentances=[],returnVal={start:currentTime,end:"",text:""},i=paragraphIndex;i<paragraphs.length;i++)if(paragraphs[i]&&""!=paragraphs[i]){sentances=paragraphs[i].split(/\[([^[]*)\]/g);var timestampFormat=this.filterTimeSlots(sentances);if(timestampFormat){for(var jIndex=paraIndex==paragraphIndex?tiemslotIndex:0,j=jIndex;j<timestampFormat.length;j++){if(this.isDuration(timestampFormat[j],!1)){returnVal.end=timestampFormat[j],breakLoop=!0;break}returnVal.text=""!=returnVal.text?returnVal.text+" "+timestampFormat[j]:timestampFormat[j]}if(breakLoop)break}paraIndex++}return returnVal},this.validateStartEndTime=function(transcription,playTime){if(transcription&&transcription.length>0&&(""==transcription[0].start&&(transcription[0].start="00:00"),""==transcription[transcription.length-1].end)){var minutes=(Math.floor(playTime/3600),Math.floor(playTime/60%60)),seconds=playTime%60;transcription[transcription.length-1].end=minutes+":"+seconds}return transcription},this.convertToSeconds=function(duration){var count=(duration.match(/:/g)||[]).length;if(duration&&null!=duration&&1==count){var hour_minute_seconds=duration.split(":"),seconds=60*parseInt(hour_minute_seconds[0]);return hour_minute_seconds[1]&&""!=hour_minute_seconds[1]&&(seconds+=parseInt(hour_minute_seconds[1])),seconds}}}])}();
!function(){"use strict";angular.module("mean.articles").service("YTSearch",["$window",function($window){function start(){gapi.client.init({apiKey:"AIzaSyDCE3yqAnIqw9zHCSSz38J6ddeQnHsPV0E"}).then(function(){gapi.client.load("youtube","v3",function(){})}).then(function(response){},function(reason){})}return gapi.load("client",start),gapi}])}();
!function(){"use strict";angular.module("mean.articles").factory("Articles",["$resource",function($resource){return $resource("articles/:articleId",{articleId:"@_id"},{update:{method:"PUT"}})}])}();
!function(){"use strict";angular.module("mean.articles").factory("YoutubeMetadata",["$q","YTSearch",function($q,YTSearch){var metadata={},onMetadataUpdated=[],getVideoDataPromise=function(id,player){var deferred=$q.defer(),unknown={author:"Unknown",title:"Unknown",video_id:id},getVideoInfo=function(){if(YTSearch.client.youtube&&YTSearch.client.youtube.videos){YTSearch.client.youtube.videos.list({id:id,type:"video",part:"snippet"}).execute(function(data){if(data.items.length>0)return deferred.resolve({author:data.items[0].snippet.channelTitle,title:data.items[0].snippet.title,video_id:id});deferred.resolve(unknown)})}else setTimeout(getVideoInfo,1e3)};return getVideoInfo(),deferred.promise},fireNotificationHandlers=function(id,info){onMetadataUpdated.forEach(function(handler){handler.call(null,id,info)})};return{register:function(id,player){getVideoDataPromise(id).then(function(videoData){metadata[id]=videoData,fireNotificationHandlers(id,videoData)})},attach:function($scope){$scope.ytmetadata=metadata},notifyOnChange:function(handler){onMetadataUpdated.push(handler)},getAll:function(){return metadata}}}])}();
!function(){"use strict";Number.prototype.humanTime=function(){var time=Math.round(this),hours=Math.floor(time/3600);time-=3600*hours;var minutes=Math.floor(time/60),seconds=time-60*minutes,timeString="";return hours>0?(timeString=hours.toString(),timeString=minutes<10?timeString+":0"+minutes.toString():timeString+":"+minutes.toString()):timeString=minutes.toString(),timeString=seconds<10?timeString+":0"+seconds.toString():timeString+":"+seconds.toString()}}();
!function(){"use strict";angular.module("mean.system").controller("HelpController",["$rootScope","$scope","$state","MetaTagService","$mixpanel",function($rootScope,$scope,$state,MetaTagService,$mixpanel){console.log("Inside HelpController"),$rootScope.$emit("showHelpHeader",{title:"helping",visibility:"all"});var udpateMetaTags=function(){var metaObj,data={};data.title="Help Center",$state.is("help.howto")?(data.title="How To",$mixpanel.track("HelpHowto")):$state.is("help.faq")?(data.title="FAQ",$mixpanel.track("HelpFaq")):$state.is("help.tos")?(data.title="Terms of service",$mixpanel.track("HelpTos")):$state.is("help.copyright")?(data.title="Copyright",$mixpanel.track("HelpCopyright")):$state.is("help.privacy-policy")?(data.title="Privacy policy",$mixpanel.track("HelpPrivacy")):$state.is("help.about")?(data.title="About",$mixpanel.track("HelpAbout")):$state.is("help.contact")&&(data.title="Contact",$mixpanel.track("HelpContact"));var metaObj={title:data.title,description:"A Whole New Way Of Expression",author:"",keywords:""};MetaTagService.setMetaTags(metaObj).setTitle(metaObj.title+" - NR8")};udpateMetaTags(),$rootScope.$on("$stateChangeSuccess",udpateMetaTags)}])}();
!function(){"use strict";angular.module("mean.system").controller("YTSearchController",["$scope","$modalInstance","YTSearch","searchQuery",function($scope,$modalInstance,YTSearch,searchQuery){$scope.ytsearchquery=searchQuery,$scope.ytsearchList=[],$scope.makeYTSearch=function(q){if(q){YTSearch.client.youtube.search.list({q:q,videoEmbeddable:"true",maxResults:10,type:"video",part:"snippet"}).execute(function(searchResponse){if(searchResponse.result){$scope.ytsearchList=searchResponse.result.items,$scope.$$phase||$scope.$apply();var ids=_.map(searchResponse.result.items,function(val,key){return val.id.videoId});YTSearch.client.youtube.videos.list({id:ids.toString(),part:"contentDetails,statistics"}).execute(function(videoResponse){function convert_time(duration){var a=duration.match(/\d+/g);return duration.indexOf("M")>=0&&-1==duration.indexOf("H")&&-1==duration.indexOf("S")&&(a=[0,a[0],0]),duration.indexOf("H")>=0&&-1==duration.indexOf("M")&&(a=[a[0],0,a[1]]),duration.indexOf("H")>=0&&-1==duration.indexOf("M")&&-1==duration.indexOf("S")&&(a=[a[0],0,0]),duration=0,3==a.length&&(duration+=3600*parseInt(a[0]),duration+=60*parseInt(a[1]),duration+=parseInt(a[2])),2==a.length&&(duration+=60*parseInt(a[0]),duration+=parseInt(a[1])),1==a.length&&(duration+=parseInt(a[0])),duration}function secondsTohhmmss(totalSeconds){var hours=Math.floor(totalSeconds/3600),minutes=Math.floor((totalSeconds-3600*hours)/60),seconds=totalSeconds-3600*hours-60*minutes;seconds=Math.round(100*seconds)/100;var result=hours+":";return"0:"==result&&(result=""),result+=minutes<10?"0"+minutes:minutes,result+=":"+(seconds<10?"0"+seconds:seconds)}var gBY_id=_.groupBy(videoResponse.items,function(item){return item.id}),searchVideoItems=_.map(searchResponse.result.items,function(item,key){var videoItem=gBY_id[item.id.videoId][0];return videoItem.contentDetails.durationFormatted=secondsTohhmmss(convert_time(videoItem.contentDetails.duration)),videoItem.statistics.viewCountFormatted=parseInt(videoItem.statistics.viewCount).toLocaleString(),item.contentDetails=videoItem.contentDetails,item.statistics=videoItem.statistics,item});$scope.ytsearchList=searchVideoItems,$scope.$$phase||$scope.$apply()})}})}},$scope.makeYTSearch($scope.ytsearchquery),$scope.selectVideo=function(id){$modalInstance.close(id)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}])}();
!function(){angular.module("mean.system").controller("AnonymousLoginController",["$scope","$rootScope","$http","$window","$location","$state","$stateParams","Global","SiteConfig","$mixpanel","$modal","$timeout",function($scope,$rootScope,$http,$window,$location,$state,$stateParams,Global,SiteConfig,$mixpanel,$modal,$timeout){SiteConfig().then(function(siteConfig){$scope.siteConfig=siteConfig,siteConfig.anonymousLogin&&($scope.isAnonymousLogin=$scope.siteConfig.anonymousLogin.email===$scope.global.user.email)}),$scope.global=Global,$scope.user={},$scope.login=function(){$scope.global.authenticated&&$scope.isAnonymousLogin?$window.location.href="/logout?redirect=login":$state.go("auth.login")},$scope.logout=function(){$http.get("/logout").success(function(response){var stateName=$state.current.name;0===stateName.indexOf("article_edit")||0===stateName.indexOf("profile.edit")?($location.path("/"),$timeout(function(){$window.location.reload()})):$window.location.reload()}).error(function(error){console.log("error on logout")})},$scope.register=function(){$scope.global.authenticated&&$scope.isAnonymousLogin?$window.location.href="/logout?redirect=registration":$state.go("auth.register")},$scope.createNarrative=function(){if($scope.siteConfig.anonymousLogin=$scope.siteConfig.anonymousLogin?$scope.siteConfig.anonymousLogin:{},$scope.global.authenticated||!$scope.siteConfig.anonymousLogin.enable)return void $rootScope.$emit("create-nr8");$modal.open({templateUrl:"system/views/modal-anonymous-create-narrative.html",controller:"AnonymousLoginController",size:"md",resolve:{title:function(){return null}}})},$scope.anonymousLogin=function(redirectPage){if($scope.siteConfig.anonymousLogin=$scope.siteConfig.anonymousLogin?$scope.siteConfig.anonymousLogin:{},!$scope.siteConfig.anonymousLogin.enable)return!1;$scope.user.email=$scope.siteConfig.anonymousLogin.email,$scope.user.password=$scope.siteConfig.anonymousLogin.password,$http.post("/login",{email:$scope.user.email,password:$scope.user.password}).success(function(response){$scope.loginError=0,$rootScope.user=response.user,window.user=response.user,$rootScope.$emit("loggedin"),$mixpanel.identify(response.user._id),$mixpanel.people.set({$email:response.user.email,$first_name:response.user.firstname,$last_name:response.user.lastname,$username:response.user.username,$last_login:new Date}),$mixpanel.track("UserLogin",{email:response.user.email,firstname:response.user.firstname,lastname:response.user.lastname,username:response.user.username,lastlogin:new Date}),redirectPage?$state.go(redirectPage):$rootScope.$emit("create-nr8")}).error(function(){$scope.loginerror="Authentication failed."})}}])}();
!function(){"use strict";angular.module("mean.system").controller("AppCtrl",["$scope","$rootScope","$timeout","$modal","$modalStack","MetaTagService",function($scope,$rootScope,$timeout,$modal,$modalStack,MetaTagService){$scope.showListHeader=!1,$scope.showChallengeHeader=!1,$scope.showCreateHeader=!1,$scope.showHelpHeader=!1,$rootScope.$on("hideHeaders",function(){$scope.showListHeader=!1,$scope.showChallengeHeader=!1,$scope.showCreateHeader=!1,$scope.showHelpHeader=!1}),$rootScope.$on("showListHeader",function(){$scope.showListHeader=!0,$scope.showChallengeHeader=!1,$scope.showCreateHeader=!1,$scope.showHelpHeader=!1}),$rootScope.$on("showChallengeHeader",function(){$scope.showListHeader=!1,$scope.showChallengeHeader=!0,$scope.showCreateHeader=!1,$scope.showHelpHeader=!1}),$rootScope.$on("showCreateHeader",function(e,event){$scope.title=event.title,$scope.visibility=event.visibility,$scope.challenges=event.challenges,$scope.showListHeader=!1,$scope.showChallengeHeader=!1,$scope.showCreateHeader=!0,$scope.showHelpHeader=!1,$scope.showSaving=!1}),$rootScope.$on("showSavingOnCreateHeader",function(e,event){$scope.showSaving=!0,console.log("show saving"),$timeout(function(){$scope.showSaving=!1,console.log("hide saving")},2e3)}),$rootScope.$on("showHelpHeader",function(){$scope.showListHeader=!1,$scope.showChallengeHeader=!1,$scope.showCreateHeader=!1,$scope.showHelpHeader=!0}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams,options){var pages=["/create","/describe","/preview","/visibility"];$modalStack.dismissAll(),pages.indexOf(toState.url)&&angular.element("html, body").animate({scrollTop:0},200),MetaTagService.setMetaTags({title:"NR8",description:"A Whole New Way Of Expression",author:"",keywords:""}).setTitle("NR8 - A Whole New Way Of Expression")})}])}();
!function(){"use strict";angular.module("mean.system").controller("HeaderController",["$scope","$rootScope","$http","$document","$element","$location","Global","Menus","$state","$timeout","SiteConfig",function($scope,$rootScope,$http,$document,$element,$location,Global,Menus,$state,$timeout,SiteConfig){function queryMenu(name,defaultMenu){Menus.query({name:name,defaultMenu:defaultMenu},function(menu){$scope.menus[name]=menu})}window.$state=$state,$scope.global=Global,$scope.menus={},$scope.isMobile=isMobile.any,$scope.showMenu=!1;var defaultMainMenu=[];$scope.searchToggler=!1,$scope.searchQueryClearer=!1,SiteConfig().then(function(siteConfig){siteConfig.featureFlags&&($scope.features=siteConfig.featureFlags),siteConfig.anonymousLogin&&($scope.isAnonymousLogin=siteConfig.anonymousLogin.email===$scope.global.user.email)}),SiteConfig("topics").then(function(siteConfig){$scope.topics=siteConfig.config.topics||[]}),$scope.doSearch=function(e){$scope.query?($scope.query=$scope.query.replace(/[^\w^\s]/gi,"").trim(),$state.go("article_search",{query:$scope.query})):$timeout(function(){$element.find(".query-search").focus()})},$scope.showSearch=function(){$scope.searchToggler=!0,$timeout(function(){$element.find(".query-search").focus()},350)},$scope.clearQuery=function(){$scope.query="",$timeout(function(){$element.find(".query-search").focus()})},$scope.createNr8=function(){$rootScope.$emit("create-nr8")},$scope.$watch("query",function(newValue,oldValue){$scope.searchQueryClearer=!!newValue}),$document.on("click",function(e){$(e.target).closest(".search-box").length||""===$.trim($element.find(".search-box .query-search").val())&&($scope.searchToggler=!1,$scope.$$phase||$scope.$apply())}),$scope.goToStatusPage=function(){$rootScope.$emit("goToStatus")},$scope.goToDescribe=function(fieldName){$rootScope.$emit("goToDescribe",fieldName)},$rootScope.$on("$locationChangeStart",function(event,next,current){0!==$location.$$path.indexOf("/search/")&&($scope.searchToggler=!1,$scope.query="",$scope.$$phase||$scope.$apply())}),$scope.isActive=function(path,exactMatch){if(void 0!==path){var exactMatch=exactMatch||!1;return exactMatch?$location.path()===path||$location.path()===path+"/":$location.path().substr(0,path.length)===path}return!1},queryMenu("main",defaultMainMenu),$scope.isCollapsed=!1,$rootScope.$on("loggedin",function(){queryMenu("main",defaultMainMenu),$scope.global={authenticated:!!$rootScope.user,user:$rootScope.user}}),$http.get("/api/challenges").then(function(response){var colorIndex=0;$scope.topicColors=["#ff794d","#66d666","#a28ff7","#5faeff","#fbd252","#889ff8","#f094d0","#6fe0e2","#9c6cd7","#f7584d","#606b99","#42aee2"],$scope.availableTopics=response.data,$scope.topics=_.filter($scope.topics,function(item){return _.some($scope.availableTopics,function(el){return el.key===item.key&&(colorIndex>$scope.topicColors.length-1&&(colorIndex=0),item.color=$scope.topicColors[colorIndex++],!0)})}),colorIndex=0,_.each($scope.availableTopics,function(topic){colorIndex>$scope.topicColors.length-1&&(colorIndex=0),topic.color=$scope.topicColors[colorIndex++]})})}]),angular.module("mean.system").controller("HeaderDropdownCtrl",["$rootScope","$scope","$window",function($rootScope,$scope,$window){$scope.status={isopen:!1},$scope.toggled=function(open){$log.log("Dropdown is now: ",open)},$scope.toggleDropdown=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.status.isopen=!$scope.status.isopen}}]).directive("nr8Dropdown",function($rootScope){return{restrict:"A",link:function(scope,element,attrs){angular.element(window).on("scroll",function(){scope.$apply(function(){scope.status.isopen=!1})}).on("click",function(e){scope.$apply(function(){scope.status.isopen=!1})}),angular.element(element).on("click",function(e){e.stopPropagation()}).find(".nr8-dropdownmenu li>a").on("click",function(){scope.$apply(function(){scope.status.isopen=!1})})}}})}();
!function(){"use strict";angular.module("mean.system").controller("imageCropCtrl",function($scope,$modalInstance,imageUrl,aspectRatio,imageCropInfo){$scope.imageurl=imageUrl,$scope.imageCropInfo=imageCropInfo,$scope.aspectRatio=aspectRatio,$scope.title="Crop image",$scope.jCropObj={imageCropInfo:$scope.imageCropInfo},$scope.$on("imageCropInfoUpdated",function(e,info){$scope.imageCropInfo=info.cropInfo,$scope.jCropObj=info}),$scope.done=function(){$modalInstance.close($scope.jCropObj)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}})}();
!function(){"use strict";angular.module("mean.system").controller("okCtrl",function($scope,$modalInstance,title,message){$scope.title=title,$scope.showMessage=!1,message&&($scope.showMessage=!0,$scope.message=message),$scope.cancel=function(){$modalInstance.dismiss("cancel")}})}();
!function(){"use strict";angular.module("mean.system").controller("okCancelCtrl",function($scope,$modalInstance,title,message,$state){$scope.resolved=$state.$current.locals.globals,console.log("Resolved Variables:",$scope.resolved),$scope.title=title,$scope.showMessage=!1,message&&($scope.showMessage=!0,$scope.message=message),$scope.ok=function(){$modalInstance.close()},$scope.cancel=function(){$modalInstance.dismiss("cancel")}})}();
!function(){"use strict";angular.module("mean.system").controller("sendEmailCtrl",function($scope,$http,$modalInstance,Global,$timeout,blockUI,title,message,toEmail,article){function copySelectionText(){var copysuccess;try{copysuccess=document.execCommand("copy")}catch(e){copysuccess=!1}return copysuccess}$scope.article=article,$scope.global=Global,$scope.title=title,$scope.isShared=!1,$scope.errorOnShare=!1,$scope.mailInfo={toEmail:toEmail,message:message},$scope.templateCopied=!1;var ua=navigator.userAgent.toLowerCase();$scope.isSafari=-1!=ua.indexOf("safari")&&!(ua.indexOf("chrome")>-1),$scope.copyRichClipboard=function(){var isIE=/msie (\d+\.\d+);/.test(ua)||-1!==navigator.appVersion.indexOf("Trident"),text=(/chrome/.test(ua),angular.element("#email-template-original")[0]);if(isIE){var range=document.body.createTextRange();range.moveToElementText(text),range.select()}else{var selection=window.getSelection(),range=document.createRange();range.selectNodeContents(text),selection.removeAllRanges(),selection.addRange(range)}$scope.isSafari||($scope.templateCopied=copySelectionText(),$timeout(function(){$scope.templateCopied=!1},1e3),$scope.$$phase||$scope.digest())},$scope.emailAddessesPattern=function(){var emailsRegex=/^[\W]*([\w+\-.%]+@[\w\-.]+\.[A-Za-z]{2,4}[\W]*,{1}[\W]*)*([\w+\-.%]+@[\w\-.]+\.[A-Za-z]{2,4})[\W]*$/;return{test:function(value){return emailsRegex.test(value)}}}(),$scope.showMessage=!1,message&&($scope.showMessage=!0,$scope.message=message),$scope.sendEmail=function(){blockUI.start("Sending ..."),$http({url:"/sendmail/"+article._id,method:"POST",data:{emailFor:"share-article",article:$scope.article,mailInfo:$scope.mailInfo}}).then(function(response){$scope.isShared=!0,console.log("Mail has been sent !")},function(response){$scope.errorOnShare=!0,console.log("Error on sending mail !")}).finally(function(){blockUI.stop()})},$scope.close=function(){$modalInstance.dismiss("cancel"),$timeout(function(){$scope.isShared=!1,$scope.errorOnShare=!1},2e3)}})}();
!function(){"use strict";angular.module("mean.articles").directive("appOrientation",["$window",function($window){return{restrict:"A",link:function(scope,el,attrs){var windowElement=angular.element($window);isMobile.apple.device&&(windowElement.on("orientationchange",function(event){0==$window.orientation?el.addClass("portrait"):el.removeClass("portrait")}),windowElement.trigger("orientationchange"),setTimeout(function(){windowElement.trigger("orientationchange")},1e3))}}}])}();
!function(){"use strict";angular.module("mean.system").directive("croppedimage",function(){return{transclude:!0,template:'<div style="display: none"></div><canvas></canvas>',restrict:"E",scope:!0,link:function(scope,element,attrs){var x=attrs.x||0,y=attrs.y||0,cropheight=attrs.cropheight,cropwidth=attrs.cropwidth,canvasheight=attrs.canvasheight,canvaswidth=attrs.canvaswidth,$canvas=angular.element("canvas",element)[0];$canvas.height=canvasheight,$canvas.width=canvaswidth;var context=$canvas.getContext("2d"),image=new Image;image.onload=function(){context.drawImage(image,x,y,cropwidth,cropheight,0,0,canvaswidth,canvasheight)},image.src=attrs.source}}})}();
!function(){"use strict";angular.module("mean.articles").directive("challengeDetailDesciption",function($compile,$timeout,$filter){return{restrict:"EA",scope:{description:"@"},controller:function($scope,$element,$attrs,$timeout){function getNarrativeText(text){var textLower=" "+text.toLowerCase()+" ",narrativeText=" narrative[?] ";return narrativeText=text.substr(textLower.indexOf(narrativeText),narrativeText.length-5),$.trim(narrativeText)}$element.html(function(text){var narrativeTooltip=angular.element("<div>"),span=angular.element("<span>",{class:"narrative-helptip tooltip-white","tooltip-html-unsafe":'A <strong class="i">narrative</strong> is a seamless video experience, where selected portions from one or more YouTube videos play in a desired order.',"tooltip-trigger":"mouseenter","tooltip-placement":"bottom",html:getNarrativeText(text)+"<sup>?</sup>"});return narrativeTooltip.append(span),text=" "+text+" ",text=text.replace(/ narrative\[\?\] /i," "+narrativeTooltip.html()+" "),$.trim(text)}(function(text){return text=text.replace(/\n{3,}/g,"\n\n"),text=text.replace(/\n/g,"<br>"),angular.element("<div>").html(text).html()}($scope.description)));try{$compile($element.contents())($scope)}catch(ex){}}}})}();
!function(){"use strict";angular.module("mean.system").directive("imagecrop",function(){return{transclude:!0,template:'<img ng-src="{{source}}"></img>',restrict:"E",link:function(scope,element,attrs){function cropInfoUpdate(cropInfo){var info={uiImageInfo:{w:scope.img.width(),h:scope.img.height()},cropInfo:cropInfo};scope.$emit("imageCropInfoUpdated",info)}function setup(){var $img=$("img",element);scope.img=$img,$img.addClass("img-responsive"),$img.attr("src")===scope.source?setTimeout(function(){$img.Jcrop({aspectRatio:aspectRatio,onChange:cropInfoUpdate,setSelect:[x1,y1,x2,y2],bgColor:"white",bgOpacity:.4,addClass:classes}),scope.showImageCrop=!0,scope.$$phase||scope.$apply()},500):setTimeout(setup,200)}scope.source=attrs.source;var aspect=attrs.aspect||"16:9",aspectRatio="16:9"===aspect?16/9:1,classes="ma";"1:1"===attrs.aspect&&(classes="ma jcrop-circle");var model=attrs.model,resized=JSON.parse(model).resized,incomingAspectRatio=resized.width/resized.height;scope.showImageCrop=!1;var x1,y1,x2,y2=0;if(incomingAspectRatio===aspectRatio)x1=0,y1=0,x2=resized.width,y2=resized.height;else if(incomingAspectRatio>aspectRatio){var widthDelta=resized.width-resized.height*aspectRatio;x1=widthDelta/2,y1=0,x2=resized.width-widthDelta/2,y2=resized.height}else if(incomingAspectRatio<aspectRatio){var heightDelta=resized.height-resized.width/aspectRatio;x1=0,y1=heightDelta/2,x2=resized.width,y2=resized.height-heightDelta/2}setup()}}})}();
!function(){"use strict";angular.module("mean.articles").directive("customPopover",["$document",function($document){return{restrict:"A",template:'<span class="angular-popover">{{label}}<svg-image imageid="question-mark-rounded" classes="icon icon-15"></svg-image></span>',link:function(scope,el,attrs){scope.label=attrs.popoverLabel,$(el).popover({trigger:"click",html:!0,content:attrs.popoverHtml,placement:attrs.popoverPlacement}),$("body").on("click",function(e){$(e.target).is("[custom-popover]")&&0===$(e.target).parents(".popover.in").length&&$("[custom-popover]").popover("hide")})}}}])}();
!function(){"use strict";angular.module("mean.articles").directive("questionMark",["$document",function($document){return{restrict:"AE",transclude:!0,templateUrl:"system/views/directive-question-mark.html",scope:!1,link:function(scope,element,attrs){}}}])}();
!function(){"use strict";angular.module("mean.articles").directive("selectAllText",["$window",function($window){return{restrict:"A",scope:!0,link:function(scope,element,attrs){element.on("click focus",function(){$window.getSelection().toString()||this.setSelectionRange(0,this.value.length)})}}}])}();
!function(){"use strict";angular.module("mean.articles").directive("selectOnCopy",function(){return{restrict:"A",link:function(scope,element){var focusedElement,input;element.on("click",function(){input=element.closest(".copy-box").find("input"),focusedElement!=input&&(input.get(0).select(),focusedElement=input)}),element.on("blur",function(){focusedElement=null})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("showImage",function($rootScope){var imageServer=$rootScope.imageServer&&""!=$rootScope.imageServer?$rootScope.imageServer:"https://images.nr8.com";return console.log("===>showImage:imageServer",imageServer),{template:'<img ng-src = "{{imageUrl}}" style="width:100%" alt="" ng-class = "classes" />',transclude:!0,scope:{image:"="},restrict:"E",link:function(scope,element,attrs){function getImageUrl(host,id,width){return"yt"===host?imageServer+"/host/yt/"+id+"/"+width:"is"===host?imageServer+"/host/is/"+encodeURIComponent(id)+"/"+width:void 0}var width=attrs.width||850;scope.classes=attrs.classes||"img-responsive",scope.$watch("image",function(){scope.image&&(scope.imageUrl=getImageUrl(scope.image.host,scope.image.id,width))})}}})}();
!function(){"use strict";angular.module("mean.articles").directive("stickyBox",["$document",function($document){return{restrict:"AE",transclude:!0,templateUrl:"system/views/directive-sticky-box.html",scope:!0,link:function(scope,element,attrs){scope.classes=attrs.classes}}}])}();
!function(){"use strict";angular.module("mean.articles").directive("stickyHelp",["$document",function($document){return{restrict:"AE",transclude:!0,templateUrl:"system/views/directive-sticky-help.html",scope:!0,link:function(scope,element,attrs){scope.black="true"===attrs.black,scope.classes=attrs.classes,scope.path="/help/faq",attrs.context&&"create"===attrs.context&&(scope.path="/help/howto")}}}])}();
!function(){"use strict";angular.module("mean.articles").directive("stickySocialmedia",["$document",function($document){return{restrict:"AE",transclude:!0,templateUrl:"system/views/directive-sticky-socialmedia.html",scope:!0,link:function(scope,element,attrs){scope.classes=attrs.classes}}}])}();
!function(){"use strict";angular.module("mean.articles").directive("svgImage",["$http",function($http){var a,svgDoc,isIE=/MSIE (\d+\.\d+);/.test(navigator.userAgent)||-1!==navigator.appVersion.indexOf("Trident"),isChrome=/chrome/.test(navigator.userAgent.toLowerCase());return(isIE||isChrome)&&(a=angular.element("#svgSprite").get(0),svgDoc=a.contentDocument),{restrict:"AE",transclude:!0,templateUrl:"system/views/directive-svg-image.html",scope:!0,link:function(scope,element,attrs){if(scope.type=attrs.type,scope.classes=attrs.classes,scope.imageid=attrs.imageid,isIE||isChrome){var svgIcon=svgDoc.getElementById(scope.imageid),svgEle=element.find(".svg-wrapper").get(0);svgEle.parentNode.replaceChild(svgIcon.cloneNode(!0).querySelector("svg"),svgEle)}else scope.imageurl="/packages/articles/public/assets/img/svg-sprites.svg#"+attrs.imageid}}}])}();
!function(){"use strict";angular.module("mean.system").filter("URIEncode",["$window",function($window){return $window.encodeURIComponent}])}();
!function(){"use strict";angular.module("mean.system").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",controller:["$state",function($state){$state.go("articles_list")}]}).state("help",{url:"/help",templateUrl:"system/views/help/index.html",controller:"HelpController"}).state("help.howto",{url:"/howto",views:{"":{templateUrl:"/pages-help/howto.html"},menu:{templateUrl:"system/views/help/menu-howto.html"}}}).state("help.faq",{url:"/faq",views:{"":{templateUrl:"/pages-help/faq.html"}}}).state("help.tos",{url:"/tos",views:{"":{templateUrl:"/pages-help/tos.html"}}}).state("help.copyright",{url:"/copyright",views:{"":{templateUrl:"/pages-help/copyright.html"}}}).state("help.privacy-policy",{url:"/privacy-policy",views:{"":{templateUrl:"/pages-help/privacy-policy.html"}}}).state("help.about",{url:"/about",views:{"":{templateUrl:"/pages-help/about.html"}}}).state("help.contact",{url:"/contact",views:{"":{templateUrl:"/pages-help/contact.html"}}}).state("error",{url:"/error",abstract:!0,templateUrl:"system/views/errors/layout.html",params:{message:null}}).state("error.unauthorized",{url:"/unauthorized",templateUrl:"articles/views/errors/403-accessdenied.html"}).state("error.notfound",{url:"/not-found",templateUrl:"articles/views/errors/404-pagenotfound.html"}).state("error.badRequest",{url:"/bad-request",templateUrl:"system/views/errors/bad-request.html"}).state("error.internal",{url:"/server-error",templateUrl:"system/views/errors/internal.html"})}]).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}])}();
!function(){"use strict";angular.module("mean.system").service("cropImageService",["$modal","$http","$rootScope",function($modal,$http,$rootScope){var imageServer=$rootScope.imageServer&&""!=$rootScope.imageServer?$rootScope.imageServer:"https://images.nr8.com";console.log("===>cropImageService:imageServer",imageServer),this.cropImage=function(imageUrl,key,imageInfo,aspectRatio,callback){$modal.open({templateUrl:"system/views/modal-imagecrop.html",controller:"imageCropCtrl",size:"lg",backdrop:"static",resolve:{imageUrl:function(){return imageUrl},aspectRatio:function(){return aspectRatio},imageCropInfo:function(){return imageInfo}}}).result.then(function(jCropObj){var cropInfo=jCropObj.cropInfo,uiImageInfo=jCropObj.uiImageInfo,uiImageFactor=uiImageInfo.w/imageInfo.resized.width,factor=imageInfo.resized.factor,realDimensions={x:cropInfo.x/uiImageFactor/factor,y:cropInfo.y/uiImageFactor/factor,w:cropInfo.w/uiImageFactor/factor,h:cropInfo.h/uiImageFactor/factor};console.log("REAL DIMENSIONS:",realDimensions);var cropUrl=imageServer+"/crop/"+encodeURIComponent(key)+"/"+realDimensions.y+"/"+realDimensions.x+"/"+realDimensions.w+"/"+realDimensions.h;$http.post(cropUrl).then(function(response){callback&&callback(response.data.key)})},function(){console.log("Modal dismissed at : "+new Date)})}}])}();
!function(){"use strict";angular.module("mean.system").factory("Global",["$rootScope",function($rootScope){var _this=this;_this._data={testUsers:["nithyananda","rclayton","srinivasrao","adal","nlighten_review"]};var update=function(){_this._data.user=window.user,_this._data.authenticated=!1,_this._data.isAdmin=!1,_this._data.testingAccounts=["nithyananda","rclayton","srinivasrao","adal","nlighten_review"],window.user&&window.user.roles&&(_this._data.authenticated=window.user.roles.length,_this._data.isAdmin=-1!==window.user.roles.indexOf("admin"))};return $rootScope.$on("loggedout",update),$rootScope.$on("loggedin",update),update(),_this._data}])}();
!function(){"use strict";angular.module("mean.system").service("$history",function($state,$rootScope,$window){var history=[],validListStates=["articles_list","articles_browse","home","profile","article_search","profile.view"];angular.extend(this,{push:function(state,params){history.push({state:state,params:params})},all:function(){return history},go:function(step){var prev=this.previous(step||-1);return $state.go(prev.state,prev.params)},previous:function(step){return history[history.length-Math.abs(step||1)]},back:function(){return this.go(-1)},hasHistory:function(){return history.length>1},pop:function(numOfStates){history=history.slice(0,history.length-numOfStates)},getLastListState:function(){var latestToEarliest=angular.copy(history).reverse(),lastListState=_.find(latestToEarliest,function(stateAndParams){return _.contains(validListStates,stateAndParams.state.name)});return lastListState||{state:{name:"articles_list"},params:{}}},goToLastListState:function(){var lastListState=this.getLastListState();console.log("$history service",lastListState.state.name,lastListState.params),$state.go(lastListState.state.name,lastListState.params)}})}).run(function($history,$state,$rootScope){$rootScope.$on("$stateChangeSuccess",function(event,to,toParams,from,fromParams){$history.push(from,fromParams)}),$history.push($state.current,$state.params)})}();
!function(){"use strict";angular.module("mean-factory-interceptor",[]).factory("httpInterceptor",["$q","$location",function($q,$location){return{response:function(response){return 401===response.status?($location.path("/auth/login"),$q.reject(response)):response||$q.when(response)},responseError:function(rejection){return 401===rejection.status?($location.url("/auth/login"),$q.reject(rejection)):$q.reject(rejection)}}}]).config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("httpInterceptor")}])}();
!function(){"use strict";angular.module("mean.system").factory("Menus",["$resource",function($resource){return $resource("admin/menu/:name",{name:"@name",defaultMenu:"@defaultMenu"})}])}();
!function(){"use strict";angular.module("mean.system").factory("SiteConfig",["$q","$http",function($q,$http){var cache={};return function(name){var url="/site-config",cacheKey="mergedSet";name&&(url="/site-config/"+name,cacheKey=name);var deferred=$q.defer();return cache[cacheKey]?deferred.resolve(cache[cacheKey]):$http.get(url).success(function(config){config?(cache[cacheKey]=config,deferred.resolve(config)):deferred.reject()}),deferred.promise}}])}();
!function(){"use strict";angular.module("mean.system").constant("$uuid",function(){return uuid.v4()})}();
!function(){"use strict";angular.module("mean.users").constant("USERNAME_PATTERN","[a-zA-Z0-9_.]{3,20}")}();
!function(){"use strict";angular.module("mean.users").controller("LoginCtrl",["$scope","$rootScope","$http","$location","$state","$stateParams","SiteConfig","$mixpanel","previousState",function($scope,$rootScope,$http,$location,$state,$stateParams,SiteConfig,$mixpanel,previousState){$scope.openReg=!1;var gotoAfterLogin=$stateParams.gotoAfterLogin;SiteConfig().then(function(siteConfig){siteConfig.featureFlags.openReg&&($scope.openReg=!0)}),$mixpanel.track("LoginPage"),$scope.user={},$scope.user.email=$stateParams.email,$scope.justVerified=$stateParams.justVerified,$rootScope.$emit("hideHeaders"),$scope.loginFacebook=function(){window.location.href="/auth/facebook"},$scope.login=function(){$http.post("/login",{email:$scope.user.email,password:$scope.user.password}).success(function(response){$scope.loginError=0,$rootScope.user=response.user,window.user=response.user,$rootScope.$emit("loggedin"),$mixpanel.identify(response.user._id),$mixpanel.people.set({$email:response.user.email,$first_name:response.user.firstname,$last_name:response.user.lastname,$username:response.user.username,$last_login:new Date}),$mixpanel.track("UserLogin",{email:response.user.email,firstname:response.user.firstname,lastname:response.user.lastname,username:response.user.username,lastlogin:new Date}),gotoAfterLogin&&gotoAfterLogin.state?$state.go(gotoAfterLogin.state,gotoAfterLogin.params||{}):previousState&&previousState.name&&0!==previousState.name.indexOf("article_edit")&&0!==previousState.name.indexOf("auth")?$state.go(previousState.name,previousState.params):$state.go("articles_list")}).error(function(){$scope.loginerror="Authentication failed."})}}]).controller("RegisterCtrl",["$scope","$rootScope","$http","$state","$stateParams","USERNAME_PATTERN","SiteConfig","$mixpanel",function($scope,$rootScope,$http,$state,$stateParams,USERNAME_PATTERN,SiteConfig,$mixpanel){$scope.openReg=!1,SiteConfig().then(function(siteConfig){siteConfig.featureFlags.openReg&&($scope.openReg=!0)}),$mixpanel.track("RegisterPage"),$scope.usernamePattern=new RegExp("^"+USERNAME_PATTERN+"$"),$scope.user={},$stateParams.email&&($scope.user.email=$stateParams.email),$rootScope.$emit("hideHeaders"),$scope.registrationInfo=!0,$scope.registerFacebook=function(){window.location.href="/auth/facebook"},$scope.validatePassword=function(){if($scope.passwordError="",$scope.registrationForm.password.$dirty&&$scope.registrationForm.confirmPassword.$dirty){if(!(8<=$scope.registrationForm.password.$modelValue.length&&$scope.registrationForm.password.$modelValue.length<=20))return console.log("coming2"),$scope.registrationForm.password.$setValidity("passwordLength",!1),$scope.registrationForm.confirmPassword.$setValidity("passwordLength",!1),void($scope.passwordError=$scope.passwordError+"Password must be between 8 and 20 characters.");console.log("coming1",$scope.registrationForm.password.$modelValue.length),$scope.registrationForm.password.$setValidity("passwordLength",!0),$scope.registrationForm.confirmPassword.$setValidity("passwordLength",!0),$scope.registrationForm.password.$modelValue===$scope.registrationForm.confirmPassword.$modelValue?($scope.registrationForm.password.$setValidity("matchPassword",!0),$scope.registrationForm.confirmPassword.$setValidity("matchPassword",!0),$scope.passwordError=""):($scope.registrationForm.password.$setValidity("matchPassword",!1),$scope.registrationForm.confirmPassword.$setValidity("matchPassword",!1),$scope.passwordError="The passwords have to match."),console.log("password validity",$scope.registrationForm.password.$valid,$scope.registrationForm.confirmPassword.$valid)}},$scope.register=function(){$scope.usernameError=null,$scope.registerError=null,$http.post("/register",{email:$scope.user.email,password:$scope.user.password,confirmPassword:$scope.user.confirmPassword,username:$scope.user.username,firstname:$scope.user.firstname,lastname:$scope.user.lastname}).success(function(profile){$scope.errorMessage=null,$scope.registerError=0,$scope.registrationInfo=!1,$mixpanel.track("UserRegistered",{username:$scope.user.username,email:$scope.user.email,firstname:$scope.user.firstname,lastname:$scope.user.lastname})}).error(function(error,status){$scope.registrationForm.$setPristine();var getErrorMessage=function(e){return _.isObject(e)&&e.hasOwnProperty("msg")?e.msg:e};_.isArray(error)&&1===error.length&&(error=error[0]),_.isArray(error)?$scope.errorMessage=_.map(error,getErrorMessage):$scope.errorMessage=getErrorMessage(error)})}}]).controller("ForgotPasswordCtrl",["$scope","$rootScope","$http","$location",function($scope,$rootScope,$http,$location){$scope.user={},$scope.enterEmail=!0,$scope.forgotpassword=function(){!0!==$scope.loading&&($scope.loading=!0,$http.post("/forgot-password",{email:$scope.text}).success(function(response){$scope.enterEmail=!1,$scope.response=response}).error(function(data,status){$scope.enterEmail=!0,$scope.response=data.message,$scope.hasError=!0}).finally(function(data,status){$scope.loading=!1}))}}]).controller("ResetPasswordCtrl",["$scope","$rootScope","$http","$state","$stateParams",function($scope,$rootScope,$http,$state,$stateParams){$scope.user={},$scope.resetpassword=function(){$http.post("/reset/"+$stateParams.tokenId,{password:$scope.user.password,confirmPassword:$scope.user.confirmPassword}).success(function(response){$rootScope.user=response.user,window.user=response.user,$rootScope.$emit("loggedin"),response.redirect?window.location.href===response.redirect?window.location.reload():window.location=response.redirect:$state.go("articles_list")}).error(function(error){"Token invalid or expired"===error.msg?$scope.resetpassworderror="Could not update password as token is invalid or may have expired":$scope.validationError=error})}}]).controller("EmailVerificationCtrl",["$scope","$http","$state","email","token","$mixpanel",function($scope,$http,$state,email,token,$mixpanel){$scope.email=email,$scope.message="",$http.post("/verify",{email:email,token:token}).success(function(response){$mixpanel.track("EmailVerified",{email:email}),$state.go("auth.login",{email:email,justVerified:!0})}).error(function(error){"object"==typeof error&&($scope.message=error.message)})}])}();
!function(){"use strict";angular.module("mean.users").controller("ProfileController",["$scope","$location","cropImageService","$http","$modal","$upload","Upload","$rootScope","profile","Global","MeanUser","blockUI","$mixpanel","MetaTagService",function($scope,$location,cropImageService,$http,$modal,$upload,Upload,$rootScope,profile,Global,MeanUser,blockUI,$mixpanel,MetaTagService){$rootScope.$emit("showListHeader"),$scope.global=Global,$scope.profile=profile.user,$scope.profileEdit=_.cloneDeep($scope.profile),$scope.articles=_.filter(profile.articles,function(a){return"Public"===a.visibility||"Private"===a.visibility}),$scope.draftArticles=_.filter(profile.articles,function(a){return"Draft"===a.visibility}),$scope.needAttentionArticles=_.filter(profile.articles,function(a){return"Pre-suspension"===a.visibility||"Suspension"===a.visibility||"Post-suspension"===a.visibility||"YTContentNA"===a.visibility}),$http.get("/api/following/"+profile.user._id).then(function(response){$scope.followingTopics=response.data}),$scope.canEdit=$scope.global.user._id===profile.user._id,$scope.canEdit?$mixpanel.track("MyProfile",{profile_user_id:profile.user._id}):$mixpanel.track("Profile",{profile_user_id:profile.user._id}),$scope.isPlaceholderProfileImage="articles/555de51622a95de40d907786/c614cf7d135381c58106c6811faed69d86323c48"===$scope.profile.image.id,$scope.showQMenu=!1,$scope.requiredSocialMediaText=function(){for(var profile=$scope.profile,socialMedias=[{title:"Facebook",value:profile.facebookurl},{title:"Twitter",value:profile.twitterid},{title:"Instagram",value:profile.instagramid}],requiredSocialMediaTags=[],i=0;i<socialMedias.length;i++)socialMedias[i].value||requiredSocialMediaTags.push(socialMedias[i].title);return!(requiredSocialMediaTags.length<1)&&requiredSocialMediaTags.join(", ").replace(/,([^,]*)$/," &$1")+" account"+(requiredSocialMediaTags.length>1?"s":"")},$scope.applyHttp=function(url){return"string"!=typeof url||/^https?:\/\//i.test(url)||(url="http://"+url),url},$scope.createNr8=function(){$rootScope.$emit("create-nr8")};var authorFullName=$scope.profile.firstname+" "+$scope.profile.lastname;MetaTagService.setMetaTags({title:authorFullName,description:"A Whole New Way Of Expression",author:authorFullName,keywords:authorFullName}).setTitle(authorFullName+" - NR8"),$scope.dataFileUploading={name:"",progress:0,show:!1},$scope.dataFileMessages="",$scope.uploadedDataFile=null,$scope.dataFileUploaded=!1,$scope.importStarted=!1,$scope.importFinished=!1,$scope.uploadAudioFile=function(files){var file=files[0];$scope.dataFileUploaded=!1,$scope.dataFileUploading={name:file.name,progress:0,show:!1},$scope.dataFileMessages="",void 0!==file&&$http({url:"/api/upload-excel/",method:"POST",data:{name:file.name,mimetype:file.type,datafile:file.name,isImported:!1}}).then(function(response){$scope.dataFileUploading={name:file.name,progress:0,show:!0},Upload.http({url:response.data.url,method:"PUT",headers:{"Content-Type":response.data.mimetype},data:file}).then(function(resp){console.log("Got resp",resp),200==resp.status&&"OK"==resp.statusText?($scope.uploadedDataFile=response.data,$scope.dataFileUploaded=!0,$scope.dataFileUploading={name:file.name,progress:100,show:!1}):($scope.uploadedDataFile=null,$scope.dataFileUploading={name:"",progress:100,show:!1})},function(resp2){blockUI.stop(),console.log("status : ",status)},function(evt){console.log("progress evt: ",evt);var progressPercentage=parseInt(100*evt.loaded/evt.total);$scope.dataFileUploading.progress=progressPercentage})},function(response){console.log("Error getting response!"),$scope.dataFileMessages=response.message}).finally(function(){})},$scope.createNarratives=function(isCancel){$scope.uploadedDataFile&&$scope.uploadedDataFile._id&&$scope.uploadedDataFile;$scope.dataFileUploading.show=!1,isCancel||($scope.importStarted=!0,blockUI.start()),$http({url:"/api/import/narrative/",method:"POST",data:{userId:$scope.profile._id,importedFileId:$scope.uploadedDataFile._id,fileName:"",isCancel:isCancel}}).then(function(response){blockUI.stop();var data=response.data;isCancel||($scope.dataFileMessages=data.message),data.error&&1==data.error?($scope.dataFileUploaded=!1,$scope.importStarted=!1):isCancel?($scope.dataFileUploaded=!1,$scope.importStarted=!1):setTimeout(function(){importFinished()},5e3)},function(response){console.log("Error getting response!")}).finally(function(){})};var importFinished=function(){$scope.dataFileUploaded=!1,$scope.importStarted=!1,window.location.reload()}}]),angular.module("mean.users").controller("ProfileEditController",["$scope","$location","cropImageService","$http","$modal","$upload","$rootScope","profile","Global","MeanUser","blockUI","$mixpanel","$state","MetaTagService",function($scope,$location,cropImageService,$http,$modal,$upload,$rootScope,profile,Global,MeanUser,blockUI,$mixpanel,$state,MetaTagService){$rootScope.$emit("showListHeader");var imageServer=$rootScope.imageServer&&""!=$rootScope.imageServer?$rootScope.imageServer:"https://images.nr8.com";console.log("===>ProfileEditController:imageServer",imageServer);var placeholderProfileImage={host:"is",id:"articles/555de51622a95de40d907786/c614cf7d135381c58106c6811faed69d86323c48",imageUrl:"https://nr8-images.s3.amazonaws.com/articles/555de51622a95de40d907786/c614cf7d135381c58106c6811faed69d86323c48"};$scope.global=Global,$scope.profile=profile.user,$scope.profileEdit=_.cloneDeep($scope.profile),$scope.profileImageUrl=imageServer+"/host/is/"+encodeURIComponent($scope.profileEdit.image.id)+"/200",$scope.articles=_.filter(profile.articles,function(a){return"Public"===a.visibility||"Private"===a.visibility}),$scope.draftArticles=_.filter(profile.articles,function(a){return"Draft"===a.visibility}),$scope.needAttentionArticles=_.filter(profile.articles,function(a){return"Pre-suspension"===a.visibility||"Suspension"===a.visibility||"Post-suspension"===a.visibility||"YTContentNA"===a.visibility}),$scope.canEdit=$scope.global.user._id===profile.user._id,$scope.canEdit&&$mixpanel.track("MyProfileEdit",{profile_user_id:profile.user._id}),$scope.showQMenu=!1,$scope.duplicateValue=0,$scope.updateProfile=function(){null!==$scope.profileEdit.image&&void 0!==$scope.profileEdit.image||($scope.profileEdit.image=placeholderProfileImage);$scope.profile.username,$scope.profileEdit.username;MeanUser.save($scope.profileEdit).then(function(response){if($scope.profile=$scope.profileEdit,!response.success)throw response;$rootScope.user=$scope.profile,$rootScope.$emit("loggedin"),$scope.goToProfile()},function(response){switch(response.data.code){case 11e3:$scope.duplicateValue="Username already taken";break;default:throw response}}).catch(function(err){})},$scope.uploadProfileImage=function(files){var file=files[0];console.log("Uploading profile image : ",file),void 0!==file&&(blockUI.start(),$scope.upload=$upload.upload({url:imageServer+"/upload/users/"+$scope.global.user._id+"%2f"+file.name,method:"POST",transformRequest:function(data,headersGetter){return delete headersGetter().Authorization,data},file:file}).success(function(data){blockUI.stop(),cropImageService.cropImage(data.modalUrl,data.key,data.info,"1:1",function(id){$scope.profileEdit.image={host:"is",id:id},$scope.profileImageUrl=imageServer+"/host/is/"+encodeURIComponent($scope.profileEdit.image.id)+"/200"})}).error(function(){blockUI.stop()}))},$scope.goToProfile=function(){$state.go("profile.view",{atuserid:"@"+$scope.profile.username},{reload:!0})};var authorFullName=$scope.profile.firstname+" "+$scope.profile.lastname;MetaTagService.setMetaTags({title:"",description:"",author:"",keywords:""}).setTitle(authorFullName+" - NR8")}])}();
!function(){"use strict";angular.module("mean.users").directive("waitlistSignup",["$http","$state",function($http,$state){return{restrict:"E",templateUrl:"users/views/waitlist-signup.html",scope:"=",link:function(scope){scope.betasignup="",scope.signupForBeta=function(){var encodedEmail=encodeURIComponent(scope.betasignup);$http.post("/signup/"+encodedEmail).success(function(){$state.go("auth.waitlist")}).error(function(error,status){scope.signupError=error.message,409===status&&(scope.user.email=error.value)})}}}}])}();
!function(){"use strict";angular.module("mean.users").config(["$stateProvider","USERNAME_PATTERN",function($stateProvider,USERNAME_PATTERN){$stateProvider.state("auth",{url:"/auth",templateUrl:"users/views/index.html"}).state("auth.login",{url:"/login",controller:"LoginCtrl",templateUrl:"users/views/login.html",resolve:{previousState:function($state){return{name:$state.current.name,params:$state.params,url:$state.href($state.current.name,$state.params)}},restrict:function(UserSession){return UserSession.checkLoggedOut()}},params:{email:"",justVerified:!1,gotoAfterLogin:null}}).state("auth.register",{url:"/register?email",params:{email:null},templateUrl:"users/views/register.html",resolve:{anonLoggedOut:function($q,$rootScope,$http,Global,SiteConfig){var deferred=$q.defer();return SiteConfig().then(function(siteConfig){return Global.user.email===siteConfig.anonymousLogin.email&&(window.location="/logout?redirect=registration"),deferred.resolve()}),deferred.promise}},restrict:function(UserSession){return UserSession.checkLoggedOut()}}).state("auth.verify",{url:"/verify/:email/:token",templateUrl:"users/views/verify-email.html",controller:"EmailVerificationCtrl",resolve:{email:function($stateParams){return $stateParams.email},token:function($stateParams){return $stateParams.token}}}).state("auth.waitlist",{url:"/waitlist-confirmation",templateUrl:"users/views/waitlist-confirmation.html"}).state("auth.waitlist-error",{url:"/waitlist-error",templateUrl:"users/views/waitlist-error.html"}).state("auth.login-to-create",{url:"/login-to-create",templateUrl:"users/views/login-to-create.html"}).state("forgot-password",{url:"/auth/forgot-password",templateUrl:"users/views/forgot-password.html",restrict:function(UserSession){return UserSession.checkLoggedOut()}}).state("reset-password",{url:"/reset/:tokenId",templateUrl:"users/views/reset-password.html",restrict:function(UserSession){return UserSession.checkLoggedOut()}}).state("profile",{abstract:!0,params:{atuserid:null},templateUrl:"users/views/profile.html",resolve:{noAnonymous:function($q,$timeout,$stateParams,$state){var deferred=$q.defer(),userId=$stateParams.atuserid.substring(1);return $timeout(function(){"anonymous"==userId.toLowerCase()?($state.go("articles_list"),deferred.reject()):deferred.resolve()}),deferred.promise},profile:function($stateParams,MeanUser){var userId=$stateParams.atuserid.substring(1);return MeanUser.getWithArticles(userId)}}}).state("profile.view",{url:"/{atuserid:@"+USERNAME_PATTERN+"}",templateUrl:"users/views/profile-view.html",controller:"ProfileController",resolve:{restrict:function(UserSession,$stateParams){return UserSession.checkAnonymousSessionAccess({state:"profile.view",params:$stateParams})}}}).state("profile.edit",{url:"/{atuserid:@"+USERNAME_PATTERN+"}/edit",templateUrl:"users/views/profile-edit.html",controller:"ProfileEditController",resolve:{restrictToOwner:function(UserSession,$stateParams){return UserSession.checkIsUser($stateParams.atuserid.slice(1),{state:"profile.edit",params:$stateParams})}}})}])}();
!function(){"use strict";angular.module("mean.users").factory("MeanUser",["$http",function($http){return{name:"users",get:function(userId){return $http.get("profile/"+userId).then(function(response){return response.data})},getWithArticles:function(userId){return $http.get("profile/"+userId+"/articles").then(function(response){return response.data})},save:function(user){return $http.post("profile/"+user._id,user).then(function(response){return response.data})}}}])}();
!function(){"use strict";angular.module("mean.users").factory("UserSession",["$q","$timeout","$http","$location","$state","SiteConfig",function($q,$timeout,$http,$location,$state,SiteConfig){var checkAnonymousSessionAccess=function(gotoAfter){var deferred=$q.defer();return SiteConfig().then(function(siteConfig){if(siteConfig.featureFlags.allowAnonymousAccess){var numberOfUserActions=window.sessionStorage.getItem("numberOfUserActions");numberOfUserActions=numberOfUserActions?JSON.parse(numberOfUserActions):0,numberOfUserActions>=siteConfig.maxAnonymousActions?deferred.resolve(checkLoggedin(gotoAfter)):(numberOfUserActions++,window.sessionStorage.setItem("numberOfUserActions",numberOfUserActions),deferred.resolve(!0))}else deferred.resolve(checkLoggedin(gotoAfter))},function(){deferred.reject("Could not retrieve the site configuration.")}),deferred.promise},checkLoggedin=function(gotoAfter){var deferred=$q.defer();return $http.get("/loggedin").success(function(user){"0"!==user?$timeout(deferred.resolve):($timeout(deferred.reject),$state.go("auth.login",{gotoAfterLogin:gotoAfter}))}),deferred.promise};return{checkAnonymousSessionAccess:checkAnonymousSessionAccess,checkLoggedin:checkLoggedin,checkLoggedOut:function(){var deferred=$q.defer();return $http.get("/loggedin").success(function(user){"0"!==user?($timeout(deferred.reject),$location.url("/login")):$timeout(deferred.resolve)}),deferred.promise},checkIsUser:function(username,gotoAfter){var deferred=$q.defer();return $http.get("/loggedin").success(function(user){"0"!==user?user.username===username||user.roles.indexOf("super")>=0?$timeout(deferred.resolve):$state.go("error.unauthorized"):($timeout(deferred.reject),$state.go("auth.login",{gotoAfterLogin:gotoAfter}))}),deferred.promise}}}])}();
!function(){"use strict";angular.module("mean.articles").controller("ListChallengesController",["$rootScope","$scope","$state","query","challenges","MetaTagService","$mixpanel",function($rootScope,$scope,$state,query,challenges,MetaTagService,$mixpanel){$rootScope.$emit("showListHeader"),$scope.challenges=challenges,$scope.query=query.q||"",$scope.search=function(){$scope.query.length>0&&$state.go("challenges.search",{query:btoa(JSON.stringify({q:$scope.query}))})},MetaTagService.setMetaTags({title:"Open challenges - NR8",description:"Narrative challenge",author:"",keywords:""}).setTitle("Open challenges - NR8"),$mixpanel.track("ChallengeList",{})}])}();
!function(){"use strict";angular.module("mean.articles").controller("ViewChallengeController",["$rootScope","$scope","$http","challenge","narratives","$modal","featuredEntries","Facebook","Global","MetaTagService","siteConfig","$mixpanel","PLAYER_CONFIG",function($rootScope,$scope,$http,challenge,narratives,$modal,featuredEntries,Facebook,Global,MetaTagService,siteConfig,$mixpanel,PLAYER_CONFIG){$rootScope.$emit("showChallengeHeader"),$scope.global=Global,$scope.isMobile=!isMobile.any,$scope.narratives=narratives,$scope.challenge=challenge,$scope.articles=featuredEntries,$scope.socialShareUrl="https://www.nr8.com/page/"+$scope.challenge.key,$scope.uiThemes=siteConfig.uiThemes,PLAYER_CONFIG.setPlayerConfig(),$scope.playingSupported=PLAYER_CONFIG.isPlayingSupported(),$scope.playingSupported?$scope.watchintrolink="https://www.nr8.com/narratives/581a93d35be6080c004dc00e":$scope.watchintrolink="https://www.youtube.com/watch?v=l6JOj771oNo","template"===$scope.challenge.additionalInfo&&($scope.links=JSON.parse($scope.challenge.additionalInfoLeftBody)),MetaTagService.setMetaTags({"og:site_name":"Reach your audience","og:url":$scope.socialShareUrl,"og:image":challenge.socialMediaImage,"og:title":challenge.socialMediaTitle,"og:description":challenge.socialMediaDescription,"article:author":challenge.sponsor,"og:type":"article","article:publisher":"https://www.facebook.com/Nr8inc","twitter:card":"summary_large_image","twitter:site":"@nr8inc","twitter:image":challenge.socialMediaImage,"twitter:title":challenge.socialMediaTitle,"twitter:description":challenge.socialMediaDescription,"twitter:creator":challenge.sponsor,title:challenge.title+" | Narrative topic - NR8",description:challenge.description,author:challenge.sponsor,keywords:challenge.title}).setTitle(challenge.title+" | Narrative topic - NR8"),$mixpanel.track("Challenge",{challenge_key:$scope.challenge.key,sponsor:challenge.sponsor}),$scope.shareChallengeOnReddit=function(){$mixpanel.track("ChallengeShare",{share_on:"Reddit",challenge_key:$scope.challenge.key}),function(pageURL,title,w,h){var left=screen.width/2-w/2,top=screen.height/2-h/2;window.open(pageURL,title,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+w+", height="+h+", top="+top+", left="+left)}("http://www.reddit.com/submit?url="+encodeURIComponent($scope.socialShareUrl)+"&title="+encodeURIComponent($scope.challenge.title),"redditWindowChallenge",900,700)},$scope.shareChallengeOnFacebook=function(){Facebook.ui({method:"share",href:$scope.socialShareUrl},function(response){response&&angular.isDefined(response.error_code)&&console.log("error sharing on facebook")}),$mixpanel.track("ChallengeShare",{share_on:"Facebook",challenge_key:$scope.challenge.key})},$scope.shareChallengeOnTwitter=function(){$mixpanel.track("ChallengeShare",{share_on:"Twitter",challenge_key:$scope.challenge.key})},$scope.participate=function(){$rootScope.$emit("create-nr8",{challenges:[challenge._id]})},$scope.showSupportMessage=function(article){$modal.open({templateUrl:"system/views/modal-support-message.html",controller:function($scope,$modalInstance){$scope.ok=function(){$modalInstance.close()}},size:"md",backdrop:"static",resolve:{}})},$scope.follow=function(){$http.post("/api/follow/"+challenge._id).then(function(response){response.data&&response.data.success&&($scope.challenge.isFollowing=!0,$scope.challenge.followers++)})},$scope.unfollow=function(){$http.delete("/api/follow/"+challenge._id).then(function(response){response.data&&response.data.success&&($scope.challenge.isFollowing=!1,$scope.challenge.followers--)})}}])}();